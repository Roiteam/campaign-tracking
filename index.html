<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Campaign</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js per grafici -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- SheetJS per export Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #1e293b 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        h1 {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .subtitle { color: #9ca3af; margin-bottom: 30px; font-size: 1.1rem; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        .btn-primary { background: linear-gradient(to right, #3b82f6, #8b5cf6); color: white; padding: 12px 24px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 16px; transition: transform 0.2s; }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-size: 16px; transition: all 0.3s; }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.2); }
        .btn-success { background: #22c55e; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn-group { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
        .tabs { display: flex; gap: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 4px; margin-bottom: 30px; overflow-x: auto; }
        .tab-btn { padding: 10px 20px; border-radius: 6px; border: none; background: transparent; color: #9ca3af; cursor: pointer; font-size: 14px; white-space: nowrap; transition: all 0.3s; }
        .tab-btn:hover { color: white; }
        .tab-btn.active { background: #3b82f6; color: white; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 30px; }
        .stat-card { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 20px; }
        .stat-label { color: #9ca3af; font-size: 0.875rem; margin-bottom: 8px; }
        .stat-value { font-size: 2rem; font-weight: bold; color: white; }
        .stat-change { font-size: 0.875rem; margin-top: 8px; }
        .stat-change.positive { color: #22c55e; }
        .stat-change.negative { color: #ef4444; }
        .card { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 24px; margin-bottom: 20px; }
        .card-title { font-size: 1.25rem; font-weight: bold; margin-bottom: 20px; color: white; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
        .filters { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        input, select { background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; padding: 10px 12px; color: white; font-size: 14px; }
        input::placeholder { color: #9ca3af; }
        select option { background: #334155; }
        input:focus, select:focus { outline: none; border-color: #3b82f6; }
        .form-grid { display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-label { color: #9ca3af; font-size: 0.875rem; font-weight: 600; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: #9ca3af; font-size: 0.875rem; font-weight: 600; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        td { padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .platform-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .platform-meta { background: rgba(24, 119, 242, 0.2); color: #60a5fa; border: 1px solid rgba(24, 119, 242, 0.3); }
        .platform-google { background: rgba(234, 67, 53, 0.2); color: #f87171; border: 1px solid rgba(234, 67, 53, 0.3); }
        .platform-tiktok { background: rgba(255, 0, 80, 0.2); color: #fb7185; border: 1px solid rgba(255, 0, 80, 0.3); }
        .sync-status { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: rgba(34, 197, 94, 0.2); border: 1px solid #22c55e; border-radius: 8px; font-size: 0.875rem; }
        .sync-status.syncing { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .loading { text-align: center; padding: 40px; color: #9ca3af; }
        .empty-state { text-align: center; padding: 60px 20px; color: #9ca3af; }
        .empty-state-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }

        /* Toggle Switch Styles */
        .switch { position: relative; display: inline-block; width: 52px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.2); transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(24px); }

        @media (max-width: 768px) {
            h1 { font-size: 1.75rem; }
            .header-top { flex-direction: column; align-items: stretch; }
            .stats-grid { grid-template-columns: 1fr; }
            table { font-size: 0.875rem; }
            th, td { padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="app">
            <div class="loading">‚è≥ Caricamento...</div>
        </div>
    </div>

    <script>
        var SUPABASE_URL = 'https://smwtkyvnmyetlektphyy.supabase.co';
        var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNtd3RreXZubXlldGxla3RwaHl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzk1MzEsImV4cCI6MjA3NTYxNTUzMX0.9YhnYyA7n9qXMgIOvh64Z9-ylYADrW7x2SysbAGvVp0';
        var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const TRAFFIC_MANAGER = {
            userId: '0191746f-b3fa-75e1-b9c6-332a83264565',
            apiKey: 'ITDdd730d7a3144af3608b908fa41b657b9e2a18709',
            baseUrl: 'https://dashboard.italiadrop.com/api/v1'
        };

        // User ID Telegram condiviso (stesso di telegram-monitor.html)
        // Il backend Railway cerca le credenziali Telegram per questo user_id
        const TELEGRAM_USER_ID = '755e280e-c2c3-4158-862a-79f313cd145e';

        var state = {
            currentTab: 'dashboard',
            currentUser: null,
            loading: true,
            syncing: false,
            lastSync: null,
            dateFrom: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            dateTo: new Date().toISOString().split('T')[0],
            socialCredentials: {
                meta: [],
                google: [],
                tiktok: []
            },
            selectedAccounts: {
                meta: [],
                google: [],
                tiktok: []
            },
            showAddMetaForm: false,
            showAddGoogleForm: false,
            showAddTikTokForm: false,
            newAccount: {
                meta: { name: '', accessToken: '', accountId: '' },
                google: { name: '', clientId: '', clientSecret: '', refreshToken: '', customerId: '' },
                tiktok: { name: '', accessToken: '', advertiserId: '' }
            },
            trafficData: null,
            campaignsData: [],
            adsData: [], // Dati creativit√†/inserzioni da Meta Ads
            matchedData: [],
            offersReference: {}, // Mappa offer_id -> dati offerta (payout, etc)
            offersGoals: {}, // Mappa offer_id -> CPA goal personalizzato
            stats: {
                totalSpend: 0,
                totalConversions: 0,
                totalRevenue: 0,
                profit: 0,
                roi: 0,
                roas: 0
            },
            campaignFilters: {
                status: 'all', // 'all', 'active', 'inactive'
                dateFrom: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                dateTo: new Date().toISOString().split('T')[0]
            },
            // Dati storici per trends
            trendsData: {
                comparison: null, // Dati del periodo di confronto custom
                loaded: false
            },
            // Filtri trends
            trendsFilters: {
                campaignId: 'all', // 'all' o nome campagna specifica
                comparisonDateFrom: null,
                comparisonDateTo: null
            },
            // Trend automatici
            historicalSnapshots: {}, // Snapshot storici (1g, 3g, 7g, 15g, 30g)
            campaignTrends: [], // Dati trend calcolati per ogni campagna
            trendsLoading: false, // Loading snapshot storici
            trendsAutoFilters: {
                searchQuery: '',
                sortBy: 'roi_asc' // roi_asc, roi_desc
            },
            // Storico sincronizzazioni
            historyData: [],
            // Alert e trend detection
            alerts: {
                roiNegativo: [], // Campagne con ROI < 0
                roiPositivo: [], // Campagne con ROI >= 0
                trendCalo: [],   // Campagne con trend in calo
                trendAumento: [], // Campagne con trend in aumento
                tutteCampagne: [] // Tutte le campagne con dati calcolati
            },
            previousPeriodData: null, // Dati del periodo precedente per confronto
            alertSearchFilter: '', // Filtro ricerca campagne in tab Alert
            // Fogli Sheet salvati (Spreadsheet)
            sheets: [], // Array dei fogli salvati
            sharedSheets: [], // Fogli condivisi con me
            currentSheet: null, // Foglio attualmente visualizzato/modificato
            showNewSheetModal: false, // Mostra modal creazione foglio
            showAddColumnModal: false, // Mostra modal aggiungi colonna
            showEditColumnModal: false, // Mostra modal modifica colonna
            showShareModal: false, // Mostra modal condivisione foglio
            showShareTrackerModal: false, // Mostra modal condivisione modulo
            sharingSheet: null, // Foglio in condivisione
            availableUsers: [], // Lista utenti disponibili
            selectedUser: null, // Utente selezionato per condivisione
            sharePermission: 'view', // Permesso di condivisione (view/edit)
            sheetShares: {}, // Mappa sheet_id -> array di condivisioni
            trackerShares: [], // Condivisioni modulo (chi pu√≤ vedere i miei dati)
            sharedTrackers: [], // Tracker condivisi con me (dati di altri)
            viewingTrackerId: null, // ID utente di cui sto visualizzando i dati (null = i miei)
            editingColumn: null, // Colonna in modifica
            showAddRowModal: false, // Mostra modal aggiungi riga
            editingCell: null, // Cella in modifica { sheetId, rowId, columnId }
            newColumn: { // Dati nuova colonna
                name: '',
                type: 'text', // text, number, date, select
                width: 150
            },
            // Creative preview modal
            currentCreativePreview: null, // Ad corrente per modale anteprima
            filteredAdsForPreview: [] // Array Ads filtrate per accesso rapido nella modale
        };

        var syncInterval = null;
        var alertSearchTimeout = null; // Timeout per debounce ricerca alert
        //PART 2
        // ========== INIT ==========
        async function init() {
            try {
                // Prova a ottenere l'utente, ma continua anche senza
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    state.currentUser = user;
                } else {
                    // Modalit√† demo senza autenticazione
                    state.currentUser = { id: 'demo-user', email: 'demo@example.com' };
                    console.log('‚ö†Ô∏è Modalit√† demo - nessun utente autenticato');
                }

                await loadSocialCredentials();
                await loadOffersGoals();
                await loadSheets(); // Carica i fogli salvati
                await loadTrackerShares(); // Carica le condivisioni modulo
                await loadSharedTrackers(); // Carica tracker condivisi con me
                await loadData();

                // Auto-seleziona tracker condiviso se non ho miei dati
                await autoSelectSharedTracker();

                state.loading = false;
                render();
                
                startAutoSync();
                
            } catch (error) {
                console.error('Init error:', error);
                alert('Errore di connessione');
            }
        }

        // ========== TRAFFIC MANAGER API ==========
        async function fetchTrafficManagerData(customDateFrom, customDateTo) {
            try {
                const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNtd3RreXZubXlldGxla3RwaHl5Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDAzOTUzMSwiZXhwIjoyMDc1NjE1NTMxfQ.KHMBC9fS0CZFMsieg0BuigOqjTAUxG89zV1Cc6tP5JM';

                // Usa date custom se fornite, altrimenti usa quelle dello state
                var dateFrom = customDateFrom || state.dateFrom;
                var dateTo = customDateTo || state.dateTo;

                const response = await fetch('https://smwtkyvnmyetlektphyy.supabase.co/functions/v1/smooth-task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + SERVICE_ROLE_KEY,
                        'apikey': SERVICE_ROLE_KEY
                    },
                    body: JSON.stringify({
                        dateFrom: dateFrom,
                        dateTo: dateTo
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error('Function error: ' + response.status + ' - ' + errorText);
                }

                const data = await response.json();
                console.log('‚úÖ Traffic Manager data received');

                // DEBUG: Log sample offers to verify revenue data
                if (data && data.data && data.data.length > 0) {
                    console.log('üì¶ Sample offers from Traffic Manager (' + data.data.length + ' totali):');

                    // Log COMPLETO della prima offerta per vedere la struttura
                    console.log('üîç STRUTTURA COMPLETA prima offerta:');
                    console.log(JSON.stringify(data.data[0], null, 2));

                    // Log summary delle prime 3 offerte
                    data.data.slice(0, 3).forEach(function(offer) {
                        console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                        console.log('  üìã Offer', offer.offer_id, '-', offer.offer_name);
                        console.log('  ‚îú‚îÄ Conversions object:', offer.conversions ? 'EXISTS' : 'MISSING');

                        if (offer.conversions) {
                            console.log('  ‚îú‚îÄ Approved:', offer.conversions.approved);
                            console.log('  ‚îú‚îÄ Pending:', offer.conversions.pending);
                            console.log('  ‚îú‚îÄ Cancelled:', offer.conversions.cancelled);
                        }

                        console.log('  ‚îú‚îÄ Double:', offer.double);
                        console.log('  ‚îî‚îÄ Trash:', offer.trash);
                    });
                    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                }

                return data;
                
            } catch (error) {
                console.error('Error:', error);
                alert('Errore Traffic Manager: ' + error.message);
                return null;
            }
        }

        // ========== TRAFFIC MANAGER OFFERS API (per payout di riferimento) ==========
        async function fetchTrafficManagerOffers() {
            try {
                console.log('üîç Fetching offers reference data from Traffic Manager...');

                const url = TRAFFIC_MANAGER.baseUrl + '/offers';

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Id': TRAFFIC_MANAGER.userId,
                        'X-Api-Key': TRAFFIC_MANAGER.apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }

                const data = await response.json();

                console.log('‚úÖ Offers reference data received:', data);

                // Mappa offer_id -> dati offerta per accesso veloce
                var offersMap = {};
                if (data && data.data) {
                    data.data.forEach(function(offer) {
                        offersMap[offer.offer_id.toString()] = {
                            id: offer.offer_id,
                            name: offer.offer_name,
                            payout: parseFloat(offer.payout) || 0,
                            status: offer.status,
                            // Aggiungi altri campi utili se presenti
                            currency: offer.currency || 'EUR'
                        };
                    });
                }

                console.log('üìä Mapped', Object.keys(offersMap).length, 'offers');

                return offersMap;

            } catch (error) {
                console.error('‚ùå Error fetching offers reference:', error);
                // Non bloccare l'app se questa chiamata fallisce
                return {};
            }
        }

        // ========== OFFER GOALS (CPA Goal Personalizzati) ==========
        async function loadOffersGoals() {
            try {
                console.log('üéØ Loading offer goals...');

                // Determina quale user_id usare (mio o di un tracker condiviso)
                var targetUserId = state.viewingTrackerId || state.currentUser.id;

                const { data, error } = await supabase
                    .from('offer_goals')
                    .select('offer_id, cpa_goal')
                    .eq('user_id', targetUserId);

                if (error) throw error;

                // Mappa offer_id -> cpa_goal per accesso rapido
                state.offersGoals = {};
                if (data) {
                    data.forEach(function(goal) {
                        state.offersGoals[goal.offer_id] = parseFloat(goal.cpa_goal) || 0;
                    });
                }

                console.log('‚úÖ Loaded', Object.keys(state.offersGoals).length, 'custom goals');

            } catch (error) {
                console.error('‚ùå Error loading offer goals:', error);
                // Non bloccare l'app se questa chiamata fallisce
                state.offersGoals = {};
            }
        }

        async function saveOfferGoal(offerId, cpaGoal) {
            try {
                console.log('üíæ Saving goal for offer', offerId, ':', cpaGoal);

                const goalValue = parseFloat(cpaGoal);
                if (isNaN(goalValue) || goalValue < 0) {
                    throw new Error('Valore non valido');
                }

                // Usa upsert per inserire o aggiornare
                const { error } = await supabase
                    .from('offer_goals')
                    .upsert({
                        user_id: state.currentUser.id,
                        offer_id: offerId,
                        cpa_goal: goalValue,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id,offer_id'
                    });

                if (error) throw error;

                // Aggiorna lo state locale
                state.offersGoals[offerId] = goalValue;

                console.log('‚úÖ Goal saved successfully');
                return true;

            } catch (error) {
                console.error('‚ùå Error saving offer goal:', error);
                alert('Errore nel salvataggio: ' + error.message);
                return false;
            }
        }

        // ========== META ADS API ==========
        async function fetchMetaAdsData(customDateFrom, customDateTo) {
            var allCampaigns = [];
            const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNtd3RreXZubXlldGxla3RwaHl5Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDAzOTUzMSwiZXhwIjoyMDc1NjE1NTMxfQ.KHMBC9fS0CZFMsieg0BuigOqjTAUxG89zV1Cc6tP5JM';

            // Usa date custom se fornite, altrimenti usa quelle dello state
            var dateFrom = customDateFrom || state.dateFrom;
            var dateTo = customDateTo || state.dateTo;

            console.log('üîç Selected Meta accounts:', state.selectedAccounts.meta.length);

            if (state.selectedAccounts.meta.length === 0) {
                console.warn('‚ö†Ô∏è Nessun account Meta selezionato! Vai in Impostazioni API e seleziona gli account.');
                return allCampaigns;
            }

            for (var i = 0; i < state.selectedAccounts.meta.length; i++) {
                var accountId = state.selectedAccounts.meta[i];
                var account = state.socialCredentials.meta.find(function(a) { return a.id === accountId; });

                if (!account) {
                    console.warn('Account non trovato:', accountId);
                    continue;
                }

                try {
                    // Use numeric account ID from platform_data if available, otherwise use accountId as-is
                    var numericAccountId = account.account_id || account.accountId;

                    // If account_id is in format "act_123456789", extract just the number
                    if (typeof numericAccountId === 'string' && numericAccountId.startsWith('act_')) {
                        numericAccountId = numericAccountId.replace('act_', '');
                    }

                    console.log('üìä Fetching Meta Ads for:', account.name, '| Account ID:', numericAccountId);

                    const requestBody = {
                        accountId: 'act_' + numericAccountId, // Meta API expects "act_" prefix
                        accessToken: account.accessToken,
                        dateFrom: dateFrom,
                        dateTo: dateTo,
                        includeStatus: true // Richiedi anche lo stato della campagna
                    };

                    console.log('üì§ Request body:', {
                        accountId: requestBody.accountId,
                        accessToken: '****' + account.accessToken.slice(-8),
                        dateFrom: requestBody.dateFrom,
                        dateTo: requestBody.dateTo
                    });

                    var response = await fetch('https://smwtkyvnmyetlektphyy.supabase.co/functions/v1/meta-ads-proxy', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + SERVICE_ROLE_KEY,
                            'apikey': SERVICE_ROLE_KEY
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        var errorText = await response.text();
                        console.error('‚ùå Meta Ads API error for ' + account.name + ':', response.status, errorText);
                        continue;
                    }

                    var data = await response.json();

                    if (data.data) {
                        console.log('‚úÖ Meta response for ' + account.name + ':', data.data.length, 'campagne ricevute');

                        // Calcola spesa totale per questo account (per debug)
                        var accountSpend = 0;
                        data.data.forEach(function(campaign) {
                            if (campaign.insights && campaign.insights.data && campaign.insights.data.length > 0) {
                                var insights = campaign.insights.data[0];

                                var purchases = 0;
                                if (insights.actions) {
                                    var purchaseAction = insights.actions.find(function(a) {
                                        return a.action_type === 'purchase' || a.action_type === 'offsite_conversion.fb_pixel_purchase';
                                    });
                                    if (purchaseAction) purchases = parseInt(purchaseAction.value) || 0;
                                }

                                var spend = parseFloat(insights.spend) || 0;
                                var impressions = parseInt(insights.impressions) || 0;
                                var clicks = parseInt(insights.clicks) || 0;
                                var cpm = impressions > 0 ? (spend / impressions) * 1000 : 0;
                                var ctr = impressions > 0 ? (clicks / impressions) * 100 : 0;
                                var costPerPurchase = purchases > 0 ? spend / purchases : 0;

                                // Accumula spesa per questo account
                                accountSpend += spend;

                                // Ottieni lo stato reale da Facebook (effective_status o status)
                                var campaignStatus = campaign.effective_status || campaign.status || 'UNKNOWN';
                                var statusLabel = campaignStatus;

                                // Normalizza lo status per il filtro
                                var isActive = campaignStatus === 'ACTIVE';

                                console.log('üìå Campaign:', campaign.name, '- Status:', campaignStatus);

                                allCampaigns.push({
                                    platform: 'meta',
                                    accountName: account.name,
                                    name: campaign.name,
                                    spend: spend,
                                    impressions: impressions,
                                    clicks: clicks,
                                    purchases: purchases,
                                    costPerPurchase: costPerPurchase,
                                    cpm: cpm,
                                    ctr: ctr,
                                    cpa: costPerPurchase, // Alias per retrocompatibilit√†
                                    status: campaignStatus, // Status reale da Facebook
                                    statusLabel: statusLabel,
                                    isActive: isActive
                                });
                            }
                        });

                        console.log('üí∞ Spesa totale per ' + account.name + ': ‚Ç¨' + accountSpend.toFixed(2));
                    }
                } catch (error) {
                    console.error('Meta Ads error:', error);
                }
            }

            // Calcola spesa totale finale
            var totalSpend = allCampaigns.reduce(function(sum, c) { return sum + (c.spend || 0); }, 0);
            console.log('üìä TOTALE - Campagne caricate:', allCampaigns.length, '| Spesa totale: ‚Ç¨' + totalSpend.toFixed(2));

            return allCampaigns;
        }

        // ========== FETCH META ADS CREATIVE/INSERZIONI ==========
        async function fetchMetaAdsCreative(customDateFrom, customDateTo) {
            var allAds = [];
            const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNtd3RreXZubXlldGxla3RwaHl5Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDAzOTUzMSwiZXhwIjoyMDc1NjE1NTMxfQ.KHMBC9fS0CZFMsieg0BuigOqjTAUxG89zV1Cc6tP5JM';

            // Usa date custom se fornite, altrimenti usa quelle dello state
            var dateFrom = customDateFrom || state.dateFrom;
            var dateTo = customDateTo || state.dateTo;

            console.log('üé® Fetching Meta Ads Creative...');
            console.log('üîç Selected Meta accounts:', state.selectedAccounts.meta.length);

            if (state.selectedAccounts.meta.length === 0) {
                console.warn('‚ö†Ô∏è Nessun account Meta selezionato!');
                return allAds;
            }

            for (var i = 0; i < state.selectedAccounts.meta.length; i++) {
                var accountId = state.selectedAccounts.meta[i];
                var account = state.socialCredentials.meta.find(function(a) { return a.id === accountId; });

                if (!account) {
                    console.warn('Account non trovato:', accountId);
                    continue;
                }

                try {
                    var numericAccountId = account.account_id || account.accountId;

                    if (typeof numericAccountId === 'string' && numericAccountId.startsWith('act_')) {
                        numericAccountId = numericAccountId.replace('act_', '');
                    }

                    console.log('üé® Fetching Ads Creative for:', account.name, '| Account ID:', numericAccountId);

                    const requestBody = {
                        accountId: 'act_' + numericAccountId,
                        accessToken: account.accessToken,
                        dateFrom: dateFrom,
                        dateTo: dateTo
                    };

                    var response = await fetch('https://smwtkyvnmyetlektphyy.supabase.co/functions/v1/meta-ads-creative', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + SERVICE_ROLE_KEY,
                            'apikey': SERVICE_ROLE_KEY
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        var errorText = await response.text();
                        console.error('‚ùå Meta Ads Creative API error for ' + account.name + ':', response.status, errorText);
                        continue;
                    }

                    var data = await response.json();

                    if (data.success && data.data) {
                        console.log('‚úÖ Creative response for ' + account.name + ':', data.data.length, 'ads ricevute');

                        // Aggiungi account name a ogni Ad
                        data.data.forEach(function(ad) {
                            ad.accountName = account.name;
                            allAds.push(ad);
                        });
                    } else {
                        console.warn('‚ö†Ô∏è Nessuna Ad ricevuta per ' + account.name);
                    }

                } catch (error) {
                    console.error('Meta Ads Creative error for ' + account.name + ':', error);
                }
            }

            console.log('üé® TOTALE - Ads caricate:', allAds.length);
            return allAds;
        }

        // ========== MATCH CAMPAIGNS WITH OFFERS ==========
        function matchCampaignsWithOffers(trafficOffers, campaigns) {
            var matched = [];
            
            if (!trafficOffers || !trafficOffers.data) return matched;
            
            trafficOffers.data.forEach(function(offer) {
                var offerId = offer.offer_id.toString();

                var relatedCampaigns = campaigns.filter(function(c) {
                    return c.name.startsWith(offerId + '-');
                });

                var totalSpend = 0;
                var totalPurchases = 0;
                var platformBreakdown = { meta: 0, google: 0, tiktok: 0 };

                relatedCampaigns.forEach(function(c) {
                    totalSpend += c.spend;
                    totalPurchases += c.purchases;
                    platformBreakdown[c.platform] += c.spend;
                });

                // PARSING APPROVED (da conversions.approved.total)
                var approved = 0;
                if (offer.conversions && offer.conversions.approved && offer.conversions.approved.total) {
                    approved = parseInt(offer.conversions.approved.total) || 0;
                }

                // PARSING PENDING (da conversions.pending.total)
                var pending = 0;
                if (offer.conversions && offer.conversions.pending && offer.conversions.pending.total) {
                    pending = parseInt(offer.conversions.pending.total) || 0;
                }

                // PARSING CANCELLED (da conversions.canceled - √® una stringa, non ha .total)
                var cancelled = 0;
                if (offer.conversions && offer.conversions.canceled) {
                    cancelled = parseInt(offer.conversions.canceled) || 0;
                }

                // PARSING DOUBLE & TRASH (da leads.double e leads.trash)
                var doubleLead = 0;
                var trash = 0;
                if (offer.leads) {
                    doubleLead = parseInt(offer.leads.double) || 0;
                    trash = parseInt(offer.leads.trash) || 0;
                }

                // PARSING REVENUE (da leads.confirmed.payout - NON da conversions.approved.payout!)
                var revenue = 0;
                if (offer.leads && offer.leads.confirmed && offer.leads.confirmed.payout) {
                    var payoutStr = offer.leads.confirmed.payout.toString();
                    revenue = parseFloat(payoutStr.replace(/[^0-9.-]/g, '')) || 0;
                }

                // DEBUG per offerte specifiche
                if (offerId === '2476' || offerId === '1949' || relatedCampaigns.length > 0) {
                    console.log('üîé PARSING Offer ' + offerId + ' (' + offer.offer_name + '):');
                    console.log('   ‚îú‚îÄ Approved extracted:', approved, '(path: conversions.approved.total)');
                    console.log('   ‚îú‚îÄ Pending extracted:', pending, '(path: conversions.pending.total)');
                    console.log('   ‚îú‚îÄ Cancelled extracted:', cancelled, '(path: conversions.canceled)');
                    console.log('   ‚îú‚îÄ Double extracted:', doubleLead, '(path: leads.double)');
                    console.log('   ‚îú‚îÄ Trash extracted:', trash, '(path: leads.trash)');
                    console.log('   ‚îú‚îÄ Revenue extracted:', revenue, '(path: leads.confirmed.payout)');
                    console.log('   ‚îî‚îÄ Related campaigns:', relatedCampaigns.length);
                }

                // DEBUG: Log revenue calculation
                if (offerId === '2476' || offerId === '1949') {
                    console.log('üìä Offer ' + offerId + ' (' + offer.offer_name + '):');
                    console.log('   Revenue:', revenue, '‚Ç¨');
                    console.log('   Spesa ADV:', totalSpend, '‚Ç¨');
                    console.log('   Profit:', (revenue - totalSpend), '‚Ç¨');
                }
                
                var profit = revenue - totalSpend;
                var roi = totalSpend > 0 ? ((revenue - totalSpend) / totalSpend * 100) : 0;
                var roas = totalSpend > 0 ? (revenue / totalSpend) : 0;

                matched.push({
                    offerId: offerId,
                    offerName: offer.offer_name,
                    campaigns: relatedCampaigns,
                    totalSpend: totalSpend,
                    totalPurchases: totalPurchases,
                    platformBreakdown: platformBreakdown,
                    approved: approved,
                    pending: pending,
                    cancelled: cancelled,
                    doubleLead: doubleLead,
                    trash: trash,
                    revenue: revenue,
                    profit: profit,
                    roi: roi,
                    roas: roas
                });
            });
            
            return matched;
        }

        // ========== CREDENTIALS ==========
        async function loadSocialCredentials() {
            try {
                console.log('üîÑ Loading social credentials...');

                // Determina quale user_id usare (mio o di un tracker condiviso)
                var targetUserId = state.viewingTrackerId || state.currentUser.id;

                // Leggi da api_accounts invece di social_credentials
                const { data: accounts, error } = await supabase
                    .from('api_accounts')
                    .select('id, platform, account_id, account_name, access_token, platform_data')
                    .eq('user_id', targetUserId)
                    .eq('is_active', true);

                if (error) throw error;

                console.log('üìä Raw accounts from database:', accounts);
                console.log('üìä Accounts with platform_data:', accounts?.map(a => ({
                    id: a.id,
                    name: a.account_name,
                    platform: a.platform,
                    platform_data: a.platform_data
                })));

                // Mappa a struttura compatibile con codice esistente
                state.socialCredentials = {
                    meta: [],
                    google: [],
                    tiktok: []
                };

                if (accounts) {
                    accounts.forEach(account => {
                        const mapped = {
                            id: account.id, // UUID da api_accounts
                            name: account.account_name,
                            accessToken: account.access_token,
                            accountId: account.account_id,
                            account_id: account.platform_data?.account_id || account.account_id, // Numeric ID from platform_data
                            // Aggiungi campi extra da platform_data
                            ...(account.platform_data || {})
                        };

                        // Mappa platform name: facebook->meta
                        if (account.platform === 'facebook') {
                            state.socialCredentials.meta.push(mapped);
                        } else if (account.platform === 'google') {
                            // Google pu√≤ avere clientId, clientSecret, refreshToken in platform_data
                            state.socialCredentials.google.push(mapped);
                        } else if (account.platform === 'tiktok') {
                            // TikTok pu√≤ avere advertiserId in platform_data
                            if (mapped.advertiserId === undefined) {
                                mapped.advertiserId = account.account_id; // Fallback
                            }
                            state.socialCredentials.tiktok.push(mapped);
                        }
                    });
                }

                // Leggi pagine selezionate
                const { data: pages, error: pagesError } = await supabase
                    .from('api_pages')
                    .select('account_id, platform')
                    .eq('is_selected', true)
                    .in('account_id', accounts ? accounts.map(a => a.id) : []);

                if (pagesError) throw pagesError;

                console.log('üìÑ Selected pages from api_pages:', pages);

                // Converti in formato selected_accounts
                state.selectedAccounts = { meta: [], google: [], tiktok: [] };

                // 1. Carica selezioni da api_pages (per pagine/profili)
                if (pages) {
                    pages.forEach(page => {
                        if (page.platform === 'facebook' && !state.selectedAccounts.meta.includes(page.account_id)) {
                            state.selectedAccounts.meta.push(page.account_id);
                        } else if (page.platform === 'google' && !state.selectedAccounts.google.includes(page.account_id)) {
                            state.selectedAccounts.google.push(page.account_id);
                        } else if (page.platform === 'tiktok' && !state.selectedAccounts.tiktok.includes(page.account_id)) {
                            state.selectedAccounts.tiktok.push(page.account_id);
                        }
                    });
                }

                console.log('üìÑ After api_pages - selectedAccounts:', JSON.parse(JSON.stringify(state.selectedAccounts)));

                // 2. Carica selezioni da api_accounts (per ad accounts che non hanno pagine)
                // Questi sono ad accounts salvati direttamente, controllare platform_data.is_selected
                if (accounts) {
                    accounts.forEach(account => {
                        // Se ha is_selected in platform_data, aggiungi all'array
                        if (account.platform_data && account.platform_data.is_selected) {
                            const accountId = account.id;
                            console.log('‚úÖ Account selezionato trovato:', account.account_name, 'ID:', accountId, 'Platform:', account.platform);

                            if (account.platform === 'facebook' && !state.selectedAccounts.meta.includes(accountId)) {
                                state.selectedAccounts.meta.push(accountId);
                            } else if (account.platform === 'google' && !state.selectedAccounts.google.includes(accountId)) {
                                state.selectedAccounts.google.push(accountId);
                            } else if (account.platform === 'tiktok' && !state.selectedAccounts.tiktok.includes(accountId)) {
                                state.selectedAccounts.tiktok.push(accountId);
                            }
                        } else {
                            console.log('‚ùå Account NON selezionato:', account.account_name, 'platform_data:', account.platform_data);
                        }
                    });
                }

                console.log('‚úÖ Loaded credentials from api_accounts:', state.socialCredentials);
                console.log('‚úÖ Selected accounts FINAL:', state.selectedAccounts);
            } catch (error) {
                console.error('‚ùå Error loading credentials:', error);
            }
        }

        async function saveSocialCredentials() {
            try {
                console.log('üíæ Saving selections...', state.selectedAccounts);

                // Ottieni tutti gli account dell'utente
                const { data: accounts, error: accountsError } = await supabase
                    .from('api_accounts')
                    .select('id, platform_data')
                    .eq('user_id', state.currentUser.id);

                if (accountsError) throw accountsError;

                const accountIds = accounts.map(a => a.id);
                const selectedAccountIds = [
                    ...state.selectedAccounts.meta,
                    ...state.selectedAccounts.google,
                    ...state.selectedAccounts.tiktok
                ];

                // 1. Aggiorna is_selected in api_pages (per pagine/profili)
                console.log('üìÑ Updating api_pages...');

                // Deseleziona tutte le pagine
                await supabase
                    .from('api_pages')
                    .update({ is_selected: false })
                    .in('account_id', accountIds);

                // Seleziona solo le pagine degli account selezionati
                if (selectedAccountIds.length > 0) {
                    const { error: updateError } = await supabase
                        .from('api_pages')
                        .update({ is_selected: true })
                        .in('account_id', selectedAccountIds);

                    if (updateError) throw updateError;
                }

                // 2. Aggiorna platform_data.is_selected in api_accounts (per ad accounts)
                console.log('üìä Updating api_accounts platform_data...');

                for (const account of accounts) {
                    const isSelected = selectedAccountIds.includes(account.id);

                    // Aggiorna platform_data con is_selected
                    const updatedPlatformData = {
                        ...(account.platform_data || {}),
                        is_selected: isSelected
                    };

                    console.log('üíæ Updating account:', account.id, 'is_selected:', isSelected, 'platform_data:', updatedPlatformData);

                    const { data: updateData, error: updateError } = await supabase
                        .from('api_accounts')
                        .update({ platform_data: updatedPlatformData })
                        .eq('id', account.id)
                        .select();

                    if (updateError) {
                        console.error('‚ùå Error updating account:', account.id, updateError);
                    } else {
                        console.log('‚úÖ Updated successfully:', updateData);
                    }
                }

                console.log('‚úÖ Selections saved successfully!');
                alert('‚úÖ Selezione account salvata!\n\nApri la console (F12) per vedere i dettagli del salvataggio.');

            } catch (error) {
                console.error('‚ùå Save error:', error);
                alert('‚ùå Errore salvataggio: ' + error.message);
            }
        }

        // ========== META ACCOUNTS ==========
        function addMetaAccount() {
            if (!state.newAccount.meta.name || !state.newAccount.meta.accessToken || !state.newAccount.meta.accountId) {
                alert('Compila tutti i campi!');
                return;
            }
            
            state.socialCredentials.meta.push({
                id: Date.now(),
                name: state.newAccount.meta.name,
                accessToken: state.newAccount.meta.accessToken,
                accountId: state.newAccount.meta.accountId
            });
            
            state.newAccount.meta = { name: '', accessToken: '', accountId: '' };
            state.showAddMetaForm = false;
            render();
        }

        function removeMetaAccount(id) {
            if (!confirm('Eliminare questo account?')) return;
            state.socialCredentials.meta = state.socialCredentials.meta.filter(function(a) { return a.id !== id; });
            state.selectedAccounts.meta = state.selectedAccounts.meta.filter(function(i) { return i !== id; });
            render();
        }

        function toggleMetaAccount(id) {
            var index = state.selectedAccounts.meta.indexOf(id);
            if (index > -1) {
                state.selectedAccounts.meta.splice(index, 1);
            } else {
                state.selectedAccounts.meta.push(id);
            }
            render();
        }

        // ========== GOOGLE ACCOUNTS ==========
        function addGoogleAccount() {
            if (!state.newAccount.google.name || !state.newAccount.google.customerId) {
                alert('Compila Nome e Customer ID!');
                return;
            }
            
            state.socialCredentials.google.push({
                id: Date.now(),
                name: state.newAccount.google.name,
                clientId: state.newAccount.google.clientId,
                clientSecret: state.newAccount.google.clientSecret,
                refreshToken: state.newAccount.google.refreshToken,
                customerId: state.newAccount.google.customerId
            });
            
            state.newAccount.google = { name: '', clientId: '', clientSecret: '', refreshToken: '', customerId: '' };
            state.showAddGoogleForm = false;
            render();
        }

        function removeGoogleAccount(id) {
            if (!confirm('Eliminare questo account?')) return;
            state.socialCredentials.google = state.socialCredentials.google.filter(function(a) { return a.id !== id; });
            state.selectedAccounts.google = state.selectedAccounts.google.filter(function(i) { return i !== id; });
            render();
        }

        function toggleGoogleAccount(id) {
            var index = state.selectedAccounts.google.indexOf(id);
            if (index > -1) {
                state.selectedAccounts.google.splice(index, 1);
            } else {
                state.selectedAccounts.google.push(id);
            }
            render();
        }

        // ========== TIKTOK ACCOUNTS ==========
        function addTikTokAccount() {
            if (!state.newAccount.tiktok.name || !state.newAccount.tiktok.accessToken || !state.newAccount.tiktok.advertiserId) {
                alert('Compila tutti i campi!');
                return;
            }
            
            state.socialCredentials.tiktok.push({
                id: Date.now(),
                name: state.newAccount.tiktok.name,
                accessToken: state.newAccount.tiktok.accessToken,
                advertiserId: state.newAccount.tiktok.advertiserId
            });
            
            state.newAccount.tiktok = { name: '', accessToken: '', advertiserId: '' };
            state.showAddTikTokForm = false;
            render();
        }

        function removeTikTokAccount(id) {
            if (!confirm('Eliminare questo account?')) return;
            state.socialCredentials.tiktok = state.socialCredentials.tiktok.filter(function(a) { return a.id !== id; });
            state.selectedAccounts.tiktok = state.selectedAccounts.tiktok.filter(function(i) { return i !== id; });
            render();
        }

        function toggleTikTokAccount(id) {
            var index = state.selectedAccounts.tiktok.indexOf(id);
            if (index > -1) {
                state.selectedAccounts.tiktok.splice(index, 1);
            } else {
                state.selectedAccounts.tiktok.push(id);
            }
            render();
        }

        // ========== SYNC ==========
        async function syncData() {
            if (state.syncing) return;

            // Check if any accounts are selected
            const totalSelected = state.selectedAccounts.meta.length +
                                state.selectedAccounts.google.length +
                                state.selectedAccounts.tiktok.length;

            if (totalSelected === 0) {
                alert('‚ö†Ô∏è Nessun account selezionato!\n\n' +
                      'Per sincronizzare i dati:\n' +
                      '1. Vai alla tab "Impostazioni API"\n' +
                      '2. Seleziona gli account con le checkbox\n' +
                      '3. Clicca "Salva Tutte le Credenziali"\n' +
                      '4. Torna qui e riprova il sync');
                return;
            }

            state.syncing = true;
            render();

            try {
                console.log('üîÑ Starting sync...');
                console.log('üìä Accounts selezionati - Meta:', state.selectedAccounts.meta.length,
                           'Google:', state.selectedAccounts.google.length,
                           'TikTok:', state.selectedAccounts.tiktok.length);

                var trafficData = await fetchTrafficManagerData();
                var offersReference = await fetchTrafficManagerOffers();
                var metaCampaigns = await fetchMetaAdsData();
                var metaAds = await fetchMetaAdsCreative(); // Recupera dati creativit√†/inserzioni

                console.log('üìà Traffic data:', trafficData ? 'OK' : 'ERROR');
                console.log('üìà Offers reference:', Object.keys(offersReference).length, 'offers');
                console.log('üìà Meta campaigns:', metaCampaigns.length);
                console.log('üé® Meta ads/creative:', metaAds.length);

                // Salva tutte le campagne per il tab Campagne
                state.campaignsData = metaCampaigns;
                state.adsData = metaAds; // Salva i dati delle Ads

                state.matchedData = matchCampaignsWithOffers(trafficData, metaCampaigns);
                console.log('‚úÖ Matched offers:', state.matchedData.length);

                state.trafficData = trafficData;
                state.offersReference = offersReference; // Salva i dati delle offerte di riferimento
                state.lastSync = new Date();
                calculateStats();

                console.log('üí∞ Sync completato - Campagne totali:', metaCampaigns.length);
                console.log('üí∞ Spesa totale:', state.stats.totalSpend);

                // Salva nel database storico
                await saveSyncToHistory();

                // Carica periodo precedente per confronto trend
                await loadPreviousPeriodData();

                // Calcola alert con i dati sincronizzati
                calculateAlerts();

                // Detailed success message
                var message = '‚úÖ Sync completato!\n\n';
                message += 'üìä Statistiche:\n';
                message += '‚Ä¢ Offerte matchate: ' + state.matchedData.length + '\n';
                message += '‚Ä¢ Campagne Meta: ' + metaCampaigns.length + '\n';
                message += '‚Ä¢ Ads/Creative: ' + metaAds.length + '\n';
                message += '‚Ä¢ Spesa totale: ‚Ç¨' + state.stats.totalSpend.toFixed(2) + '\n';
                message += '‚Ä¢ Revenue: ‚Ç¨' + state.stats.totalRevenue.toFixed(2) + '\n';
                message += '‚Ä¢ ROI: ' + state.stats.roi + '%\n';
                message += '\nüí° Apri la console (F12) per dettagli';

                alert(message);

            } catch (error) {
                console.error('‚ùå Sync error:', error);
                alert('‚ùå Errore durante la sincronizzazione\n\n' + error.message + '\n\nApri la console (F12) per dettagli');
            } finally {
                state.syncing = false;
                render();
            }
        }

        // ========== TRENDS DATA ==========
        async function loadTrendsData() {
            if (!state.trendsFilters.comparisonDateFrom || !state.trendsFilters.comparisonDateTo) {
                alert('‚ö†Ô∏è Seleziona un periodo di confronto');
                return;
            }

            console.log('üìä Loading trends data...');
            console.log('üìÖ Periodo corrente:', state.dateFrom, '‚Üí', state.dateTo);
            console.log('üìÖ Periodo confronto:', state.trendsFilters.comparisonDateFrom, '‚Üí', state.trendsFilters.comparisonDateTo);
            console.log('üéØ Filtro campagna:', state.trendsFilters.campaignId);

            try {
                // Carica dati del periodo di confronto
                var trafficData = await fetchTrafficManagerData(state.trendsFilters.comparisonDateFrom, state.trendsFilters.comparisonDateTo);
                var metaCampaigns = await fetchMetaAdsData(state.trendsFilters.comparisonDateFrom, state.trendsFilters.comparisonDateTo);
                var matchedData = matchCampaignsWithOffers(trafficData, metaCampaigns);

                // Calcola stats per il periodo di confronto
                var totalSpend = 0;
                var totalRevenue = 0;

                // Filtra per campagna se selezionata
                if (state.trendsFilters.campaignId !== 'all') {
                    // Filtra solo la campagna selezionata
                    var filteredCampaigns = metaCampaigns.filter(function(c) {
                        return c.name === state.trendsFilters.campaignId;
                    });

                    filteredCampaigns.forEach(function(c) {
                        totalSpend += c.spend || 0;
                    });

                    // Per revenue, cerca l'offerta corrispondente
                    matchedData.forEach(function(offer) {
                        var hasCampaign = offer.campaigns.some(function(c) {
                            return c.name === state.trendsFilters.campaignId;
                        });
                        if (hasCampaign) {
                            totalRevenue += offer.revenue;
                        }
                    });
                } else {
                    // Calcola generale (tutte le campagne)
                    console.log('üìä Calcolo generale - Campagne caricate:', metaCampaigns.length);

                    metaCampaigns.forEach(function(c) {
                        totalSpend += c.spend || 0;
                    });

                    console.log('   Spesa totale calcolata da', metaCampaigns.length, 'campagne:', totalSpend);
                    console.log('   Primi 5 account/campagne:', metaCampaigns.slice(0, 5).map(function(c) {
                        return c.accountName + ' - ' + c.name + ': ‚Ç¨' + (c.spend || 0).toFixed(2);
                    }));

                    matchedData.forEach(function(offer) {
                        totalRevenue += offer.revenue;
                    });
                }

                var profit = totalRevenue - totalSpend;
                var roi = totalSpend > 0 ? ((totalRevenue - totalSpend) / totalSpend * 100) : 0;
                var roas = totalSpend > 0 ? (totalRevenue / totalSpend) : 0;

                console.log('‚úÖ Periodo confronto loaded:');
                console.log('   Spesa:', totalSpend);
                console.log('   Revenue:', totalRevenue);
                console.log('   Profit:', profit);
                console.log('   ROI:', roi.toFixed(2) + '%');

                // Salva i dati
                state.trendsData.comparison = {
                    spend: totalSpend,
                    revenue: totalRevenue,
                    profit: profit,
                    roi: roi,
                    roas: roas,
                    dateFrom: state.trendsFilters.comparisonDateFrom,
                    dateTo: state.trendsFilters.comparisonDateTo
                };
                state.trendsData.loaded = true;

                console.log('‚úÖ Trends data loaded');
                render();

            } catch (error) {
                console.error('‚ùå Error loading trends:', error);
                alert('Errore nel caricamento trends: ' + error.message);
            }
        }

        // Helper per calcolare il trend badge
        function getTrendBadge(currentValue, historicalValue, label) {
            if (!historicalValue || historicalValue === 0) {
                return '<span style="color:#6b7280;font-size:0.75rem;margin-left:8px;">‚ö™ N/A</span>';
            }

            var diff = currentValue - historicalValue;
            var percentChange = (diff / historicalValue) * 100;

            var icon, color, sign;
            if (diff > 0) {
                icon = 'üî∫';
                color = '#22c55e';
                sign = '+';
            } else if (diff < 0) {
                icon = 'üîª';
                color = '#ef4444';
                sign = '';
            } else {
                icon = '‚ûñ';
                color = '#6b7280';
                sign = '';
            }

            return '<span style="color:' + color + ';font-size:0.75rem;margin-left:8px;" title="vs ' + label + '">' +
                   icon + ' ' + sign + percentChange.toFixed(1) + '%</span>';
        }

        // ========== AUTOMATIC TRENDS (1d, 3d, 7d, 15d, 30d) ==========
        async function loadHistoricalSnapshots() {
            try {
                console.log('üìä Caricamento snapshot storici...');

                var targetUserId = state.viewingTrackerId || state.currentUser.id;
                var today = new Date();

                // Calcola le date target (1, 3, 7, 15, 30 giorni fa)
                var periods = [
                    { days: 1, label: '1g' },
                    { days: 3, label: '3g' },
                    { days: 7, label: '7g' },
                    { days: 15, label: '15g' },
                    { days: 30, label: '30g' }
                ];

                var snapshots = {};

                for (var i = 0; i < periods.length; i++) {
                    var period = periods[i];
                    var targetDate = new Date(today);
                    targetDate.setDate(targetDate.getDate() - period.days);

                    // Cerca lo snapshot pi√π vicino a questa data (¬±2 giorni di tolleranza)
                    var startRange = new Date(targetDate);
                    startRange.setDate(startRange.getDate() - 2);
                    var endRange = new Date(targetDate);
                    endRange.setDate(endRange.getDate() + 2);

                    const { data, error } = await supabase
                        .from('sync_history')
                        .select('*')
                        .eq('user_id', targetUserId)
                        .gte('synced_at', startRange.toISOString())
                        .lte('synced_at', endRange.toISOString())
                        .order('synced_at', { ascending: false })
                        .limit(1);

                    if (!error && data && data.length > 0) {
                        snapshots[period.label] = data[0];
                        console.log('‚úÖ Snapshot ' + period.label + ' trovato:', new Date(data[0].synced_at).toLocaleDateString());
                    } else {
                        console.log('‚ö†Ô∏è Nessuno snapshot trovato per ' + period.label);
                        snapshots[period.label] = null;
                    }
                }

                state.historicalSnapshots = snapshots;
                console.log('‚úÖ Snapshot storici caricati:', Object.keys(snapshots).length);

                return snapshots;

            } catch (error) {
                console.error('‚ùå Errore caricamento snapshot storici:', error);
                return {};
            }
        }

        function calculateCampaignTrends() {
            if (!state.campaignsData || state.campaignsData.length === 0) {
                console.log('‚ö†Ô∏è Nessuna campagna da analizzare');
                return [];
            }

            if (!state.historicalSnapshots || Object.keys(state.historicalSnapshots).length === 0) {
                console.log('‚ö†Ô∏è Nessuno snapshot storico disponibile');
                return [];
            }

            // RAGGRUPPA PER OFFERTA (come nella tab Offerte)
            var offersMap = {};

            // Per ogni campagna, raggruppa per offer_id
            state.campaignsData.forEach(function(campaign) {
                var match = campaign.name.match(/^(\d+)-/);
                if (!match) return;

                var offerId = match[1];

                if (!offersMap[offerId]) {
                    offersMap[offerId] = {
                        offerId: offerId,
                        offerName: '',
                        campaigns: [],
                        currentTotalSpend: 0,
                        currentTotalRevenue: 0,
                        currentTotalApproved: 0
                    };
                }

                // Trova revenue dell'offerta
                if (state.matchedData && !offersMap[offerId].offerName) {
                    var matchedOffer = state.matchedData.find(function(o) {
                        return o.offerId === offerId;
                    });
                    if (matchedOffer) {
                        offersMap[offerId].offerName = matchedOffer.offerName || ('Offerta ' + offerId);
                        offersMap[offerId].currentTotalRevenue = matchedOffer.revenue || 0;
                        offersMap[offerId].currentTotalApproved = matchedOffer.approved || 0;
                    }
                }

                var campaignSpend = campaign.spend || 0;
                var status = (campaign.effective_status || campaign.status || 'UNKNOWN').toUpperCase();

                // Calcola trend per questa singola campagna
                var campaignTrends = {};
                ['1g', '3g', '7g', '15g', '30g'].forEach(function(period) {
                    var snapshot = state.historicalSnapshots[period];
                    if (!snapshot || !snapshot.campaigns_snapshot) {
                        campaignTrends[period] = null;
                        return;
                    }

                    var historicalCampaign = snapshot.campaigns_snapshot.find(function(c) {
                        return c.name === campaign.name;
                    });

                    if (!historicalCampaign) {
                        campaignTrends[period] = null;
                        return;
                    }

                    // Revenue storica dell'offerta
                    var historicalRevenue = 0;
                    if (snapshot.offers_snapshot) {
                        var historicalOffer = snapshot.offers_snapshot.find(function(o) {
                            return o.offerId === offerId;
                        });
                        if (historicalOffer) {
                            historicalRevenue = historicalOffer.revenue || 0;
                        }
                    }

                    var historicalSpend = historicalCampaign.spend || 0;
                    var historicalROI = historicalSpend > 0 ? ((historicalRevenue - historicalSpend) / historicalSpend * 100) : 0;

                    var currentCampaignROI = campaignSpend > 0 ? ((offersMap[offerId].currentTotalRevenue - campaignSpend) / campaignSpend * 100) : 0;
                    var roiDiff = currentCampaignROI - historicalROI;

                    campaignTrends[period] = {
                        historicalROI: historicalROI,
                        roiDiff: roiDiff,
                        direction: roiDiff > 0 ? 'up' : (roiDiff < 0 ? 'down' : 'stable')
                    };
                });

                offersMap[offerId].campaigns.push({
                    campaign: campaign,
                    spend: campaignSpend,
                    roi: campaignSpend > 0 ? ((offersMap[offerId].currentTotalRevenue - campaignSpend) / campaignSpend * 100) : 0,
                    trends: campaignTrends,
                    status: status
                });

                offersMap[offerId].currentTotalSpend += campaignSpend;
            });

            // Converti in array e calcola ROI aggregato + trend aggregato per offerta
            var trendsData = [];

            Object.keys(offersMap).forEach(function(offerId) {
                var offer = offersMap[offerId];

                var offerROI = offer.currentTotalSpend > 0
                    ? ((offer.currentTotalRevenue - offer.currentTotalSpend) / offer.currentTotalSpend * 100)
                    : 0;
                var offerProfit = offer.currentTotalRevenue - offer.currentTotalSpend;

                // Calcola trend aggregato dell'offerta
                var offerTrends = {};

                ['1g', '3g', '7g', '15g', '30g'].forEach(function(period) {
                    var snapshot = state.historicalSnapshots[period];
                    if (!snapshot || !snapshot.offers_snapshot) {
                        offerTrends[period] = null;
                        return;
                    }

                    var historicalOffer = snapshot.offers_snapshot.find(function(o) {
                        return o.offerId === offerId;
                    });

                    if (!historicalOffer) {
                        offerTrends[period] = null;
                        return;
                    }

                    // Calcola spend storico totale
                    var historicalTotalSpend = 0;
                    if (snapshot.campaigns_snapshot) {
                        snapshot.campaigns_snapshot.forEach(function(c) {
                            var match = c.name.match(/^(\d+)-/);
                            if (match && match[1] === offerId) {
                                historicalTotalSpend += c.spend || 0;
                            }
                        });
                    }

                    var historicalRevenue = historicalOffer.revenue || 0;
                    var historicalROI = historicalTotalSpend > 0
                        ? ((historicalRevenue - historicalTotalSpend) / historicalTotalSpend * 100)
                        : 0;

                    var roiDiff = offerROI - historicalROI;

                    offerTrends[period] = {
                        historicalROI: historicalROI,
                        roiDiff: roiDiff,
                        direction: roiDiff > 0 ? 'up' : (roiDiff < 0 ? 'down' : 'stable')
                    };
                });

                trendsData.push({
                    offerId: offerId,
                    offerName: offer.offerName,
                    currentROI: offerROI,
                    currentSpend: offer.currentTotalSpend,
                    currentRevenue: offer.currentTotalRevenue,
                    currentProfit: offerProfit,
                    currentApproved: offer.currentTotalApproved,
                    trends: offerTrends,
                    campaigns: offer.campaigns,
                    expanded: false
                });
            });

            // Ordina per ROI (dal pi√π basso al pi√π alto)
            trendsData.sort(function(a, b) {
                return a.currentROI - b.currentROI;
            });

            return trendsData;
        }

        async function loadAndCalculateTrends() {
            try {
                state.trendsLoading = true;
                state.campaignTrends = [];
                render();

                console.log('üîç Inizio analisi trend automatici...');

                // Carica snapshot storici
                await loadHistoricalSnapshots();

                // Calcola trend per ogni campagna
                state.campaignTrends = calculateCampaignTrends();

                console.log('‚úÖ Analisi trend completata:', state.campaignTrends.length, 'offerte');

                state.trendsLoading = false;
                render();

            } catch (error) {
                console.error('‚ùå Errore analisi trend:', error);
                alert('Errore nell\'analisi trend: ' + error.message);
                state.trendsLoading = false;
                render();
            }
        }

        function toggleOfferTrend(offerId) {
            // Trova l'offerta nell'array originale usando offerId
            var offerIndex = state.campaignTrends.findIndex(function(o) {
                return o.offerId === offerId;
            });

            if (offerIndex !== -1) {
                state.campaignTrends[offerIndex].expanded = !state.campaignTrends[offerIndex].expanded;
                render();
            }
        }

        function startAutoSync() {
            if (syncInterval) clearInterval(syncInterval);
            
            syncInterval = setInterval(function() {
                console.log('Auto-sync at', new Date().toLocaleTimeString());
                syncData();
            }, 30 * 60 * 1000);
            
            console.log('Auto-sync started - every 30 min');
        }

        function stopAutoSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        async function loadData() {
            try {
                // Determina quale user_id usare (mio o di un tracker condiviso)
                var targetUserId = state.viewingTrackerId || state.currentUser.id;

                console.log('üîÑ loadData() - Caricamento dati per user_id:', targetUserId);
                console.log('   viewingTrackerId:', state.viewingTrackerId);
                console.log('   currentUser.id:', state.currentUser.id);

                // Carica l'ultima sincronizzazione da sync_history
                const { data: syncData, error } = await supabase
                    .from('sync_history')
                    .select('*')
                    .eq('user_id', targetUserId)
                    .order('synced_at', { ascending: false })
                    .limit(1);

                if (error) {
                    console.warn('‚ö†Ô∏è Errore caricamento sync_history:', error);
                    console.warn('Fallback su traffic_conversions...');

                    // Fallback su traffic_conversions (tabella vecchia)
                    const { data: trafficData } = await supabase
                        .from('traffic_conversions')
                        .select('*')
                        .eq('user_id', targetUserId)
                        .order('synced_at', { ascending: false })
                        .limit(1);

                    if (trafficData && trafficData.length > 0) {
                        console.log('‚úÖ Dati caricati da traffic_conversions');
                        state.trafficData = trafficData[0].data;
                        state.matchedData = trafficData[0].matched_data || [];
                        state.campaignsData = []; // Non disponibile in traffic_conversions
                        state.lastSync = new Date(trafficData[0].synced_at);
                        calculateStats();
                    } else {
                        console.warn('‚ùå Nessun dato trovato in traffic_conversions per user_id:', targetUserId);
                    }
                } else if (syncData && syncData.length > 0) {
                    // Carica da sync_history (nuovo formato)
                    var latestSync = syncData[0];

                    state.matchedData = latestSync.offers_snapshot || [];
                    state.campaignsData = latestSync.campaigns_snapshot || [];
                    state.trafficData = null; // Non pi√π usato
                    state.lastSync = new Date(latestSync.synced_at);

                    console.log('‚úÖ Dati caricati da sync_history:');
                    console.log('   User ID:', latestSync.user_id);
                    console.log('   Synced at:', latestSync.synced_at);
                    console.log('   Campagne:', state.campaignsData.length);
                    console.log('   Offerte matchate:', state.matchedData.length);

                    calculateStats();

                    // Calcola gli alert con i dati caricati
                    calculateAlerts();
                } else {
                    console.warn('‚ùå Nessun dato trovato in sync_history per user_id:', targetUserId);
                    console.warn('   L\'utente potrebbe non aver mai eseguito una sincronizzazione');

                    // Reset dati
                    state.matchedData = [];
                    state.campaignsData = [];
                    state.trafficData = null;
                    state.lastSync = null;
                }

            } catch (error) {
                console.error('‚ùå Load error:', error);
            }
        }

        function calculateStats() {
            if (state.matchedData && state.matchedData.length > 0) {
                // SPESA TOTALE: Usa TUTTE le campagne sincronizzate (non solo matchate)
                var totalSpend = 0;
                if (state.campaignsData && state.campaignsData.length > 0) {
                    state.campaignsData.forEach(function(campaign) {
                        totalSpend += campaign.spend || 0;
                    });
                }

                // REVENUE: Solo da offerte matchate
                var totalApproved = 0;
                var totalRevenue = 0;

                state.matchedData.forEach(function(offer) {
                    totalApproved += offer.approved;
                    totalRevenue += offer.revenue;
                });

                var profit = totalRevenue - totalSpend;
                var roi = totalSpend > 0 ? ((totalRevenue - totalSpend) / totalSpend * 100) : 0;
                var roas = totalSpend > 0 ? (totalRevenue / totalSpend) : 0;

                console.log('üí∞ Stats calcolate:');
                console.log('   Spesa totale (tutte campagne):', totalSpend);
                console.log('   Revenue (offerte matchate):', totalRevenue);
                console.log('   Profit:', profit);

                state.stats = {
                    totalSpend: totalSpend,
                    totalConversions: totalApproved,
                    totalRevenue: totalRevenue,
                    profit: profit,
                    roi: roi.toFixed(2),
                    roas: roas.toFixed(2)
                };
            } else if (state.trafficData && state.trafficData.data) {
                var totalApproved = 0;
                var totalRevenue = 0;

                state.trafficData.data.forEach(function(offer) {
                    if (offer.conversions && offer.conversions.approved && offer.conversions.approved.total) {
                        totalApproved += parseInt(offer.conversions.approved.total) || 0;

                        if (offer.conversions.approved.payout) {
                            var payoutStr = offer.conversions.approved.payout.toString();
                            totalRevenue += parseFloat(payoutStr.replace(/[^0-9.-]/g, '')) || 0;
                        }
                    }
                });

                state.stats = {
                    totalSpend: 0,
                    totalConversions: totalApproved,
                    totalRevenue: totalRevenue,
                    profit: totalRevenue,
                    roi: 0,
                    roas: 0
                };
            } else {
                state.stats = { totalSpend: 0, totalConversions: 0, totalRevenue: 0, profit: 0, roi: 0, roas: 0 };
            }
        }

        // ========== UI UPDATES ==========
        function setTab(tab) {
            state.currentTab = tab;
            render();

            // Carica automaticamente i dati quando si apre la tab history
            if (tab === 'history') {
                loadHistoryData();
            }
        }

        function updateDateFrom(value) {
            state.dateFrom = value;
        }

        function updateDateTo(value) {
            state.dateTo = value;
        }

        function updateAlertSearch(value) {
            // Aggiorna lo state immediatamente
            state.alertSearchFilter = value;

            // Salva la posizione del cursore
            var input = document.getElementById('alertSearchInput');
            var cursorPosition = input ? input.selectionStart : 0;

            // Cancella il timeout precedente
            if (alertSearchTimeout) {
                clearTimeout(alertSearchTimeout);
            }

            // Aspetta 300ms prima di fare il render (debounce)
            alertSearchTimeout = setTimeout(function() {
                render();

                // Ripristina il focus e la posizione del cursore
                setTimeout(function() {
                    var newInput = document.getElementById('alertSearchInput');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPosition, cursorPosition);
                    }
                }, 0);
            }, 300);
        }

        // Aggiorna filtro Alert
        function updateAlertFilter(filterType, value) {
            if (!state.alertFilters) {
                state.alertFilters = {
                    sortBy: 'roi',
                    sortOrder: 'desc',
                    filterStato: 'all',
                    filterCampaignStatus: 'all',
                    searchQuery: ''
                };
            }

            state.alertFilters[filterType] = value;
            render();
        }

        // Reset filtri Alert
        function resetAlertFilters() {
            state.alertFilters = {
                sortBy: 'roi',
                sortOrder: 'desc',
                filterStato: 'all',
                filterCampaignStatus: 'all',
                searchQuery: ''
            };
            render();
        }

        // Aggiorna filtro Offerte
        function updateOffersFilter(filterType, value) {
            if (!state.offersFilters) {
                state.offersFilters = {
                    sortBy: 'roi',
                    sortOrder: 'desc',
                    filterCampaignStatus: 'all'
                };
            }

            state.offersFilters[filterType] = value;
            render();
        }

        // Reset filtri Offerte
        function resetOffersFilters() {
            state.offersFilters = {
                sortBy: 'roi',
                sortOrder: 'desc',
                filterCampaignStatus: 'all'
            };
            render();
        }

        // ========== DEBOUNCED SEARCH FUNCTIONS ==========
        var searchTimeouts = {
            campaigns: null,
            alerts: null,
            offers: null,
            trends: null
        };

        function debouncedCampaignSearch(value) {
            if (searchTimeouts.campaigns) {
                clearTimeout(searchTimeouts.campaigns);
            }
            state.campaignFilters.searchQuery = value;
            searchTimeouts.campaigns = setTimeout(function() {
                render();
            }, 500); // Aspetta 500ms dopo l'ultima digitazione
        }

        function debouncedAlertSearch(value) {
            if (searchTimeouts.alerts) {
                clearTimeout(searchTimeouts.alerts);
            }
            state.alertFilters.searchQuery = value;
            searchTimeouts.alerts = setTimeout(function() {
                render();
            }, 500);
        }

        function debouncedOffersSearch(value) {
            if (searchTimeouts.offers) {
                clearTimeout(searchTimeouts.offers);
            }
            state.offersFilters.searchQuery = value;
            searchTimeouts.offers = setTimeout(function() {
                render();
            }, 500);
        }

        function debouncedTrendsSearch(value) {
            if (searchTimeouts.trends) {
                clearTimeout(searchTimeouts.trends);
            }
            state.trendsAutoFilters.searchQuery = value;
            searchTimeouts.trends = setTimeout(function() {
                render();
            }, 500);
        }

        // ========== TELEGRAM REPORTS FUNCTIONS ==========

        async function loadTelegramChats() {
            try {
                console.log('üì¨ Caricando chat monitorate...');

                // Query messages per ottenere chat uniche
                const { data, error } = await supabase
                    .from('messages')
                    .select('chat_id, chat_name, chat_type')
                    .eq('user_id', state.currentUser.id)
                    .order('message_date', { ascending: false });

                if (error) throw error;

                // Estrai chat uniche (usa Map per evitare duplicati)
                var chatsMap = new Map();
                if (data) {
                    data.forEach(function(msg) {
                        if (!chatsMap.has(msg.chat_id)) {
                            chatsMap.set(msg.chat_id, {
                                chat_id: msg.chat_id,
                                chat_name: msg.chat_name || 'Chat ' + msg.chat_id,
                                chat_type: msg.chat_type
                            });
                        }
                    });
                }

                // Popola select
                var select = document.getElementById('telegramChatSelect');
                if (select) {
                    select.innerHTML = '<option value="">Seleziona una chat...</option>';
                    chatsMap.forEach(function(chat) {
                        var option = document.createElement('option');
                        option.value = chat.chat_id;
                        option.textContent = chat.chat_name + ' (' + chat.chat_type + ')';
                        select.appendChild(option);
                    });

                    console.log('‚úÖ Caricate', chatsMap.size, 'chat');
                }

                // Carica configurazione esistente
                await loadTelegramReportConfig();

            } catch (error) {
                console.error('‚ùå Errore caricamento chat:', error);
                alert('Errore nel caricamento delle chat: ' + error.message);
            }
        }

        async function loadTelegramReportConfig() {
            try {
                const { data, error } = await supabase
                    .from('telegram_report_config')
                    .select('*')
                    .eq('user_id', state.currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') throw error; // PGRST116 = no rows

                if (data) {
                    // Popola UI con configurazione esistente
                    var chatIdInput = document.getElementById('telegramChatId');
                    var chatNameInput = document.getElementById('telegramChatName');
                    var dailyToggle = document.getElementById('dailyReportsToggle');
                    var weeklyToggle = document.getElementById('weeklyReportsToggle');

                    if (chatIdInput) chatIdInput.value = data.chat_id || '';
                    if (chatNameInput) chatNameInput.value = data.chat_name || '';
                    if (dailyToggle) dailyToggle.checked = data.daily_enabled !== false;
                    if (weeklyToggle) weeklyToggle.checked = data.weekly_enabled !== false;

                    console.log('‚úÖ Configurazione caricata:', data);
                }

            } catch (error) {
                console.error('‚ö†Ô∏è Errore caricamento config:', error);
            }
        }

        async function saveTelegramReportConfig() {
            try {
                var chatIdInput = document.getElementById('telegramChatId');
                var chatNameInput = document.getElementById('telegramChatName');
                var dailyToggle = document.getElementById('dailyReportsToggle');
                var weeklyToggle = document.getElementById('weeklyReportsToggle');

                if (!chatIdInput || !chatIdInput.value.trim()) {
                    alert('‚ö†Ô∏è Inserisci il Chat ID prima di salvare');
                    return;
                }

                var chatId = chatIdInput.value.trim();
                var chatName = chatNameInput ? chatNameInput.value.trim() : '';

                // Se nome chat vuoto, usa chat ID come nome
                if (!chatName) {
                    chatName = 'Chat ' + chatId;
                }

                console.log('üíæ Salvando configurazione Telegram...');

                const { error } = await supabase
                    .from('telegram_report_config')
                    .upsert({
                        user_id: state.currentUser.id,
                        chat_id: chatId,
                        chat_name: chatName,
                        daily_enabled: dailyToggle ? dailyToggle.checked : true,
                        weekly_enabled: weeklyToggle ? weeklyToggle.checked : true,
                        enabled: true,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });

                if (error) throw error;

                alert('‚úÖ Configurazione salvata con successo!\n\nI report verranno inviati automaticamente alla chat:\n' + chatName + ' (' + chatId + ')');
                console.log('‚úÖ Config salvata per chat:', chatId);

            } catch (error) {
                console.error('‚ùå Errore salvataggio config:', error);
                alert('Errore nel salvataggio: ' + error.message);
            }
        }

        async function testTelegramReport() {
            try {
                var chatIdInput = document.getElementById('telegramChatId');
                var chatNameInput = document.getElementById('telegramChatName');

                if (!chatIdInput || !chatIdInput.value.trim()) {
                    alert('‚ö†Ô∏è Inserisci il Chat ID prima di inviare il test');
                    return;
                }

                var chatId = chatIdInput.value.trim();
                var chatName = chatNameInput ? chatNameInput.value.trim() : '';

                if (!chatName) {
                    chatName = 'Chat ' + chatId;
                }

                console.log('üß™ Generando report di test...');

                // Calcola alert se non gi√† fatto
                if (!state.alerts.roiNegativo && !state.alerts.trendAumento) {
                    calculateAlerts();
                }

                // Genera messaggio
                var message = formatTelegramReportMessage('test');

                console.log('üì§ Invio report di test a:', chatId);
                console.log('üìù Messaggio:', message.substring(0, 100) + '...');

                // Invia via telegram-bot-proxy
                // IMPORTANTE: usa TELEGRAM_USER_ID (condiviso) non state.currentUser.id
                // Il backend Railway cerca le credenziali per questo user_id
                const { data, error } = await supabase.functions.invoke('telegram-bot-proxy', {
                    body: {
                        endpoint: '/api/send-message',
                        method: 'POST',
                        body: {
                            user_id: TELEGRAM_USER_ID,
                            chat_id: chatId,
                            message: message,
                            chat_name: chatName
                        }
                    }
                });

                console.log('üì° Risposta Edge Function:', data);

                if (error) {
                    console.error('‚ùå Edge Function error:', error);
                    throw new Error(error.message || 'Errore chiamata Edge Function');
                }

                if (!data?.success) {
                    console.error('‚ùå Railway API error:', data);
                    // Estrai errore dettagliato come fa telegram-monitor.html
                    var errorMsg = data?.data?.detail || data?.data?.error || data?.message || 'Errore invio messaggio';
                    throw new Error(errorMsg);
                }

                alert('‚úÖ Report di test inviato con successo!\n\nControlla la chat Telegram: ' + chatName);
                console.log('‚úÖ Test report inviato a chat:', chatId);

            } catch (error) {
                console.error('‚ùå Errore invio test:', error);
                alert('Errore nell\'invio del test: ' + error.message);
            }
        }

        function showChatIdHelp() {
            alert('üí° Come trovare il Chat ID Telegram:\n\n' +
                  '1. Apri Telegram e vai nella chat dove vuoi ricevere i report\n' +
                  '2. Cerca il bot @userinfobot o @getidsbot\n' +
                  '3. Invia un messaggio al bot (anche solo "ciao")\n' +
                  '4. Il bot ti risponder√† con il Chat ID\n' +
                  '   (es. -1001234567890 per gruppi/canali)\n' +
                  '5. Copia il numero e incollalo nel campo "Chat ID"\n\n' +
                  'üìå Note:\n' +
                  '- Chat private: numero positivo\n' +
                  '- Gruppi/canali: numero negativo che inizia con -100');
        }

        function formatTelegramReportMessage(reportType) {
            var msg = '';
            var now = new Date();
            var dateStr = now.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });

            // Header
            if (reportType === 'weekly') {
                msg += 'üìä REPORT SETTIMANALE CAMPAGNE\n';
                msg += 'üìÖ Settimana al ' + dateStr + '\n';
            } else if (reportType === 'test') {
                msg += 'üß™ TEST REPORT CAMPAGNE\n';
                msg += 'üìÖ ' + dateStr + ' ' + now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) + '\n';
            } else {
                msg += 'üîî REPORT CAMPAGNE GIORNALIERO\n';
                msg += 'üìÖ ' + dateStr + ' ' + now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) + '\n';
            }
            msg += '\n';

            // MESSAGGIO BREVE PER TEST
            if (reportType === 'test') {
                var roiNegativo = state.alerts.roiNegativo || [];

                // Filtra solo campagne ATTIVE
                var roiNegativoActive = roiNegativo.filter(function(alert) {
                    var status = (alert.campaign.effective_status || alert.campaign.status || '').toUpperCase();
                    return status === 'ACTIVE';
                });

                // Calcola ROI positivo SOLO per campagne ATTIVE
                var roiPositivoActive = [];
                if (state.campaignsData) {
                    state.campaignsData.forEach(function(campaign) {
                        // Controlla se campagna √® attiva
                        var status = (campaign.effective_status || campaign.status || '').toUpperCase();
                        if (status !== 'ACTIVE') return;

                        var revenue = 0;
                        var approved = 0;
                        var cpaGoal = 0;
                        var cpaReale = 0;
                        var cpaPagata = 0;

                        // Estrai offer_id
                        var match = campaign.name.match(/^(\d+)-/);
                        var offerId = null;
                        if (match) {
                            offerId = match[1];
                            if (state.offersGoals[offerId]) {
                                cpaGoal = state.offersGoals[offerId];
                            } else {
                                var refOffer = state.offersReference[offerId];
                                if (refOffer && refOffer.payout) {
                                    cpaGoal = refOffer.payout;
                                }
                            }

                            if (state.matchedData) {
                                var matchedOffer = state.matchedData.find(function(offer) {
                                    return offer.offerId === offerId;
                                });
                                if (matchedOffer) {
                                    revenue = matchedOffer.revenue || 0;
                                    approved = matchedOffer.approved || 0;
                                }
                            }
                        }

                        if (approved > 0) {
                            cpaReale = campaign.spend / approved;
                            cpaPagata = revenue / approved;
                        }

                        var spend = campaign.spend || 0;
                        var profit = revenue - spend;
                        var roi = spend > 0 ? ((revenue - spend) / spend * 100) : 0;

                        if (roi >= 0) {
                            roiPositivoActive.push({
                                campaign: campaign,
                                revenue: revenue,
                                profit: profit,
                                roi: roi,
                                approved: approved,
                                conversions: campaign.purchases || 0,
                                cpaGoal: cpaGoal,
                                cpaReale: cpaReale,
                                cpaPagata: cpaPagata
                            });
                        }
                    });
                }

                // Ordina ROI positivo dal pi√π alto al pi√π basso
                roiPositivoActive.sort(function(a, b) {
                    return b.roi - a.roi;
                });

                var totalActive = roiNegativoActive.length + roiPositivoActive.length;

                msg += '‚úÖ Test notifica configurato correttamente!\n\n';
                msg += 'üìä SOMMARIO CAMPAGNE ATTIVE\n';
                msg += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
                msg += '‚Ä¢ Totale Attive: ' + totalActive + '\n';
                msg += '‚Ä¢ ‚ùå ROI Negativo: ' + roiNegativoActive.length + '\n';
                msg += '‚Ä¢ ‚úÖ ROI Positivo: ' + roiPositivoActive.length + '\n\n';

                // TOP 10 CAMPAGNE IN PERDITA
                if (roiNegativoActive.length > 0) {
                    msg += '‚ö†Ô∏è TOP 10 CAMPAGNE IN PERDITA:\n';
                    msg += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
                    var top10Negative = roiNegativoActive.slice(0, 10);
                    top10Negative.forEach(function(alert, idx) {
                        var c = alert.campaign;
                        msg += (idx + 1) + '. ' + c.name.substring(0, 25) + (c.name.length > 25 ? '...' : '') + '\n';
                        msg += '   ROI: ' + (alert.roi || 0).toFixed(1) + '% | Profit: ‚Ç¨' + (alert.profit || 0).toFixed(0) + '\n';
                    });
                    if (roiNegativoActive.length > 10) {
                        msg += '... e altre ' + (roiNegativoActive.length - 10) + ' in perdita\n';
                    }
                    msg += '\n';
                }

                // TOP 10 CAMPAGNE ROI POSITIVO
                if (roiPositivoActive.length > 0) {
                    msg += 'üî• TOP 10 CAMPAGNE ROI POSITIVO:\n';
                    msg += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
                    var top10Positive = roiPositivoActive.slice(0, 10);
                    top10Positive.forEach(function(alert, idx) {
                        var c = alert.campaign;
                        msg += (idx + 1) + '. ' + c.name.substring(0, 25) + (c.name.length > 25 ? '...' : '') + '\n';
                        msg += '   ROI: ' + (alert.roi || 0).toFixed(1) + '% | Profit: ‚Ç¨' + (alert.profit || 0).toFixed(0) + '\n';
                    });
                    if (roiPositivoActive.length > 10) {
                        msg += '... e altre ' + (roiPositivoActive.length - 10) + ' in profitto\n';
                    }
                }

                msg += '\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
                msg += '‚úÖ Le notifiche funzionano correttamente!';

                return msg;
            }

            // CAMPAGNE ROI NEGATIVO (per report normali)
            var roiNegativo = state.alerts.roiNegativo || [];
            if (roiNegativo.length > 0) {
                msg += '‚ùå ROI NEGATIVO (' + roiNegativo.length + ')\n';
                msg += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
                roiNegativo.forEach(function(alert) {
                    var c = alert.campaign;
                    msg += 'üìç ' + c.name + '\n';
                    msg += '‚Ä¢ Spesa: ‚Ç¨' + (c.spend || 0).toFixed(2) + '\n';
                    msg += '‚Ä¢ Conv ADV: ' + (alert.conversions || 0) + ' | Approvate: ' + (alert.approved || 0) + '\n';
                    msg += '‚Ä¢ Revenue: ‚Ç¨' + (alert.revenue || 0).toFixed(2) + '\n';
                    msg += '‚Ä¢ CPA Goal: ‚Ç¨' + (alert.cpaGoal || 0).toFixed(2) + '\n';
                    msg += '‚Ä¢ CPA Reale: ‚Ç¨' + (alert.cpaReale || 0).toFixed(2) + '\n';
                    msg += '‚Ä¢ CPA Pagata: ‚Ç¨' + (alert.cpaPagata || 0).toFixed(2) + '\n';
                    msg += '‚Ä¢ Profit: ‚Ç¨' + (alert.profit || 0).toFixed(2) + '\n';
                    msg += '‚Ä¢ ROI: ' + (alert.roi || 0).toFixed(2) + '%\n';
                    var roas = c.spend > 0 ? (alert.revenue / c.spend) : 0;
                    msg += '‚Ä¢ ROAS: ' + roas.toFixed(2) + 'x\n';
                    msg += '\n';
                });
            } else {
                msg += '‚úÖ ROI NEGATIVO (0)\n';
                msg += 'Nessuna campagna in perdita\n\n';
            }

            // CAMPAGNE ROI POSITIVO
            var roiPositivo = [];
            if (state.campaignsData) {
                state.campaignsData.forEach(function(campaign) {
                    var revenue = 0;
                    var approved = 0;
                    var cpaGoal = 0;
                    var cpaReale = 0;
                    var cpaPagata = 0;

                    // Estrai offer_id
                    var match = campaign.name.match(/^(\d+)-/);
                    var offerId = null;
                    if (match) {
                        offerId = match[1];
                        if (state.offersGoals[offerId]) {
                            cpaGoal = state.offersGoals[offerId];
                        } else {
                            var refOffer = state.offersReference[offerId];
                            if (refOffer && refOffer.payout) {
                                cpaGoal = refOffer.payout;
                            }
                        }

                        // Cerca revenue dall'offerta matchata usando l'offerId
                        if (state.matchedData) {
                            var matchedOffer = state.matchedData.find(function(offer) {
                                return offer.offerId === offerId;
                            });

                            if (matchedOffer) {
                                revenue = matchedOffer.revenue || 0;
                                approved = matchedOffer.approved || 0;
                            }
                        }
                    }

                    if (approved > 0) {
                        cpaReale = campaign.spend / approved;
                        cpaPagata = revenue / approved;
                    }

                    var spend = campaign.spend || 0;
                    var profit = revenue - spend;
                    var roi = spend > 0 ? ((revenue - spend) / spend * 100) : 0;

                    if (roi >= 0) {
                        roiPositivo.push({
                            campaign: campaign,
                            revenue: revenue,
                            profit: profit,
                            roi: roi,
                            approved: approved,
                            conversions: campaign.purchases || 0,
                            cpaGoal: cpaGoal,
                            cpaReale: cpaReale,
                            cpaPagata: cpaPagata
                        });
                    }
                });
            }

            if (roiPositivo.length > 0) {
                msg += '‚úÖ ROI POSITIVO (' + roiPositivo.length + ')\n';
                msg += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
                roiPositivo.forEach(function(alert) {
                    var c = alert.campaign;
                    msg += 'üìç ' + c.name + '\n';
                    msg += '‚Ä¢ Spesa: ‚Ç¨' + (c.spend || 0).toFixed(2) + '\n';
                    msg += '‚Ä¢ Conv ADV: ' + (alert.conversions || 0) + ' | Approvate: ' + (alert.approved || 0) + '\n';
                    msg += '‚Ä¢ Revenue: ‚Ç¨' + (alert.revenue || 0).toFixed(2) + '\n';
                    msg += '‚Ä¢ CPA Goal: ‚Ç¨' + (alert.cpaGoal || 0).toFixed(2) + '\n';
                    msg += '‚Ä¢ CPA Reale: ‚Ç¨' + (alert.cpaReale || 0).toFixed(2) + '\n';
                    msg += '‚Ä¢ CPA Pagata: ‚Ç¨' + (alert.cpaPagata || 0).toFixed(2) + '\n';
                    msg += '‚Ä¢ Profit: ‚Ç¨' + (alert.profit || 0).toFixed(2) + '\n';
                    msg += '‚Ä¢ ROI: ' + (alert.roi || 0).toFixed(2) + '%\n';
                    var roas = c.spend > 0 ? (alert.revenue / c.spend) : 0;
                    msg += '‚Ä¢ ROAS: ' + roas.toFixed(2) + 'x\n';
                    msg += '\n';
                });
            } else {
                msg += '‚úÖ ROI POSITIVO (0)\n';
                msg += 'Nessuna campagna in profitto\n\n';
            }

            // Footer
            msg += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
            msg += 'üìä Totale Campagne: ' + (state.campaignsData ? state.campaignsData.length : 0) + '\n';
            msg += '‚ö†Ô∏è In Perdita: ' + roiNegativo.length + '\n';
            msg += '‚úÖ In Profitto: ' + roiPositivo.length;

            return msg;
        }

        function toggleAddMetaForm() {
            state.showAddMetaForm = !state.showAddMetaForm;
            render();
        }

        function toggleAddGoogleForm() {
            state.showAddGoogleForm = !state.showAddGoogleForm;
            render();
        }

        function toggleAddTikTokForm() {
            state.showAddTikTokForm = !state.showAddTikTokForm;
            render();
        }

        function updateNewMetaName(value) {
            state.newAccount.meta.name = value;
        }

        function updateNewMetaToken(value) {
            state.newAccount.meta.accessToken = value;
        }

        function updateNewMetaAccount(value) {
            state.newAccount.meta.accountId = value;
        }

        function updateNewGoogleName(value) {
            state.newAccount.google.name = value;
        }

        function updateNewGoogleCustomer(value) {
            state.newAccount.google.customerId = value;
        }

        function updateNewGoogleClient(value) {
            state.newAccount.google.clientId = value;
        }

        function updateNewGoogleSecret(value) {
            state.newAccount.google.clientSecret = value;
        }

        function updateNewGoogleRefresh(value) {
            state.newAccount.google.refreshToken = value;
        }

        function updateNewTikTokName(value) {
            state.newAccount.tiktok.name = value;
        }

        function updateNewTikTokToken(value) {
            state.newAccount.tiktok.accessToken = value;
        }

        function updateNewTikTokAdvertiser(value) {
            state.newAccount.tiktok.advertiserId = value;
        }

        window.addEventListener('beforeunload', function() {
            stopAutoSync();
        });
        //PART 3
        // ========== MAIN RENDER ==========
        function render() {
            if (state.loading) return;

            var app = document.getElementById('app');
            var html = '';
            
            html += '<div class="header-top">';
            html += '<div><h1>Track Campaign</h1></div>';
            html += '<div class="btn-group">';

            // Dropdown per switch tra i miei dati e dati condivisi
            if (state.sharedTrackers.length > 0 || state.viewingTrackerId) {
                html += '<div style="position: relative; margin-right: 12px;">';
                html += '<select onchange="switchTracker(this.value)" style="padding: 10px 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 0.875rem;">';
                html += '<option value="" ' + (!state.viewingTrackerId ? 'selected' : '') + '>üìä I Miei Dati</option>';

                state.sharedTrackers.forEach(function(tracker) {
                    html += '<option value="' + tracker.owner_id + '" ' + (state.viewingTrackerId === tracker.owner_id ? 'selected' : '') + '>üë§ ' + tracker.owner_email + ' (' + tracker.permission + ')</option>';
                });

                html += '</select>';
                html += '</div>';
            }

            if (state.syncing) {
                html += '<div class="sync-status syncing">üîÑ Sincronizzazione...</div>';
            } else if (state.lastSync) {
                html += '<div class="sync-status">‚úÖ Sync: ' + state.lastSync.toLocaleTimeString('it-IT') + '</div>';
            } else {
                html += '<div class="sync-status" style="border-color: #f59e0b; background: rgba(245, 158, 11, 0.2);">‚è≥ Mai sincronizzato</div>';
            }

            html += '<button onclick="syncData()" class="btn-success"';
            if (state.syncing || state.viewingTrackerId) html += ' disabled';
            html += '>' + (state.syncing ? '‚è≥ Syncing...' : 'üîÑ Sync Ora') + '</button>';
            html += '<button onclick="openShareTrackerModal()" class="btn-primary">üë• Condividi Tracker</button>';
            html += '<button onclick="location.href=\'dashboard.html\'" class="btn-secondary">‚Üê Dashboard</button>';
            html += '</div></div>';

            html += '<div class="tabs">';
            html += '<button onclick="setTab(\'dashboard\')" class="tab-btn ' + (state.currentTab === 'dashboard' ? 'active' : '') + '">üìä Dashboard</button>';
            html += '<button onclick="setTab(\'trends\')" class="tab-btn ' + (state.currentTab === 'trends' ? 'active' : '') + '">üìà Trends</button>';
            html += '<button onclick="setTab(\'alerts\')" class="tab-btn ' + (state.currentTab === 'alerts' ? 'active' : '') + '">üîî Alert</button>';
            html += '<button onclick="setTab(\'history\')" class="tab-btn ' + (state.currentTab === 'history' ? 'active' : '') + '">üìä Storico & Grafici</button>';
            html += '<button onclick="setTab(\'campaigns\')" class="tab-btn ' + (state.currentTab === 'campaigns' ? 'active' : '') + '">üéØ Campagne</button>';
            html += '<button onclick="setTab(\'creative\')" class="tab-btn ' + (state.currentTab === 'creative' ? 'active' : '') + '">üé® Creative</button>';
            html += '<button onclick="setTab(\'offers\')" class="tab-btn ' + (state.currentTab === 'offers' ? 'active' : '') + '">üí∞ Offerte</button>';
            html += '<button onclick="setTab(\'sheets\')" class="tab-btn ' + (state.currentTab === 'sheets' ? 'active' : '') + '">üìÑ Fogli Sheet</button>';
            html += '<button onclick="setTab(\'settings\')" class="tab-btn ' + (state.currentTab === 'settings' ? 'active' : '') + '">‚öôÔ∏è Impostazioni API</button>';
            html += '</div>';

            if (state.currentTab === 'dashboard') {
                html += renderDashboard();
            } else if (state.currentTab === 'trends') {
                html += renderTrends();
            } else if (state.currentTab === 'alerts') {
                html += renderAlerts();
            } else if (state.currentTab === 'history') {
                html += renderHistory();
            } else if (state.currentTab === 'campaigns') {
                html += renderCampaigns();
            } else if (state.currentTab === 'creative') {
                html += renderCreative();
            } else if (state.currentTab === 'offers') {
                html += renderOffers();
            } else if (state.currentTab === 'sheets') {
                html += renderSheets();
            } else if (state.currentTab === 'settings') {
                html += renderSettings();
            }

            // Modal per condividere il tracker completo
            if (state.showShareTrackerModal) {
                html += '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000;">';
                html += '<div style="background: #334155; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">';
                html += '<h2 style="margin-bottom: 20px;">üë• Condividi Affiliate Tracker</h2>';
                html += '<p style="color: #9ca3af; font-size: 0.875rem; margin-bottom: 20px;">Condividi tutti i dati del tracker (campagne, offerte, statistiche, social credentials) con altri utenti.</p>';

                html += '<div style="display: flex; flex-direction: column; gap: 16px;">';

                // Selezione utente
                html += '<div>';
                html += '<label style="display: block; color: #9ca3af; font-size: 0.875rem; font-weight: 600; margin-bottom: 8px;">Seleziona Utente</label>';
                html += '<select onchange="state.selectedUser = this.value; render();" style="width: 100%;">';
                html += '<option value="">-- Seleziona un utente --</option>';
                state.availableUsers.forEach(function(user) {
                    html += '<option value="' + user.id + '" ' + (state.selectedUser === user.id ? 'selected' : '') + '>' + user.name + ' (' + user.email + ')</option>';
                });
                html += '</select>';
                html += '</div>';

                // Selezione permesso
                html += '<div>';
                html += '<label style="display: block; color: #9ca3af; font-size: 0.875rem; font-weight: 600; margin-bottom: 8px;">Permesso</label>';
                html += '<select onchange="state.sharePermission = this.value; render();" style="width: 100%;">';
                html += '<option value="view" ' + (state.sharePermission === 'view' ? 'selected' : '') + '>üëÅÔ∏è Solo Visualizzazione</option>';
                html += '<option value="edit" ' + (state.sharePermission === 'edit' ? 'selected' : '') + '>‚úèÔ∏è Modifica (pu√≤ modificare campagne e dati)</option>';
                html += '</select>';
                html += '<p style="font-size: 0.75rem; color: #9ca3af; margin-top: 4px;">';
                html += state.sharePermission === 'view' ? 'L\'utente potr√† solo visualizzare tutti i dati del tracker' : 'L\'utente potr√† visualizzare e modificare campagne e configurazioni';
                html += '</p>';
                html += '</div>';

                // Lista condivisioni esistenti
                if (state.trackerShares.length > 0) {
                    html += '<div style="padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">';
                    html += '<div style="font-size: 0.875rem; color: #9ca3af; margin-bottom: 8px; font-weight: 600;">Gi√† condiviso con:</div>';
                    state.trackerShares.forEach(function(share) {
                        html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; margin-bottom: 4px;">';
                        html += '<span style="font-size: 0.875rem;">' + share.user_email + '</span>';
                        html += '<div style="display: flex; gap: 8px; align-items: center;">';
                        html += '<span style="font-size: 0.75rem; color: #9ca3af;">' + (share.permission === 'view' ? 'üëÅÔ∏è Vista' : '‚úèÔ∏è Modifica') + '</span>';
                        html += '<button onclick="removeTrackerShare(\'' + share.id + '\')" style="background: rgba(239, 68, 68, 0.2); border: none; color: #ef4444; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">üóëÔ∏è</button>';
                        html += '</div>';
                        html += '</div>';
                    });
                    html += '</div>';
                }

                html += '</div>';

                html += '<div style="display: flex; gap: 12px; margin-top: 24px;">';
                html += '<button onclick="shareTracker()" class="btn-primary" style="flex: 1;">üë• Condividi Tracker</button>';
                html += '<button onclick="closeShareTrackerModal()" class="btn-secondary" style="flex: 1;">‚ùå Chiudi</button>';
                html += '</div>';

                html += '</div></div>';
            }

            app.innerHTML = html;

            // Modale anteprima creativit√† (viene aggiunta dopo il render principale)
            if (state.currentCreativePreview) {
                var modalHtml = renderCreativePreviewModal();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
        }

        // ========== DASHBOARD ==========
        function renderDashboard() {
            var html = '';
            
            html += '<div class="filters">';
            html += '<input type="date" value="' + state.dateFrom + '" onchange="updateDateFrom(this.value)">';
            html += '<span style="color: #9ca3af; padding: 0 8px;">‚Üí</span>';
            html += '<input type="date" value="' + state.dateTo + '" onchange="updateDateTo(this.value)">';
            html += '<button onclick="syncData()" class="btn-primary">üìÖ Aggiorna Periodo</button>';
            html += '</div>';

            html += '<div class="stats-grid">';
            html += '<div class="stat-card"><div class="stat-label">üí∞ Spesa Totale ADV</div>';
            html += '<div class="stat-value">‚Ç¨' + state.stats.totalSpend.toLocaleString('it-IT') + '</div>';
            html += '<div class="stat-change positive">Meta + Google + TikTok</div></div>';
            
            html += '<div class="stat-card"><div class="stat-label">‚úÖ Conversioni</div>';
            html += '<div class="stat-value">' + state.stats.totalConversions + '</div>';
            html += '<div class="stat-change">da Traffic Manager</div></div>';
            
            html += '<div class="stat-card"><div class="stat-label">üíµ Revenue Totale</div>';
            html += '<div class="stat-value">‚Ç¨' + state.stats.totalRevenue.toLocaleString('it-IT') + '</div>';
            html += '<div class="stat-change positive">Commissioni approvate</div></div>';

            html += '<div class="stat-card"><div class="stat-label">üí∞ Profit Netto</div>';
            html += '<div class="stat-value ' + (state.stats.profit >= 0 ? '' : 'negative') + '">‚Ç¨' + state.stats.profit.toLocaleString('it-IT') + '</div>';
            html += '<div class="stat-change ' + (state.stats.profit >= 0 ? 'positive' : 'negative') + '">Revenue - Spesa ADV</div></div>';

            html += '<div class="stat-card"><div class="stat-label">üìà ROI</div>';
            html += '<div class="stat-value">' + state.stats.roi + '%</div>';
            html += '<div class="stat-change ' + (state.stats.roi > 0 ? 'positive' : 'negative') + '">(Revenue - Spesa) / Spesa</div></div>';

            html += '<div class="stat-card"><div class="stat-label">üíé ROAS</div>';
            html += '<div class="stat-value">' + state.stats.roas + 'x</div>';
            html += '<div class="stat-change">Revenue / Spesa</div></div>';
            html += '</div>';

            html += '<div class="card"><div class="card-title"><span>üìä Performance per Piattaforma</span></div>';
            
            if (state.matchedData && state.matchedData.length > 0) {
                var metaSpend = 0, googleSpend = 0, tiktokSpend = 0;
                var metaRevenue = 0, googleRevenue = 0, tiktokRevenue = 0;
                
                state.matchedData.forEach(function(offer) {
                    metaSpend += offer.platformBreakdown.meta;
                    googleSpend += offer.platformBreakdown.google;
                    tiktokSpend += offer.platformBreakdown.tiktok;
                    
                    var offerMetaPct = offer.totalSpend > 0 ? offer.platformBreakdown.meta / offer.totalSpend : 0;
                    var offerGooglePct = offer.totalSpend > 0 ? offer.platformBreakdown.google / offer.totalSpend : 0;
                    var offerTiktokPct = offer.totalSpend > 0 ? offer.platformBreakdown.tiktok / offer.totalSpend : 0;
                    
                    metaRevenue += offer.revenue * offerMetaPct;
                    googleRevenue += offer.revenue * offerGooglePct;
                    tiktokRevenue += offer.revenue * offerTiktokPct;
                });
                
                var metaProfit = metaRevenue - metaSpend;
                var googleProfit = googleRevenue - googleSpend;
                var tiktokProfit = tiktokRevenue - tiktokSpend;

                html += '<table><thead><tr>';
                html += '<th>Piattaforma</th><th>Spesa</th><th>Revenue</th><th>Profit</th><th>ROI</th><th>ROAS</th>';
                html += '</tr></thead><tbody>';

                html += '<tr><td><span class="platform-badge platform-meta">üìò Meta Ads</span></td>';
                html += '<td>‚Ç¨' + metaSpend.toFixed(2) + '</td>';
                html += '<td>‚Ç¨' + metaRevenue.toFixed(2) + '</td>';
                html += '<td style="color:' + (metaProfit >= 0 ? '#22c55e' : '#ef4444') + '"><strong>‚Ç¨' + metaProfit.toFixed(2) + '</strong></td>';
                html += '<td style="color:' + (metaProfit >= 0 ? '#22c55e' : '#ef4444') + '">' + (metaSpend > 0 ? ((metaRevenue - metaSpend) / metaSpend * 100).toFixed(2) : '0.00') + '%</td>';
                html += '<td>' + (metaSpend > 0 ? (metaRevenue / metaSpend).toFixed(2) : '0.00') + 'x</td></tr>';

                html += '<tr><td><span class="platform-badge platform-google">üî¥ Google Ads</span></td>';
                html += '<td>‚Ç¨' + googleSpend.toFixed(2) + '</td>';
                html += '<td>‚Ç¨' + googleRevenue.toFixed(2) + '</td>';
                html += '<td style="color:' + (googleProfit >= 0 ? '#22c55e' : '#ef4444') + '"><strong>‚Ç¨' + googleProfit.toFixed(2) + '</strong></td>';
                html += '<td style="color:' + (googleProfit >= 0 ? '#22c55e' : '#ef4444') + '">' + (googleSpend > 0 ? ((googleRevenue - googleSpend) / googleSpend * 100).toFixed(2) : '0.00') + '%</td>';
                html += '<td>' + (googleSpend > 0 ? (googleRevenue / googleSpend).toFixed(2) : '0.00') + 'x</td></tr>';

                html += '<tr><td><span class="platform-badge platform-tiktok">üéµ TikTok Ads</span></td>';
                html += '<td>‚Ç¨' + tiktokSpend.toFixed(2) + '</td>';
                html += '<td>‚Ç¨' + tiktokRevenue.toFixed(2) + '</td>';
                html += '<td style="color:' + (tiktokProfit >= 0 ? '#22c55e' : '#ef4444') + '"><strong>‚Ç¨' + tiktokProfit.toFixed(2) + '</strong></td>';
                html += '<td style="color:' + (tiktokProfit >= 0 ? '#22c55e' : '#ef4444') + '">' + (tiktokSpend > 0 ? ((tiktokRevenue - tiktokSpend) / tiktokSpend * 100).toFixed(2) : '0.00') + '%</td>';
                html += '<td>' + (tiktokSpend > 0 ? (tiktokRevenue / tiktokSpend).toFixed(2) : '0.00') + 'x</td></tr>';

                html += '</tbody></table>';
            } else {
                html += '<div class="empty-state"><div class="empty-state-icon">üì≠</div>';
                html += '<p><strong>Nessun dato disponibile</strong></p>';
                html += '<p style="font-size: 0.875rem; margin-top: 8px;">Clicca su "üîÑ Sync Ora"</p></div>';
            }
            html += '</div>';

            return html;
        }

        // ========== TRENDS ==========
        function renderTrends() {
            var html = '';

            // TREND AUTOMATICI SECTION
            html += '<div class="card">';
            html += '<div class="card-title" style="display:flex;justify-content:space-between;align-items:center;">';
            html += '<span>üìä Trend Automatici Campagne Attive</span>';
            if (!state.trendsLoading && state.campaignTrends.length > 0) {
                html += '<span style="font-size:0.875rem;color:#9ca3af;">' + state.campaignTrends.length + ' campagne</span>';
            }
            html += '</div>';

            if (state.trendsLoading) {
                html += '<div style="text-align:center;padding:40px;color:#9ca3af;">';
                html += '<div style="font-size:2rem;margin-bottom:12px;">‚è≥</div>';
                html += '<p>Caricamento trend storici...</p>';
                html += '</div>';
            } else if (state.campaignTrends.length === 0) {
                html += '<div style="text-align:center;padding:40px;">';
                html += '<p style="color:#9ca3af;margin-bottom:16px;">üìä Confronta automaticamente il ROI delle campagne attive</p>';
                html += '<p style="color:#6b7280;font-size:0.875rem;margin-bottom:24px;">Periodi: 1g, 3g, 7g, 15g, 30g fa</p>';
                html += '<button onclick="loadAndCalculateTrends()" class="btn-primary">üîç Analizza Trend</button>';
                html += '</div>';
            } else {
                // FILTRI
                html += '<div style="display:grid;grid-template-columns:1fr auto;gap:12px;margin:16px 0;padding:16px;background:rgba(255,255,255,0.03);border-radius:8px;">';

                // Campo ricerca
                html += '<div>';
                html += '<input type="text" placeholder="üîç Cerca offerta o campagna..." value="' + (state.trendsAutoFilters.searchQuery || '') + '" ';
                html += 'oninput="debouncedTrendsSearch(this.value)" ';
                html += 'style="width:100%;max-width:400px;padding:10px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);';
                html += 'background:rgba(255,255,255,0.1);color:white;font-size:14px">';
                html += '</div>';

                // Dropdown ordinamento
                html += '<div>';
                html += '<select onchange="state.trendsAutoFilters.sortBy = this.value; render();" ';
                html += 'style="padding:10px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.15);color:white;font-size:14px;">';
                html += '<option value="roi_asc" ' + (state.trendsAutoFilters.sortBy === 'roi_asc' ? 'selected' : '') + '>üìâ ROI: Dal pi√π basso</option>';
                html += '<option value="roi_desc" ' + (state.trendsAutoFilters.sortBy === 'roi_desc' ? 'selected' : '') + '>üìà ROI: Dal pi√π alto</option>';
                html += '</select>';
                html += '</div>';

                html += '</div>';

                // Filtra per ricerca
                var filteredTrends = state.campaignTrends;
                if (state.trendsAutoFilters.searchQuery && state.trendsAutoFilters.searchQuery.trim()) {
                    var searchLower = state.trendsAutoFilters.searchQuery.toLowerCase();
                    filteredTrends = filteredTrends.filter(function(offer) {
                        // Cerca in nome offerta
                        if (offer.offerName.toLowerCase().includes(searchLower)) return true;
                        // Cerca in ID offerta
                        if (offer.offerId.includes(searchLower)) return true;
                        // Cerca in nomi campagne
                        return offer.campaigns.some(function(camp) {
                            return camp.campaign.name.toLowerCase().includes(searchLower);
                        });
                    });
                }

                // Ordina
                if (state.trendsAutoFilters.sortBy === 'roi_desc') {
                    filteredTrends = filteredTrends.slice().sort(function(a, b) {
                        return b.currentROI - a.currentROI;
                    });
                } else {
                    filteredTrends = filteredTrends.slice().sort(function(a, b) {
                        return a.currentROI - b.currentROI;
                    });
                }

                // Mostra trend raggruppati per offerta
                html += '<div style="overflow-x:auto;margin-top:8px;">';
                html += '<table><thead><tr>';
                html += '<th style="width:40px;"></th>'; // Colonna espandi
                html += '<th>Offerta</th>';
                html += '<th style="background:rgba(34,197,94,0.1);">ROI Attuale</th>';
                html += '<th>vs 1g</th>';
                html += '<th>vs 3g</th>';
                html += '<th>vs 7g</th>';
                html += '<th>vs 15g</th>';
                html += '<th>vs 30g</th>';
                html += '<th>Spesa</th>';
                html += '<th>Profit</th>';
                html += '<th>Campagne</th>';
                html += '</tr></thead><tbody>';

                filteredTrends.forEach(function(offer, idx) {
                    var roiColor = offer.currentROI >= 0 ? '#22c55e' : '#ef4444';

                    // RIGA OFFERTA (principale)
                    html += '<tr style="cursor:pointer;' + (offer.currentROI < 0 ? 'background:rgba(239,68,68,0.03);' : '') + '" onclick="toggleOfferTrend(\'' + offer.offerId + '\')">';

                    // Bottone espandi
                    html += '<td style="text-align:center;">';
                    html += '<span style="font-size:1.2rem;">' + (offer.expanded ? '‚ñº' : '‚ñ∂') + '</span>';
                    html += '</td>';

                    html += '<td><strong>' + offer.offerId + ' - ' + offer.offerName.substring(0, 30) + (offer.offerName.length > 30 ? '...' : '') + '</strong></td>';
                    html += '<td style="color:' + roiColor + ';font-weight:600;font-size:1.1rem;">' + offer.currentROI.toFixed(1) + '%</td>';

                    // Trend offerta per ogni periodo
                    ['1g', '3g', '7g', '15g', '30g'].forEach(function(period) {
                        var trend = offer.trends[period];
                        if (!trend) {
                            html += '<td style="color:#6b7280;font-size:0.875rem;">‚Äî</td>';
                        } else {
                            var icon = trend.direction === 'up' ? 'üî∫' : (trend.direction === 'down' ? 'üîª' : '‚ûñ');
                            var color = trend.direction === 'up' ? '#22c55e' : (trend.direction === 'down' ? '#ef4444' : '#9ca3af');

                            html += '<td style="color:' + color + ';font-size:0.875rem;">';
                            html += icon + ' ' + (trend.roiDiff >= 0 ? '+' : '') + trend.roiDiff.toFixed(1) + '%';
                            html += '<br><span style="font-size:0.7rem;color:#9ca3af;">(era ' + trend.historicalROI.toFixed(1) + '%)</span>';
                            html += '</td>';
                        }
                    });

                    html += '<td>‚Ç¨' + offer.currentSpend.toFixed(0) + '</td>';
                    html += '<td style="color:' + (offer.currentProfit >= 0 ? '#22c55e' : '#ef4444') + ';font-weight:600;">‚Ç¨' + offer.currentProfit.toFixed(0) + '</td>';

                    // Conta campagne per stato
                    var activeCount = 0;
                    var pausedCount = 0;
                    var archivedCount = 0;
                    var otherCount = 0;
                    offer.campaigns.forEach(function(camp) {
                        if (camp.status === 'ACTIVE') {
                            activeCount++;
                        } else if (camp.status === 'PAUSED') {
                            pausedCount++;
                        } else if (camp.status === 'ARCHIVED') {
                            archivedCount++;
                        } else {
                            otherCount++;
                        }
                    });

                    // Colonna Campagne con badge stati
                    html += '<td style="padding:4px;white-space:nowrap;">';
                    if (activeCount > 0) {
                        html += '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:600;margin-right:4px;">‚úÖ ' + activeCount + '</span>';
                    }
                    if (pausedCount > 0) {
                        html += '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:600;margin-right:4px;">‚è∏Ô∏è ' + pausedCount + '</span>';
                    }
                    if (archivedCount > 0) {
                        html += '<span style="background:#9ca3af;color:white;padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:600;margin-right:4px;">üì¶ ' + archivedCount + '</span>';
                    }
                    if (otherCount > 0) {
                        html += '<span style="background:#ef4444;color:white;padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:600;">‚ùå ' + otherCount + '</span>';
                    }
                    html += '</td>';
                    html += '</tr>';

                    // RIGHE CAMPAGNE (espanse)
                    if (offer.expanded) {
                        offer.campaigns.forEach(function(camp) {
                            var campStatus = camp.status;
                            var statusBadge = '';
                            var statusColor = '';

                            if (campStatus === 'ACTIVE') {
                                statusBadge = '‚úÖ ATTIVA';
                                statusColor = '#22c55e';
                            } else if (campStatus === 'PAUSED') {
                                statusBadge = '‚è∏Ô∏è PAUSA';
                                statusColor = '#f59e0b';
                            } else if (campStatus === 'ARCHIVED') {
                                statusBadge = 'üì¶ ARCHIVIATA';
                                statusColor = '#9ca3af';
                            } else {
                                statusBadge = '‚ùå ' + campStatus;
                                statusColor = '#ef4444';
                            }

                            var campRoiColor = camp.roi >= 0 ? '#22c55e' : '#ef4444';

                            html += '<tr style="background:rgba(255,255,255,0.02);">';
                            html += '<td></td>'; // Colonna espandi vuota
                            html += '<td style="padding-left:30px;color:#9ca3af;font-size:0.875rem;">‚Ü≥ ' + camp.campaign.name.substring(0, 35) + (camp.campaign.name.length > 35 ? '...' : '') + '</td>';
                            html += '<td style="color:' + campRoiColor + ';font-size:0.9rem;">' + camp.roi.toFixed(1) + '%</td>';

                            // Trend campagna per ogni periodo
                            ['1g', '3g', '7g', '15g', '30g'].forEach(function(period) {
                                var trend = camp.trends[period];
                                if (!trend) {
                                    html += '<td style="color:#6b7280;font-size:0.75rem;">‚Äî</td>';
                                } else {
                                    var icon = trend.direction === 'up' ? 'üî∫' : (trend.direction === 'down' ? 'üîª' : '‚ûñ');
                                    var color = trend.direction === 'up' ? '#22c55e' : (trend.direction === 'down' ? '#ef4444' : '#9ca3af');

                                    html += '<td style="color:' + color + ';font-size:0.75rem;">';
                                    html += icon + ' ' + (trend.roiDiff >= 0 ? '+' : '') + trend.roiDiff.toFixed(1) + '%';
                                    html += '</td>';
                                }
                            });

                            html += '<td style="font-size:0.9rem;">‚Ç¨' + camp.spend.toFixed(0) + '</td>';
                            html += '<td></td>'; // Profit vuoto (√® a livello offerta)
                            html += '<td><span style="background:' + statusColor + ';color:white;padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:600;">' + statusBadge + '</span></td>';
                            html += '</tr>';
                        });
                    }
                });

                html += '</tbody></table></div>';

                html += '<div style="text-align:center;margin-top:20px;">';
                html += '<button onclick="loadAndCalculateTrends()" class="btn-secondary">üîÑ Aggiorna Trend</button>';
                html += '</div>';
            }
            html += '</div>';

            // CONFRONTO CUSTOM SECTION (quello esistente)
            html += '<div class="card" style="margin-top:24px;">';
            html += '<div class="card-title"><span>üìà Analisi Trend Custom</span></div>';
            html += '<div class="filters" style="grid-template-columns: auto 200px 200px auto;">';

            // Dropdown campagne
            html += '<select onchange="state.trendsFilters.campaignId = this.value; render();" style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);border-radius:8px;padding:10px;color:white;">';
            html += '<option value="all">üìä Tutte le Campagne</option>';
            if (state.campaignsData && state.campaignsData.length > 0) {
                state.campaignsData.forEach(function(campaign) {
                    var selected = state.trendsFilters.campaignId === campaign.name ? 'selected' : '';
                    html += '<option value="' + campaign.name + '" ' + selected + '>üéØ ' + campaign.name + '</option>';
                });
            }
            html += '</select>';

            // Date picker confronto
            html += '<input type="date" placeholder="Data inizio confronto" value="' + (state.trendsFilters.comparisonDateFrom || '') + '" onchange="state.trendsFilters.comparisonDateFrom = this.value; render();" style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);border-radius:8px;padding:10px;color:white;">';
            html += '<input type="date" placeholder="Data fine confronto" value="' + (state.trendsFilters.comparisonDateTo || '') + '" onchange="state.trendsFilters.comparisonDateTo = this.value; render();" style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);border-radius:8px;padding:10px;color:white;">';

            html += '<button onclick="loadTrendsData()" class="btn-primary">üîÑ Carica Confronto</button>';
            html += '</div>';
            html += '</div>';

            if (!state.trendsData.loaded) {
                html += '<div class="card">';
                html += '<div style="text-align:center;padding:40px;">';
                html += '<p style="color:#9ca3af;margin-bottom:16px;">üëÜ Seleziona un periodo di confronto e clicca "üîÑ Carica Confronto"</p>';
                html += '<p style="color:#6b7280;font-size:0.875rem;">Esempio: confronta Novembre con Ottobre selezionando le date</p>';
                html += '</div>';
                html += '</div>';
                return html;
            }

            // Calcola stats correnti (filtrate per campagna se selezionata)
            var currentSpend = 0;
            var currentRevenue = 0;

            if (state.trendsFilters.campaignId !== 'all') {
                // Filtra per campagna
                var currentCampaign = state.campaignsData.find(function(c) {
                    return c.name === state.trendsFilters.campaignId;
                });
                if (currentCampaign) {
                    currentSpend = currentCampaign.spend || 0;
                }

                // Revenue dalla campagna matchata
                state.matchedData.forEach(function(offer) {
                    var hasCampaign = offer.campaigns.some(function(c) {
                        return c.name === state.trendsFilters.campaignId;
                    });
                    if (hasCampaign) {
                        currentRevenue += offer.revenue;
                    }
                });
            } else {
                // Generale
                currentSpend = state.stats.totalSpend;
                currentRevenue = state.stats.totalRevenue;
            }

            var currentProfit = currentRevenue - currentSpend;
            var currentROI = currentSpend > 0 ? ((currentRevenue - currentSpend) / currentSpend * 100) : 0;
            var currentROAS = currentSpend > 0 ? (currentRevenue / currentSpend) : 0;

            // Tabella comparativa
            html += '<div class="card">';
            html += '<div class="card-title">';
            html += '<span>üìä Confronto Performance</span>';
            if (state.trendsFilters.campaignId !== 'all') {
                html += '<span style="font-size:0.875rem;color:#9ca3af;margin-left:12px;">Campagna: ' + state.trendsFilters.campaignId + '</span>';
            }
            html += '</div>';
            html += '<div style="overflow-x:auto;">';
            html += '<table><thead><tr>';
            html += '<th>Periodo</th><th>Spesa</th><th>Revenue</th><th>Profit</th><th>ROI</th><th>ROAS</th><th>Trend</th>';
            html += '</tr></thead><tbody>';

            // Periodo corrente
            html += '<tr style="background:rgba(59,130,246,0.15);">';
            html += '<td><strong>üìÖ Periodo Corrente</strong><br><span style="font-size:0.75rem;color:#9ca3af;">' + state.dateFrom + ' ‚Üí ' + state.dateTo + '</span></td>';
            html += '<td><strong>‚Ç¨' + currentSpend.toFixed(2) + '</strong></td>';
            html += '<td><strong>‚Ç¨' + currentRevenue.toFixed(2) + '</strong></td>';
            html += '<td><strong style="color:' + (currentProfit >= 0 ? '#22c55e' : '#ef4444') + ';">‚Ç¨' + currentProfit.toFixed(2) + '</strong></td>';
            html += '<td><strong>' + currentROI.toFixed(2) + '%</strong></td>';
            html += '<td><strong>' + currentROAS.toFixed(2) + 'x</strong></td>';
            html += '<td>-</td>';
            html += '</tr>';

            // Periodo di confronto
            var comp = state.trendsData.comparison;
            html += '<tr>';
            html += '<td><strong>‚è™ Periodo Confronto</strong><br><span style="font-size:0.75rem;color:#9ca3af;">' + comp.dateFrom + ' ‚Üí ' + comp.dateTo + '</span></td>';
            html += '<td>‚Ç¨' + comp.spend.toFixed(2) + '</td>';
            html += '<td>‚Ç¨' + comp.revenue.toFixed(2) + '</td>';
            html += '<td style="color:' + (comp.profit >= 0 ? '#22c55e' : '#ef4444') + ';">‚Ç¨' + comp.profit.toFixed(2) + '</td>';
            html += '<td>' + comp.roi.toFixed(2) + '%</td>';
            html += '<td>' + comp.roas.toFixed(2) + 'x</td>';
            html += '<td>' + getTrendBadge(currentROI, comp.roi, 'confronto') + '</td>';
            html += '</tr>';

            html += '</tbody></table>';
            html += '</div>';
            html += '</div>';

            // Info box
            html += '<div class="card">';
            html += '<div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:8px;padding:16px;">';
            html += '<strong>‚ÑπÔ∏è Come funziona:</strong><br>';
            html += '<span style="color:#9ca3af;font-size:0.875rem;line-height:1.8;">';
            html += '‚Ä¢ Seleziona una <strong>campagna specifica</strong> o "Tutte le Campagne" per analisi generale<br>';
            html += '‚Ä¢ Scegli un <strong>periodo di confronto</strong> personalizzato con i date picker<br>';
            html += '‚Ä¢ üî∫ Verde = Performance migliorata rispetto al periodo di confronto<br>';
            html += '‚Ä¢ üîª Rosso = Performance peggiorata rispetto al periodo di confronto<br>';
            html += '‚Ä¢ Puoi confrontare qualsiasi periodo custom (es: Nov vs Oct, Settimana 1 vs Settimana 2, ecc.)';
            html += '</span></div>';
            html += '</div>';

            return html;
        }

        // ========== CAMPAIGNS ==========
        function renderCampaigns() {
            var html = '';

            // Inizializza searchQuery se non esiste
            if (!state.campaignFilters.searchQuery) {
                state.campaignFilters.searchQuery = '';
            }

            // Filtri
            html += '<div class="card">';
            html += '<div class="filters">';
            html += '<select onchange="state.campaignFilters.status = this.value; render();" style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);border-radius:8px;padding:10px;color:white;">';
            html += '<option value="all" ' + (state.campaignFilters.status === 'all' ? 'selected' : '') + '>Tutte le Campagne</option>';
            html += '<option value="active" ' + (state.campaignFilters.status === 'active' ? 'selected' : '') + '>Solo Attive</option>';
            html += '<option value="inactive" ' + (state.campaignFilters.status === 'inactive' ? 'selected' : '') + '>Solo Inattive</option>';
            html += '</select>';
            html += '<input type="date" value="' + state.campaignFilters.dateFrom + '" onchange="state.campaignFilters.dateFrom = this.value; state.dateFrom = this.value; syncData();">';
            html += '<span style="color: #9ca3af; padding: 0 8px;">‚Üí</span>';
            html += '<input type="date" value="' + state.campaignFilters.dateTo + '" onchange="state.campaignFilters.dateTo = this.value; state.dateTo = this.value; syncData();">';
            html += '<button onclick="syncData()" class="btn-primary">üîÑ Sincronizza</button>';
            html += '</div>';
            html += '</div>';

            // CAMPO RICERCA
            html += '<div class="card" style="margin-bottom:16px;">';
            html += '<input type="text" placeholder="üîç Cerca campagna o account..." value="' + (state.campaignFilters.searchQuery || '') + '" ';
            html += 'oninput="debouncedCampaignSearch(this.value)" ';
            html += 'style="width:100%;max-width:500px;padding:12px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);';
            html += 'background:rgba(255,255,255,0.1);color:white;font-size:16px">';
            html += '</div>';

            html += '<div class="card"><div class="card-title">';
            html += '<span>üéØ Campagne Pubblicitarie</span>';
            html += '<span style="font-size:0.875rem;color:#9ca3af;">' + state.campaignsData.length + ' campagne totali</span>';
            html += '</div>';

            if (state.campaignsData.length > 0) {
                // Filtra le campagne in base allo stato REALE da Facebook
                var filtered = state.campaignsData.filter(function(c) {
                    if (state.campaignFilters.status === 'active') {
                        // Usa isActive se disponibile, altrimenti fallback su status or spend
                        return c.isActive === true || c.status === 'ACTIVE' || (c.status === undefined && c.spend > 0);
                    } else if (state.campaignFilters.status === 'inactive') {
                        return c.isActive === false || (c.status !== 'ACTIVE' && c.status !== undefined) || (c.status === undefined && c.spend === 0);
                    }
                    return true; // 'all'
                });

                // Applica filtro per ricerca
                if (state.campaignFilters.searchQuery && state.campaignFilters.searchQuery.trim()) {
                    var searchLower = state.campaignFilters.searchQuery.toLowerCase();
                    filtered = filtered.filter(function(c) {
                        // Cerca nel nome della campagna o nel nome dell'account
                        return c.name.toLowerCase().includes(searchLower) ||
                               (c.accountName || '').toLowerCase().includes(searchLower);
                    });
                }

                console.log('üéØ Filtro campagne:', state.campaignFilters.status, '- Totali:', state.campaignsData.length, '- Filtrate:', filtered.length);

                // Calcola macro dati
                var totalSpend = 0;
                var totalPurchases = 0;
                var totalCPM = 0;
                var totalCTR = 0;
                var campaignsWithCPM = 0;
                var campaignsWithCTR = 0;

                filtered.forEach(function(c) {
                    totalSpend += c.spend || 0;
                    totalPurchases += c.purchases || 0;
                    if (c.cpm && c.cpm > 0) {
                        totalCPM += c.cpm;
                        campaignsWithCPM++;
                    }
                    if (c.ctr && c.ctr > 0) {
                        totalCTR += c.ctr;
                        campaignsWithCTR++;
                    }
                });

                var avgCostPerPurchase = totalPurchases > 0 ? totalSpend / totalPurchases : 0;
                var avgCPM = campaignsWithCPM > 0 ? totalCPM / campaignsWithCPM : 0;
                var avgCTR = campaignsWithCTR > 0 ? totalCTR / campaignsWithCTR : 0;

                // Macro dati stat cards
                html += '<div class="stats-grid" style="margin-bottom:20px;">';
                html += '<div class="stat-card"><div class="stat-label">üí∞ Spesa Totale</div>';
                html += '<div class="stat-value">‚Ç¨' + totalSpend.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</div>';
                html += '<div class="stat-change">' + filtered.length + ' campagne</div></div>';

                html += '<div class="stat-card"><div class="stat-label">üõí Purchase Totali</div>';
                html += '<div class="stat-value">' + totalPurchases.toLocaleString('it-IT') + '</div>';
                html += '<div class="stat-change">Conversioni totali</div></div>';

                html += '<div class="stat-card"><div class="stat-label">üíµ Media Cost/Purchase</div>';
                html += '<div class="stat-value">‚Ç¨' + avgCostPerPurchase.toFixed(2) + '</div>';
                html += '<div class="stat-change">CPA medio</div></div>';

                html += '<div class="stat-card"><div class="stat-label">üìä Media CPM</div>';
                html += '<div class="stat-value">‚Ç¨' + avgCPM.toFixed(2) + '</div>';
                html += '<div class="stat-change">Costo per 1000 impression</div></div>';

                html += '<div class="stat-card"><div class="stat-label">üìà Media CTR</div>';
                html += '<div class="stat-value">' + avgCTR.toFixed(2) + '%</div>';
                html += '<div class="stat-change">Click-Through Rate</div></div>';
                html += '</div>';

                html += '<div style="overflow-x:auto;">';
                html += '<table><thead><tr>';
                html += '<th>Nome Campagna</th><th>Account</th><th>Piattaforma</th><th>Stato</th><th>Spesa</th><th>Purchase</th><th>Cost per Purchase</th><th>CPM</th><th>CTR</th>';
                html += '</tr></thead><tbody>';

                for (var i = 0; i < filtered.length; i++) {
                    var c = filtered[i];

                    // Determina il badge dello stato
                    var statusBadge = '';
                    var statusText = c.statusLabel || c.status || 'N/A';
                    var statusColor = '';

                    if (c.status === 'ACTIVE' || c.isActive === true) {
                        statusColor = '#22c55e'; // Verde
                        statusText = 'üü¢ Attiva';
                    } else if (c.status === 'PAUSED') {
                        statusColor = '#f59e0b'; // Arancione
                        statusText = '‚è∏Ô∏è Pausa';
                    } else if (c.status === 'ARCHIVED') {
                        statusColor = '#6b7280'; // Grigio
                        statusText = 'üì¶ Archiviata';
                    } else {
                        statusColor = '#ef4444'; // Rosso
                        statusText = 'üî¥ Inattiva';
                    }

                    html += '<tr>';
                    html += '<td><strong>' + c.name + '</strong></td>';
                    html += '<td style="color:#9ca3af;font-size:0.875rem;">' + (c.accountName || '-') + '</td>';
                    html += '<td><span class="platform-badge platform-' + c.platform + '">' + c.platform.toUpperCase() + '</span></td>';
                    html += '<td><span style="color:' + statusColor + ';font-weight:600;font-size:0.875rem;">' + statusText + '</span></td>';
                    html += '<td><strong>‚Ç¨' + c.spend.toFixed(2) + '</strong></td>';
                    html += '<td>' + (c.purchases || 0) + '</td>';
                    html += '<td>‚Ç¨' + (c.costPerPurchase || 0).toFixed(2) + '</td>';
                    html += '<td>‚Ç¨' + (c.cpm || 0).toFixed(2) + '</td>';
                    html += '<td>' + (c.ctr || 0).toFixed(2) + '%</td>';
                    html += '</tr>';
                }
                html += '</tbody></table>';
                html += '<p style="color:#9ca3af;font-size:0.875rem;margin-top:16px;">';
                html += 'üìä Mostrando <strong>' + filtered.length + '</strong> campagne';
                if (state.campaignFilters.status !== 'all') {
                    html += ' (' + (state.campaignFilters.status === 'active' ? 'attive' : 'inattive') + ')';
                }
                html += '</p>';
                html += '</div>';
            } else {
                html += '<div class="empty-state"><div class="empty-state-icon">üéØ</div>';
                html += '<p><strong>Nessuna campagna trovata</strong></p>';
                html += '<p style="font-size: 0.875rem; margin-top: 8px;">Sincronizza i dati per vedere le campagne</p>';
                html += '<button onclick="syncData()" class="btn-primary" style="margin-top: 20px;">üîÑ Sincronizza Ora</button>';
                html += '</div>';
            }
            html += '</div>';

            return html;
        }

        // ========== CREATIVE / INSERZIONI ==========
        function renderCreative() {
            var html = '';

            // Inizializza filtri se non esistono
            if (!state.creativeFilters) {
                state.creativeFilters = {
                    searchQuery: '',
                    sortBy: 'conversions_desc', // conversions_desc, conversions_asc, cpa_asc, cpa_desc
                    status: 'all' // all, active, paused
                };
            }

            html += '<div class="card"><div class="card-title">';
            html += '<span>üé® Creative / Inserzioni - Performance Dettagliata</span>';
            html += '<span style="font-size:0.875rem;color:#9ca3af;">' + state.adsData.length + ' ads totali</span>';
            html += '</div>';

            if (state.adsData.length > 0) {
                // FILTRI
                html += '<div style="display:grid;grid-template-columns:1fr auto auto;gap:12px;margin:16px 0;padding:16px;background:rgba(255,255,255,0.03);border-radius:8px;">';

                // Campo ricerca
                html += '<div>';
                html += '<input type="text" placeholder="üîç Cerca campagna o creativit√†..." value="' + (state.creativeFilters.searchQuery || '') + '" ';
                html += 'oninput="state.creativeFilters.searchQuery = this.value; render();" ';
                html += 'style="width:100%;max-width:400px;padding:10px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);';
                html += 'background:rgba(255,255,255,0.1);color:white;font-size:14px">';
                html += '</div>';

                // Dropdown ordinamento
                html += '<div>';
                html += '<select onchange="state.creativeFilters.sortBy = this.value; render();" ';
                html += 'style="padding:10px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.15);color:white;font-size:14px;">';
                html += '<option value="conversions_desc" ' + (state.creativeFilters.sortBy === 'conversions_desc' ? 'selected' : '') + '>üî• Conversioni: Pi√π alte</option>';
                html += '<option value="conversions_asc" ' + (state.creativeFilters.sortBy === 'conversions_asc' ? 'selected' : '') + '>‚ùÑÔ∏è Conversioni: Pi√π basse</option>';
                html += '<option value="cpa_asc" ' + (state.creativeFilters.sortBy === 'cpa_asc' ? 'selected' : '') + '>üí∞ CPA: Pi√π basso</option>';
                html += '<option value="cpa_desc" ' + (state.creativeFilters.sortBy === 'cpa_desc' ? 'selected' : '') + '>üí∏ CPA: Pi√π alto</option>';
                html += '</select>';
                html += '</div>';

                // Dropdown status
                html += '<div>';
                html += '<select onchange="state.creativeFilters.status = this.value; render();" ';
                html += 'style="padding:10px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.15);color:white;font-size:14px;">';
                html += '<option value="all" ' + (state.creativeFilters.status === 'all' ? 'selected' : '') + '>Tutte</option>';
                html += '<option value="active" ' + (state.creativeFilters.status === 'active' ? 'selected' : '') + '>‚úÖ Solo Attive</option>';
                html += '<option value="paused" ' + (state.creativeFilters.status === 'paused' ? 'selected' : '') + '>‚è∏Ô∏è Solo In Pausa</option>';
                html += '</select>';
                html += '</div>';

                html += '</div>';

                // Filtra le Ads
                var filtered = state.adsData.slice();

                // Filtro ricerca
                if (state.creativeFilters.searchQuery && state.creativeFilters.searchQuery.trim()) {
                    var searchLower = state.creativeFilters.searchQuery.toLowerCase();
                    filtered = filtered.filter(function(ad) {
                        return ad.adName.toLowerCase().includes(searchLower) ||
                               ad.campaignName.toLowerCase().includes(searchLower) ||
                               (ad.accountName || '').toLowerCase().includes(searchLower);
                    });
                }

                // Filtro stato
                if (state.creativeFilters.status === 'active') {
                    filtered = filtered.filter(function(ad) {
                        return ad.adStatus === 'ACTIVE';
                    });
                } else if (state.creativeFilters.status === 'paused') {
                    filtered = filtered.filter(function(ad) {
                        return ad.adStatus === 'PAUSED';
                    });
                }

                // Ordina
                if (state.creativeFilters.sortBy === 'conversions_desc') {
                    filtered.sort(function(a, b) {
                        return (b.metrics.conversions || 0) - (a.metrics.conversions || 0);
                    });
                } else if (state.creativeFilters.sortBy === 'conversions_asc') {
                    filtered.sort(function(a, b) {
                        return (a.metrics.conversions || 0) - (b.metrics.conversions || 0);
                    });
                } else if (state.creativeFilters.sortBy === 'cpa_asc') {
                    filtered.sort(function(a, b) {
                        var cpaA = a.metrics.costPerConversion || 999999;
                        var cpaB = b.metrics.costPerConversion || 999999;
                        return cpaA - cpaB;
                    });
                } else if (state.creativeFilters.sortBy === 'cpa_desc') {
                    filtered.sort(function(a, b) {
                        var cpaA = a.metrics.costPerConversion || 0;
                        var cpaB = b.metrics.costPerConversion || 0;
                        return cpaB - cpaA;
                    });
                }

                // Identifica TOP 10 conversioni e BEST 10 CPA
                var topConversions = state.adsData.slice()
                    .sort(function(a, b) {
                        return (b.metrics.conversions || 0) - (a.metrics.conversions || 0);
                    })
                    .slice(0, 10)
                    .map(function(ad) { return ad.adId; });

                var bestCPA = state.adsData.slice()
                    .filter(function(ad) { return ad.metrics.conversions > 0; }) // Solo Ads con conversioni
                    .sort(function(a, b) {
                        var cpaA = a.metrics.costPerConversion || 999999;
                        var cpaB = b.metrics.costPerConversion || 999999;
                        return cpaA - cpaB;
                    })
                    .slice(0, 10)
                    .map(function(ad) { return ad.adId; });

                // Statistiche
                var totalSpend = 0;
                var totalConversions = 0;
                var totalImpressions = 0;
                var totalClicks = 0;

                filtered.forEach(function(ad) {
                    totalSpend += ad.metrics.spend || 0;
                    totalConversions += ad.metrics.conversions || 0;
                    totalImpressions += ad.metrics.impressions || 0;
                    totalClicks += ad.metrics.clicks || 0;
                });

                var avgCPA = totalConversions > 0 ? totalSpend / totalConversions : 0;
                var avgCTR = totalImpressions > 0 ? (totalClicks / totalImpressions) * 100 : 0;
                var avgCPM = totalImpressions > 0 ? (totalSpend / totalImpressions) * 1000 : 0;

                // Salva filtered per modale anteprima
                state.filteredAdsForPreview = filtered;

                // Macro stats
                html += '<div class="stats-grid" style="margin-bottom:20px;">';
                html += '<div class="stat-card"><div class="stat-label">üí∞ Spesa Totale</div>';
                html += '<div class="stat-value">‚Ç¨' + totalSpend.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</div>';
                html += '<div class="stat-change">' + filtered.length + ' ads</div></div>';

                html += '<div class="stat-card"><div class="stat-label">üõí Conversioni Totali</div>';
                html += '<div class="stat-value">' + totalConversions.toLocaleString('it-IT') + '</div>';
                html += '<div class="stat-change">Purchase totali</div></div>';

                html += '<div class="stat-card"><div class="stat-label">üíµ CPA Medio</div>';
                html += '<div class="stat-value">‚Ç¨' + avgCPA.toFixed(2) + '</div>';
                html += '<div class="stat-change">Costo per conversione</div></div>';

                html += '<div class="stat-card"><div class="stat-label">üìä CPM Medio</div>';
                html += '<div class="stat-value">‚Ç¨' + avgCPM.toFixed(2) + '</div>';
                html += '<div class="stat-change">Costo per 1000 impression</div></div>';

                html += '<div class="stat-card"><div class="stat-label">üìà CTR Medio</div>';
                html += '<div class="stat-value">' + avgCTR.toFixed(2) + '%</div>';
                html += '<div class="stat-change">Click-Through Rate</div></div>';
                html += '</div>';

                // Tabella
                html += '<div style="overflow-x:auto;">';
                html += '<table><thead><tr>';
                html += '<th>Anteprima</th><th>Badge</th><th>Campagna</th><th>Nome Ad</th><th>Stato</th><th>Conversioni</th><th>CPA</th><th>Spesa</th><th>Click</th><th>CTR</th><th>CPM</th>';
                html += '</tr></thead><tbody>';

                for (var i = 0; i < filtered.length; i++) {
                    var ad = filtered[i];

                    // Badge evidenziazione
                    var badges = '';
                    if (topConversions.indexOf(ad.adId) !== -1) {
                        badges += '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:600;margin-right:4px;">üèÜ TOP</span>';
                    }
                    if (bestCPA.indexOf(ad.adId) !== -1) {
                        badges += '<span style="background:#3b82f6;color:white;padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:600;">üí∞ BEST CPA</span>';
                    }

                    // Stato
                    var statusBadge = '';
                    var statusColor = '';
                    if (ad.adStatus === 'ACTIVE') {
                        statusColor = '#22c55e';
                        statusBadge = '‚úÖ Attiva';
                    } else if (ad.adStatus === 'PAUSED') {
                        statusColor = '#f59e0b';
                        statusBadge = '‚è∏Ô∏è Pausa';
                    } else if (ad.adStatus === 'ARCHIVED') {
                        statusColor = '#6b7280';
                        statusBadge = 'üì¶ Archiviata';
                    } else {
                        statusColor = '#ef4444';
                        statusBadge = '‚ùå Altro';
                    }

                    html += '<tr>';
                    // Bottone anteprima
                    html += '<td style="text-align:center;">';
                    if (ad.creative.imageUrl || ad.creative.title || ad.creative.body) {
                        html += '<button onclick="openCreativePreview(' + i + ')" style="background:#a855f7;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:1.2rem;" title="Visualizza anteprima">üëÅÔ∏è</button>';
                    } else {
                        html += '<span style="color:#6b7280;">-</span>';
                    }
                    html += '</td>';
                    html += '<td style="white-space:nowrap;">' + (badges || '-') + '</td>';
                    html += '<td style="font-size:0.875rem;color:#9ca3af;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="' + ad.campaignName + '">' + ad.campaignName + '</td>';
                    html += '<td><strong>' + ad.adName + '</strong></td>';
                    html += '<td><span style="color:' + statusColor + ';font-weight:600;font-size:0.875rem;">' + statusBadge + '</span></td>';
                    html += '<td><strong style="color:#22c55e;font-size:1.1rem;">' + (ad.metrics.conversions || 0) + '</strong></td>';
                    html += '<td><strong>‚Ç¨' + (ad.metrics.costPerConversion || 0).toFixed(2) + '</strong></td>';
                    html += '<td>‚Ç¨' + (ad.metrics.spend || 0).toFixed(2) + '</td>';
                    html += '<td>' + (ad.metrics.clicks || 0) + '</td>';
                    html += '<td>' + (ad.metrics.ctr || 0).toFixed(2) + '%</td>';
                    html += '<td>‚Ç¨' + (ad.metrics.cpm || 0).toFixed(2) + '</td>';
                    html += '</tr>';
                }

                html += '</tbody></table>';
                html += '<p style="color:#9ca3af;font-size:0.875rem;margin-top:16px;">';
                html += 'üìä Mostrando <strong>' + filtered.length + '</strong> ads su ' + state.adsData.length + ' totali';
                html += '</p>';
                html += '</div>';
            } else {
                html += '<div class="empty-state"><div class="empty-state-icon">üé®</div>';
                html += '<p><strong>Nessuna creativit√† trovata</strong></p>';
                html += '<p style="font-size: 0.875rem; margin-top: 8px;">Sincronizza i dati per vedere le creativit√†</p>';
                html += '<button onclick="syncData()" class="btn-primary" style="margin-top: 20px;">üîÑ Sincronizza Ora</button>';
                html += '</div>';
            }
            html += '</div>';

            return html;
        }

        // ========== CREATIVE PREVIEW MODAL ==========
        function openCreativePreview(index) {
            if (!state.filteredAdsForPreview || !state.filteredAdsForPreview[index]) {
                console.error('Ad non trovata:', index);
                return;
            }

            var ad = state.filteredAdsForPreview[index];
            state.currentCreativePreview = ad;
            render();
        }

        function closeCreativePreview() {
            state.currentCreativePreview = null;
            render();
        }

        function renderCreativePreviewModal() {
            if (!state.currentCreativePreview) return '';

            var ad = state.currentCreativePreview;
            var html = '';

            // Overlay modale
            html += '<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10000;" onclick="closeCreativePreview()">';

            // Contenuto modale (evita chiusura al click interno)
            html += '<div onclick="event.stopPropagation()" style="background:linear-gradient(135deg, #334155 0%, #475569 100%);border:2px solid rgba(168,85,247,0.5);border-radius:16px;padding:32px;max-width:800px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);">';

            // Header
            html += '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:24px;">';
            html += '<h2 style="color:white;margin:0;font-size:1.5rem;">üé® Anteprima Creativit√†</h2>';
            html += '<button onclick="closeCreativePreview()" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:1.2rem;" title="Chiudi">‚úñÔ∏è</button>';
            html += '</div>';

            // Nome Ad
            html += '<div style="margin-bottom:20px;">';
            html += '<div style="color:#9ca3af;font-size:0.875rem;margin-bottom:4px;">Nome Inserzione</div>';
            html += '<div style="color:white;font-size:1.1rem;font-weight:600;">' + ad.adName + '</div>';
            html += '</div>';

            // Campagna
            html += '<div style="margin-bottom:20px;">';
            html += '<div style="color:#9ca3af;font-size:0.875rem;margin-bottom:4px;">Campagna</div>';
            html += '<div style="color:white;">' + ad.campaignName + '</div>';
            html += '</div>';

            // Immagine
            if (ad.creative.imageUrl) {
                html += '<div style="margin-bottom:20px;">';
                html += '<div style="color:#9ca3af;font-size:0.875rem;margin-bottom:8px;">üñºÔ∏è Immagine Creativit√†</div>';
                html += '<img src="' + ad.creative.imageUrl + '" style="max-width:100%;border-radius:8px;border:1px solid rgba(255,255,255,0.2);" onerror="this.style.display=\'none\'">';
                html += '</div>';
            }

            // Titolo
            if (ad.creative.title) {
                html += '<div style="margin-bottom:20px;">';
                html += '<div style="color:#9ca3af;font-size:0.875rem;margin-bottom:4px;">üìù Titolo</div>';
                html += '<div style="color:white;background:rgba(255,255,255,0.05);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);">' + ad.creative.title + '</div>';
                html += '</div>';
            }

            // Body
            if (ad.creative.body) {
                html += '<div style="margin-bottom:20px;">';
                html += '<div style="color:#9ca3af;font-size:0.875rem;margin-bottom:4px;">üí¨ Testo</div>';
                html += '<div style="color:white;background:rgba(255,255,255,0.05);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);white-space:pre-wrap;">' + ad.creative.body + '</div>';
                html += '</div>';
            }

            // Metriche
            html += '<div style="margin-top:24px;padding-top:24px;border-top:1px solid rgba(255,255,255,0.1);">';
            html += '<div style="color:#9ca3af;font-size:0.875rem;margin-bottom:12px;">üìä Performance</div>';
            html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;">';

            html += '<div style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);padding:12px;border-radius:8px;">';
            html += '<div style="color:#9ca3af;font-size:0.75rem;">Conversioni</div>';
            html += '<div style="color:#22c55e;font-size:1.25rem;font-weight:600;">' + (ad.metrics.conversions || 0) + '</div>';
            html += '</div>';

            html += '<div style="background:rgba(168,85,247,0.1);border:1px solid rgba(168,85,247,0.3);padding:12px;border-radius:8px;">';
            html += '<div style="color:#9ca3af;font-size:0.75rem;">CPA</div>';
            html += '<div style="color:#a855f7;font-size:1.25rem;font-weight:600;">‚Ç¨' + (ad.metrics.costPerConversion || 0).toFixed(2) + '</div>';
            html += '</div>';

            html += '<div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);padding:12px;border-radius:8px;">';
            html += '<div style="color:#9ca3af;font-size:0.75rem;">Spesa</div>';
            html += '<div style="color:#3b82f6;font-size:1.25rem;font-weight:600;">‚Ç¨' + (ad.metrics.spend || 0).toFixed(2) + '</div>';
            html += '</div>';

            html += '<div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);padding:12px;border-radius:8px;">';
            html += '<div style="color:#9ca3af;font-size:0.75rem;">CTR</div>';
            html += '<div style="color:#f59e0b;font-size:1.25rem;font-weight:600;">' + (ad.metrics.ctr || 0).toFixed(2) + '%</div>';
            html += '</div>';

            html += '</div>';
            html += '</div>';

            html += '</div>';
            html += '</div>';

            return html;
        }

        // ========== OFFERS ==========
        function renderOffers() {
            var html = '';

            html += '<div class="card"><div class="card-title">';
            html += '<span>üí∞ Offerte - Performance Dettagliata</span>';
            html += '<button onclick="syncData()" class="btn-primary">üîÑ Aggiorna</button>';
            html += '</div>';

            if (state.matchedData && state.matchedData.length > 0) {
                // FILTRI
                if (!state.offersFilters) {
                    state.offersFilters = {
                        sortBy: 'roi', // roi, revenue, approved, spend
                        sortOrder: 'desc', // asc, desc
                        filterCampaignStatus: 'all', // all, active, paused
                        searchQuery: '' // ricerca per nome
                    };
                }

                // CAMPO RICERCA
                html += '<div style="margin-bottom:16px">';
                html += '<input type="text" placeholder="üîç Cerca offerta o campagna..." value="' + (state.offersFilters.searchQuery || '') + '" ';
                html += 'oninput="debouncedOffersSearch(this.value)" ';
                html += 'style="width:100%;max-width:500px;padding:12px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);';
                html += 'background:rgba(255,255,255,0.1);color:white;font-size:16px">';
                html += '</div>';

                html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:20px;padding:16px;background:rgba(255,255,255,0.03);border-radius:8px">';

                // Filtro Stato Campagne
                html += '<div>';
                html += '<label style="display:block;color:#9ca3af;font-size:0.75rem;margin-bottom:6px;font-weight:600">üîå STATO CAMPAGNE</label>';
                html += '<select onchange="updateOffersFilter(\'filterCampaignStatus\', this.value)" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);color:white;font-size:0.875rem">';
                html += '<option value="all" ' + (state.offersFilters.filterCampaignStatus === 'all' ? 'selected' : '') + '>Tutte</option>';
                html += '<option value="active" ' + (state.offersFilters.filterCampaignStatus === 'active' ? 'selected' : '') + '>‚úÖ Solo Attive</option>';
                html += '<option value="paused" ' + (state.offersFilters.filterCampaignStatus === 'paused' ? 'selected' : '') + '>‚è∏Ô∏è Solo Spente</option>';
                html += '</select></div>';

                // Filtro Ordinamento
                html += '<div>';
                html += '<label style="display:block;color:#9ca3af;font-size:0.75rem;margin-bottom:6px;font-weight:600">üìä ORDINA PER</label>';
                html += '<select onchange="updateOffersFilter(\'sortBy\', this.value)" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);color:white;font-size:0.875rem">';
                html += '<option value="roi" ' + (state.offersFilters.sortBy === 'roi' ? 'selected' : '') + '>ROI</option>';
                html += '<option value="revenue" ' + (state.offersFilters.sortBy === 'revenue' ? 'selected' : '') + '>üí∞ Revenue</option>';
                html += '<option value="approved" ' + (state.offersFilters.sortBy === 'approved' ? 'selected' : '') + '>‚úÖ Approvate</option>';
                html += '<option value="spend" ' + (state.offersFilters.sortBy === 'spend' ? 'selected' : '') + '>üíµ Spesa</option>';
                html += '</select></div>';

                // Filtro Direzione
                html += '<div>';
                html += '<label style="display:block;color:#9ca3af;font-size:0.75rem;margin-bottom:6px;font-weight:600">üîÑ DIREZIONE</label>';
                html += '<select onchange="updateOffersFilter(\'sortOrder\', this.value)" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);color:white;font-size:0.875rem">';
                html += '<option value="desc" ' + (state.offersFilters.sortOrder === 'desc' ? 'selected' : '') + '>‚¨áÔ∏è Dal pi√π alto</option>';
                html += '<option value="asc" ' + (state.offersFilters.sortOrder === 'asc' ? 'selected' : '') + '>‚¨ÜÔ∏è Dal pi√π basso</option>';
                html += '</select></div>';

                // Reset filtri
                html += '<div style="display:flex;align-items:flex-end">';
                html += '<button onclick="resetOffersFilters()" class="btn-secondary" style="width:100%;padding:8px 12px;font-size:0.875rem">üîÑ Reset Filtri</button>';
                html += '</div>';

                html += '</div>';

                // Applica filtri alle offerte
                var filteredOffers = state.matchedData.slice();

                // Filtra per ricerca
                if (state.offersFilters.searchQuery && state.offersFilters.searchQuery.trim()) {
                    var searchLower = state.offersFilters.searchQuery.toLowerCase();
                    filteredOffers = filteredOffers.filter(function(offer) {
                        // Cerca nel nome offerta
                        if (offer.offerName.toLowerCase().includes(searchLower)) return true;
                        // Cerca nei nomi delle campagne
                        return offer.campaigns.some(function(c) {
                            return c.name.toLowerCase().includes(searchLower);
                        });
                    });
                }

                // Filtra per stato campagne
                if (state.offersFilters.filterCampaignStatus !== 'all') {
                    filteredOffers = filteredOffers.filter(function(offer) {
                        // Controlla se ha almeno una campagna con lo stato richiesto
                        return offer.campaigns.some(function(campaign) {
                            var status = (campaign.effective_status || campaign.status || '').toUpperCase();
                            if (state.offersFilters.filterCampaignStatus === 'active') {
                                return status === 'ACTIVE';
                            } else if (state.offersFilters.filterCampaignStatus === 'paused') {
                                return status !== 'ACTIVE';
                            }
                            return true;
                        });
                    });
                }

                // Ordina
                filteredOffers.sort(function(a, b) {
                    var valueA, valueB;

                    if (state.offersFilters.sortBy === 'roi') {
                        valueA = a.roi || 0;
                        valueB = b.roi || 0;
                    } else if (state.offersFilters.sortBy === 'revenue') {
                        valueA = a.revenue || 0;
                        valueB = b.revenue || 0;
                    } else if (state.offersFilters.sortBy === 'approved') {
                        valueA = a.approved || 0;
                        valueB = b.approved || 0;
                    } else if (state.offersFilters.sortBy === 'spend') {
                        valueA = a.totalSpend || 0;
                        valueB = b.totalSpend || 0;
                    }

                    if (state.offersFilters.sortOrder === 'desc') {
                        return valueB - valueA;
                    } else {
                        return valueA - valueB;
                    }
                });

                html += '<div style="overflow-x: auto;">';
                html += '<table><thead><tr>';
                html += '<th>ID</th><th>Nome Offerta</th>';
                html += '<th>üîå Stato Campagne</th>';
                html += '<th>Spesa ADV</th><th>Acquisti ADV</th>';
                html += '<th style="background: rgba(34, 197, 94, 0.1);">‚úÖ Approvate</th>';
                html += '<th style="background: rgba(251, 191, 36, 0.1);">‚è≥ Pending</th>';
                html += '<th style="background: rgba(239, 68, 68, 0.1);">‚ùå Annullate</th>';
                html += '<th style="background: rgba(168, 85, 247, 0.1);">üîÅ Doppie</th>';
                html += '<th style="background: rgba(107, 114, 128, 0.1);">üóëÔ∏è Trash</th>';
                html += '<th style="background: rgba(34, 197, 94, 0.1);"><strong>üéØ CPA Goal</strong></th>';
                html += '<th style="background: rgba(239, 68, 68, 0.1);"><strong>üìä CPA Reale</strong></th>';
                html += '<th style="background: rgba(168, 85, 247, 0.1);"><strong>üí∞ CPA Pagata</strong></th>';
                html += '<th style="background: rgba(59, 130, 246, 0.15);"><strong>üíµ Revenue</strong></th>';
                html += '<th style="background: rgba(34, 197, 94, 0.15);"><strong>üí∞ Profit</strong></th>';
                html += '<th style="background: rgba(251, 191, 36, 0.15);"><strong>üìà ROI</strong></th>';
                html += '<th style="background: rgba(168, 85, 247, 0.15);"><strong>üíé ROAS</strong></th>';
                html += '</tr></thead><tbody>';

                filteredOffers.forEach(function(offer) {
                    // Conta campagne per stato
                    var activeCount = 0;
                    var pausedCount = 0;
                    var archivedCount = 0;
                    var unknownCount = 0;

                    offer.campaigns.forEach(function(c) {
                        var status = (c.effective_status || c.status || 'UNKNOWN').toUpperCase();
                        if (status === 'ACTIVE') {
                            activeCount++;
                        } else if (status === 'PAUSED') {
                            pausedCount++;
                        } else if (status === 'ARCHIVED') {
                            archivedCount++;
                        } else {
                            unknownCount++;
                        }
                    });
                    // Usa profit salvato o ricalcolalo per retrocompatibilit√†
                    var profit = offer.profit !== undefined ? offer.profit : (offer.revenue - offer.totalSpend);

                    // CPA Goal: priorit√† al goal personalizzato, altrimenti usa CPA dall'API
                    var cpaGoal = 0;
                    if (state.offersGoals[offer.offerId]) {
                        // Goal personalizzato dall'utente
                        cpaGoal = state.offersGoals[offer.offerId];
                    } else {
                        // Fallback: usa CPA dall'API /offers
                        var refOffer = state.offersReference[offer.offerId];
                        if (refOffer && refOffer.payout) {
                            cpaGoal = refOffer.payout;
                        }
                    }

                    // CPA Reale = Quanto SPENDI per conversione (Spesa ADV / Approvati)
                    var cpaReale = 0;
                    if (offer.approved > 0) {
                        cpaReale = offer.totalSpend / offer.approved;
                    }

                    // CPA Pagata = Quanto TI PAGANO per conversione (Revenue / Approvati)
                    var cpaPagata = 0;
                    if (offer.approved > 0) {
                        cpaPagata = offer.revenue / offer.approved;
                    }

                    // Differenze per confronto
                    var diffRealeVsGoal = cpaReale - cpaGoal; // Meglio se negativo (spendi meno del goal)
                    var diffPagataVsReale = cpaPagata - cpaReale; // Meglio se positivo (ti pagano pi√π di quanto spendi)
                    var colorRealeVsGoal = diffRealeVsGoal <= 0 ? '#22c55e' : '#ef4444';
                    var colorPagataVsReale = diffPagataVsReale >= 0 ? '#22c55e' : '#ef4444';

                    html += '<tr>';
                    html += '<td><strong>' + offer.offerId + '</strong></td>';
                    html += '<td>' + offer.offerName + '</td>';
                    // Colonna Stato Campagne
                    html += '<td style="padding:4px;white-space:nowrap;">';
                    if (activeCount > 0) {
                        html += '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:600;margin-right:4px;">‚úÖ ' + activeCount + '</span>';
                    }
                    if (pausedCount > 0) {
                        html += '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:600;margin-right:4px;">‚è∏Ô∏è ' + pausedCount + '</span>';
                    }
                    if (archivedCount > 0) {
                        html += '<span style="background:#9ca3af;color:white;padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:600;margin-right:4px;">üì¶ ' + archivedCount + '</span>';
                    }
                    if (unknownCount > 0) {
                        html += '<span style="background:#ef4444;color:white;padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:600;">‚ùå ' + unknownCount + '</span>';
                    }
                    if (activeCount === 0 && pausedCount === 0 && archivedCount === 0 && unknownCount === 0) {
                        html += '<span style="color:#9ca3af;font-size:0.75rem;">Nessuna</span>';
                    }
                    html += '</td>';
                    html += '<td>‚Ç¨' + offer.totalSpend.toFixed(2) + '<br>';
                    if (offer.platformBreakdown.meta > 0) html += '<span class="platform-badge platform-meta" style="font-size:0.7rem;margin-right:4px;">‚Ç¨' + offer.platformBreakdown.meta.toFixed(0) + '</span>';
                    if (offer.platformBreakdown.google > 0) html += '<span class="platform-badge platform-google" style="font-size:0.7rem;margin-right:4px;">‚Ç¨' + offer.platformBreakdown.google.toFixed(0) + '</span>';
                    if (offer.platformBreakdown.tiktok > 0) html += '<span class="platform-badge platform-tiktok" style="font-size:0.7rem;">‚Ç¨' + offer.platformBreakdown.tiktok.toFixed(0) + '</span>';
                    html += '</td>';
                    html += '<td>' + offer.totalPurchases + '</td>';
                    html += '<td><strong style="color:#22c55e;">' + offer.approved + '</strong></td>';
                    html += '<td style="color:#fbbf24;">' + offer.pending + '</td>';
                    html += '<td style="color:#ef4444;">' + offer.cancelled + '</td>';
                    html += '<td style="color:#a855f7;">' + offer.doubleLead + '</td>';
                    html += '<td style="color:#6b7280;">' + offer.trash + '</td>';
                    // CPA Goal (editabile)
                    html += '<td style="padding:8px;">';
                    html += '<div style="display:flex;align-items:center;gap:4px;">';
                    html += '<input type="number" step="0.01" min="0" value="' + cpaGoal.toFixed(2) + '" ';
                    html += 'id="goal-' + offer.offerId + '" ';
                    html += 'style="width:80px;padding:4px 6px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);color:white;border-radius:4px;font-size:0.9rem;" ';
                    html += 'onkeypress="if(event.key===\'Enter\') saveGoalFromInput(\'' + offer.offerId + '\')" />';
                    html += '<button onclick="saveGoalFromInput(\'' + offer.offerId + '\')" ';
                    html += 'style="padding:4px 8px;background:#22c55e;border:none;border-radius:4px;color:white;cursor:pointer;font-size:0.8rem;" ';
                    html += 'title="Salva CPA Goal">üíæ</button>';
                    html += '</div></td>';
                    // CPA Reale (quanto SPENDI) con differenza vs Goal
                    html += '<td><strong style="font-size:1rem;color:#ef4444;">‚Ç¨' + cpaReale.toFixed(2) + '</strong>';
                    if (cpaGoal > 0) {
                        html += '<br><span style="font-size:0.75rem;color:' + colorRealeVsGoal + ';">';
                        html += (diffRealeVsGoal >= 0 ? '+' : '') + diffRealeVsGoal.toFixed(2);
                        html += '</span>';
                    }
                    html += '</td>';
                    // CPA Pagata (quanto TI PAGANO) con differenza vs CPA Reale
                    html += '<td><strong style="font-size:1rem;color:#a855f7;">‚Ç¨' + cpaPagata.toFixed(2) + '</strong>';
                    if (cpaReale > 0) {
                        html += '<br><span style="font-size:0.75rem;color:' + colorPagataVsReale + ';">';
                        html += (diffPagataVsReale >= 0 ? '+' : '') + diffPagataVsReale.toFixed(2);
                        html += '</span>';
                    }
                    html += '</td>';
                    html += '<td><strong style="font-size:1.1rem;">‚Ç¨' + offer.revenue.toFixed(2) + '</strong></td>';
                    html += '<td><strong style="color:' + (profit >= 0 ? '#22c55e' : '#ef4444') + ';font-size:1.1rem;">‚Ç¨' + profit.toFixed(2) + '</strong></td>';
                    html += '<td><strong style="color:' + (offer.roi > 0 ? '#22c55e' : '#ef4444') + ';font-size:1.1rem;">' + offer.roi.toFixed(2) + '%</strong></td>';
                    html += '<td><strong style="font-size:1.1rem;">' + offer.roas.toFixed(2) + 'x</strong></td>';
                    html += '</tr>';
                    
                    if (offer.campaigns.length > 0) {
                        html += '<tr style="background: rgba(255,255,255,0.03);"><td colspan="16">';
                        html += '<details style="cursor:pointer;"><summary style="color:#9ca3af;font-size:0.875rem;padding:8px;">üìã ' + offer.campaigns.length + ' campagne associate</summary>';
                        html += '<div style="margin-top:8px;padding-left:16px;">';
                        offer.campaigns.forEach(function(c) {
                            // Determina stato campagna
                            var campaignStatus = (c.effective_status || c.status || 'UNKNOWN').toUpperCase();
                            var statusBadge = '';
                            var statusColor = '';
                            var statusIcon = '';

                            if (campaignStatus === 'ACTIVE') {
                                statusColor = '#22c55e';
                                statusIcon = '‚úÖ';
                                statusBadge = 'ATTIVA';
                            } else if (campaignStatus === 'PAUSED') {
                                statusColor = '#f59e0b';
                                statusIcon = '‚è∏Ô∏è';
                                statusBadge = 'PAUSA';
                            } else if (campaignStatus === 'ARCHIVED') {
                                statusColor = '#9ca3af';
                                statusIcon = 'üì¶';
                                statusBadge = 'ARCHIVIATA';
                            } else {
                                statusColor = '#ef4444';
                                statusIcon = '‚ùå';
                                statusBadge = campaignStatus;
                            }

                            html += '<div style="padding:4px 0;font-size:0.875rem;color:#9ca3af;display:flex;align-items:center;gap:8px;">';
                            html += '<span class="platform-badge platform-' + c.platform + '" style="font-size:0.7rem;">' + c.platform + '</span>';
                            html += '<span style="background:' + statusColor + ';color:white;padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:600;white-space:nowrap;">' + statusIcon + ' ' + statusBadge + '</span>';
                            html += '<span style="flex:1;">' + c.name + ' - ‚Ç¨' + c.spend.toFixed(2) + ' | ' + c.purchases + ' acquisti</span>';
                            html += '</div>';
                        });
                        html += '</div></details></td></tr>';
                    }
                });

                html += '</tbody></table>';
                html += '</div>';

                html += '<div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:8px;padding:16px;margin-top:20px;">';
                html += '<strong>‚ÑπÔ∏è Legenda:</strong><br>';
                html += '<span style="color:#9ca3af;font-size:0.875rem;line-height:1.8;">';
                html += '‚Ä¢ <strong>Spesa ADV</strong>: Totale speso su Meta/Google/TikTok<br>';
                html += '‚Ä¢ <strong>Acquisti ADV</strong>: Conversioni tracciate dalle piattaforme pubblicitarie<br>';
                html += '‚Ä¢ <strong>Approvate/Pending/Annullate/Doppie/Trash</strong>: Lead da Traffic Manager<br>';
                html += '‚Ä¢ <strong>CPA Goal</strong>: üéØ Il tuo CPA obiettivo (personalizzabile, usa CPA dall\'API come default)<br>';
                html += '‚Ä¢ <strong>CPA Reale</strong>: üìä Quanto SPENDI per conversione (Spesa ADV / Approvate) - confronto con Goal<br>';
                html += '‚Ä¢ <strong>CPA Pagata</strong>: üí∞ Quanto TI PAGANO per conversione (Revenue / Approvate) - confronto con CPA Reale<br>';
                html += '‚Ä¢ <strong>Revenue</strong>: Commissioni totali approvate da Traffic Manager<br>';
                html += '‚Ä¢ <strong>Profit</strong>: Revenue - Spesa ADV<br>';
                html += '‚Ä¢ <strong>ROI</strong>: (Revenue - Spesa) / Spesa √ó 100<br>';
                html += '‚Ä¢ <strong>ROAS</strong>: Revenue / Spesa';
                html += '</span></div>';
                
            } else {
                html += '<div class="empty-state"><div class="empty-state-icon">üí∞</div>';
                html += '<p><strong>Nessun dato disponibile</strong></p>';
                html += '<p style="font-size:0.875rem;margin-top:8px;">Clicca "Sync Ora"</p></div>';
            }
            html += '</div>';

            return html;
        }

        // Funzione per salvare il CPA Goal dall'input della tabella
        async function saveGoalFromInput(offerId) {
            var input = document.getElementById('goal-' + offerId);
            if (!input) return;

            var value = input.value;
            var success = await saveOfferGoal(offerId, value);

            if (success) {
                // Feedback visivo
                var originalBg = input.style.background;
                input.style.background = 'rgba(34, 197, 94, 0.3)';
                setTimeout(function() {
                    input.style.background = originalBg;
                }, 500);

                // Re-render per aggiornare la differenza
                render();
            }
        }

        //PART 4
        // ========== SETTINGS ==========
        function renderSettings() {
            var html = '';
            var i, j, k, acc;

            // INFO ALERT: Nuovo flusso centralizzato
            html += '<div style="background:rgba(34,197,94,0.2);border:1px solid #22c55e;border-radius:12px;padding:20px;margin-bottom:30px;">';
            html += '<div style="display:flex;align-items:center;gap:16px;margin-bottom:12px;">';
            html += '<div style="font-size:2rem;">‚ÑπÔ∏è</div>';
            html += '<div><strong style="font-size:1.25rem;">Gestione Account Centralizzata</strong></div>';
            html += '</div>';
            html += '<p style="color:#9ca3af;line-height:1.6;margin-bottom:16px;">';
            html += 'Gli account social vengono ora gestiti tramite il <strong>Social Accounts Manager</strong>. ';
            html += 'Qui puoi solo <strong>selezionare quali account usare</strong> per il tracking.';
            html += '</p>';
            html += '<a href="social-accounts-manager.html" style="display:inline-block;background:linear-gradient(to right,#22c55e,#10b981);color:white;padding:12px 24px;border-radius:8px;font-weight:600;text-decoration:none;transition:transform 0.2s;" onmouseover="this.style.transform=\'translateY(-2px)\'" onmouseout="this.style.transform=\'translateY(0)\'">';
            html += '<span style="font-size:1.1rem;">üëâ Apri Social Accounts Manager</span>';
            html += '</a>';
            html += '</div>';

            // TRAFFIC MANAGER
            html += '<div class="card">';
            html += '<div class="card-title"><span>üîë Traffic Manager</span>';
            html += '<span style="font-size: 0.875rem; color: #22c55e;">‚úÖ Connesso</span></div>';
            html += '<div class="form-grid">';
            html += '<div><label class="form-label">User ID</label>';
            html += '<input type="text" value="' + TRAFFIC_MANAGER.userId + '" disabled></div>';
            html += '<div><label class="form-label">API Key</label>';
            html += '<input type="password" value="' + TRAFFIC_MANAGER.apiKey + '" disabled></div>';
            html += '</div></div>';
            
            // META ADS
            html += '<div class="card">';
            html += '<div class="card-title">';
            html += '<span>üìò Meta Ads - Account Multipli</span>';
            html += '<span style="font-size:0.875rem;color:#9ca3af;">Gestiti in Social Accounts Manager</span>';
            html += '</div>';

            if (state.socialCredentials.meta.length > 0) {
                html += '<table><thead><tr><th>Usa per Tracking</th><th>Nome Account</th><th>Account ID</th><th>Token</th></tr></thead><tbody>';
                for (i = 0; i < state.socialCredentials.meta.length; i++) {
                    acc = state.socialCredentials.meta[i];
                    html += '<tr><td><input type="checkbox" ';
                    if (state.selectedAccounts.meta.indexOf(acc.id) > -1) html += 'checked ';
                    html += 'onclick="toggleMetaAccount(\'' + acc.id + '\')"></td>';
                    html += '<td><strong>' + acc.name + '</strong></td>';
                    html += '<td>' + acc.accountId + '</td>';
                    html += '<td>****' + acc.accessToken.slice(-8) + '</td>';
                    html += '</tr>';
                }
                html += '</tbody></table>';
                html += '<p style="color:#9ca3af;font-size:0.875rem;margin-top:12px">‚úì Seleziona gli account da sincronizzare</p>';
            } else {
                html += '<div style="text-align:center;padding:20px;">';
                html += '<p style="color:#9ca3af;margin-bottom:16px;">Nessun account configurato</p>';
                html += '<a href="social-accounts-manager.html" class="btn-primary" style="display:inline-block;text-decoration:none;">‚ûï Aggiungi Account Meta</a>';
                html += '</div>';
            }
            html += '</div>';

            // GOOGLE ADS
            html += '<div class="card">';
            html += '<div class="card-title">';
            html += '<span>üî¥ Google Ads - Account Multipli</span>';
            html += '<span style="font-size:0.875rem;color:#9ca3af;">Gestiti in Social Accounts Manager</span>';
            html += '</div>';

            if (state.socialCredentials.google.length > 0) {
                html += '<table><thead><tr><th>Usa per Tracking</th><th>Nome Account</th><th>Customer ID</th></tr></thead><tbody>';
                for (j = 0; j < state.socialCredentials.google.length; j++) {
                    acc = state.socialCredentials.google[j];
                    html += '<tr><td><input type="checkbox" ';
                    if (state.selectedAccounts.google.indexOf(acc.id) > -1) html += 'checked ';
                    html += 'onclick="toggleGoogleAccount(\'' + acc.id + '\')"></td>';
                    html += '<td><strong>' + acc.name + '</strong></td>';
                    html += '<td>' + (acc.customerId || acc.accountId) + '</td>';
                    html += '</tr>';
                }
                html += '</tbody></table>';
                html += '<p style="color:#9ca3af;font-size:0.875rem;margin-top:12px">‚úì Seleziona gli account da sincronizzare</p>';
            } else {
                html += '<div style="text-align:center;padding:20px;">';
                html += '<p style="color:#9ca3af;margin-bottom:16px;">Nessun account configurato</p>';
                html += '<a href="social-accounts-manager.html" class="btn-primary" style="display:inline-block;text-decoration:none;">‚ûï Aggiungi Account Google</a>';
                html += '</div>';
            }
            html += '</div>';

            // TIKTOK ADS
            html += '<div class="card">';
            html += '<div class="card-title">';
            html += '<span>üéµ TikTok Ads - Account Multipli</span>';
            html += '<span style="font-size:0.875rem;color:#9ca3af;">Gestiti in Social Accounts Manager</span>';
            html += '</div>';

            if (state.socialCredentials.tiktok.length > 0) {
                html += '<table><thead><tr><th>Usa per Tracking</th><th>Nome Account</th><th>Advertiser ID</th></tr></thead><tbody>';
                for (k = 0; k < state.socialCredentials.tiktok.length; k++) {
                    acc = state.socialCredentials.tiktok[k];
                    html += '<tr><td><input type="checkbox" ';
                    if (state.selectedAccounts.tiktok.indexOf(acc.id) > -1) html += 'checked ';
                    html += 'onclick="toggleTikTokAccount(\'' + acc.id + '\')"></td>';
                    html += '<td><strong>' + acc.name + '</strong></td>';
                    html += '<td>' + (acc.advertiserId || acc.accountId) + '</td>';
                    html += '</tr>';
                }
                html += '</tbody></table>';
                html += '<p style="color:#9ca3af;font-size:0.875rem;margin-top:12px">‚úì Seleziona gli account da sincronizzare</p>';
            } else {
                html += '<div style="text-align:center;padding:20px;">';
                html += '<p style="color:#9ca3af;margin-bottom:16px;">Nessun account configurato</p>';
                html += '<a href="social-accounts-manager.html" class="btn-primary" style="display:inline-block;text-decoration:none;">‚ûï Aggiungi Account TikTok</a>';
                html += '</div>';
            }
            html += '</div>';

            // SAVE BUTTON
            html += '<div style="text-align:right;margin-top:20px">';
            html += '<button onclick="saveSocialCredentials()" class="btn-primary">üíæ Salva Tutte le Credenziali</button>';
            html += '</div>';
            
            // INFO BOX
            html += '<div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:12px;padding:20px;margin-top:30px">';
            html += '<h3 style="margin-bottom:12px">‚ÑπÔ∏è Come funziona</h3>';
            html += '<ul style="color:#9ca3af;font-size:0.875rem;line-height:1.8;padding-left:20px">';
            html += '<li><strong>Gestisci account:</strong> Usa il <strong>Social Accounts Manager</strong> per aggiungere o rimuovere account social</li>';
            html += '<li><strong>Seleziona con checkbox:</strong> Qui scegli quali account usare per il tracking delle campagne</li>';
            html += '<li><strong>Matching automatico:</strong> Le campagne vengono matchate con le offerte tramite ID (es: "1949-Nome Campagna")</li>';
            html += '<li><strong>Sync ogni 30 min:</strong> I dati si aggiornano automaticamente</li>';
            html += '<li><strong>Visualizzazione completa:</strong> Nella tab "Offerte" vedi tutti i dati aggregati con ROI e ROAS</li>';
            html += '</ul></div>';
            
            return html;
        }

        // ========== ALERT & TREND DETECTION ==========
        function renderAlerts() {
            var html = '';

            html += '<div style="margin-bottom:30px">';
            html += '<h2 style="font-size:1.75rem;margin-bottom:8px">üîî Alert & Trend Detection</h2>';
            html += '<p style="color:#9ca3af">Monitora campagne a rischio e trend performance</p>';
            html += '</div>';

            // CONFIGURAZIONE TELEGRAM REPORTS
            html += '<div class="card" style="margin-bottom:30px;border:2px solid #3b82f6">';
            html += '<div class="card-title" style="color:#3b82f6">üì± Configurazione Notifiche Telegram</div>';
            html += '<p style="color:#9ca3af;margin-bottom:20px">Ricevi report automatici delle campagne ogni 3 ore e report settimanale la domenica alle 12:00</p>';

            html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px">';

            // Input manuale Chat ID
            html += '<div>';
            html += '<label style="display:block;color:#fff;font-weight:600;margin-bottom:8px">üì¨ Chat ID</label>';
            html += '<input type="text" id="telegramChatId" placeholder="-1001234567890" ';
            html += 'style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);color:white;font-size:14px">';
            html += '<p style="color:#9ca3af;font-size:0.875rem;margin-top:4px">Inserisci l\'ID della chat Telegram</p>';
            html += '</div>';

            // Input manuale Chat Name
            html += '<div>';
            html += '<label style="display:block;color:#fff;font-weight:600;margin-bottom:8px">üí¨ Nome Chat (opzionale)</label>';
            html += '<input type="text" id="telegramChatName" placeholder="Nome della chat" ';
            html += 'style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);color:white;font-size:14px">';
            html += '<p style="color:#9ca3af;font-size:0.875rem;margin-top:4px">Nome descrittivo (es. "Gruppo Marketing")</p>';
            html += '</div>';

            // Toggle Notifiche Giornaliere
            html += '<div>';
            html += '<label style="display:block;color:#fff;font-weight:600;margin-bottom:8px">üìÖ Report Giornalieri</label>';
            html += '<div style="display:flex;align-items:center;gap:12px">';
            html += '<label class="switch"><input type="checkbox" id="dailyReportsToggle" checked><span class="slider"></span></label>';
            html += '<span style="color:#9ca3af">Ogni 3 ore con dati ultime 24h</span>';
            html += '</div></div>';

            // Toggle Notifiche Settimanali
            html += '<div>';
            html += '<label style="display:block;color:#fff;font-weight:600;margin-bottom:8px">üìä Report Settimanale</label>';
            html += '<div style="display:flex;align-items:center;gap:12px">';
            html += '<label class="switch"><input type="checkbox" id="weeklyReportsToggle" checked><span class="slider"></span></label>';
            html += '<span style="color:#9ca3af">Domenica alle 12:00 (Lun-Dom)</span>';
            html += '</div></div>';

            html += '</div>';

            // Pulsanti Azione
            html += '<div style="display:flex;gap:12px;margin-top:20px;flex-wrap:wrap">';
            html += '<button onclick="saveTelegramReportConfig()" class="btn-primary">üíæ Salva Configurazione</button>';
            html += '<button onclick="testTelegramReport()" class="btn-secondary">üß™ Test Notifica</button>';
            html += '<button onclick="showChatIdHelp()" class="btn-secondary">‚ùì Come trovare Chat ID</button>';
            html += '</div>';

            // Info box con istruzioni
            html += '<div style="background:rgba(59,130,246,0.1);border:1px solid #3b82f6;border-radius:8px;padding:16px;margin-top:20px">';
            html += '<div style="font-weight:600;color:#3b82f6;margin-bottom:8px">üí° Come ottenere il Chat ID:</div>';
            html += '<ol style="margin:0;padding-left:20px;color:#9ca3af;font-size:0.875rem;line-height:1.6">';
            html += '<li>Apri Telegram e vai nella chat dove vuoi ricevere i report</li>';
            html += '<li>Cerca il bot <strong>@userinfobot</strong> o <strong>@getidsbot</strong></li>';
            html += '<li>Invia un messaggio al bot</li>';
            html += '<li>Il bot ti risponder√† con il Chat ID (es. -1001234567890)</li>';
            html += '<li>Copia il numero e incollalo nel campo "Chat ID" sopra</li>';
            html += '</ol>';
            html += '</div>';

            html += '</div>';

            // Calcola gli alert
            calculateAlerts();

            // FILTRO RICERCA
            html += '<div style="margin-bottom:24px">';
            html += '<input type="text" id="alertSearchInput" placeholder="üîç Cerca campagna..." value="' + (state.alertSearchFilter || '') + '" ';
            html += 'oninput="updateAlertSearch(this.value)" ';
            html += 'style="width:100%;max-width:400px;padding:12px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);';
            html += 'background:rgba(255,255,255,0.1);color:white;font-size:16px">';
            html += '</div>';

            // Filtra alert in base alla ricerca
            var searchLower = (state.alertSearchFilter || '').toLowerCase();
            var filteredRoiNegativo = state.alerts.roiNegativo.filter(function(alert) {
                return !searchLower || alert.campaign.name.toLowerCase().includes(searchLower) ||
                       alert.campaign.accountName.toLowerCase().includes(searchLower);
            });
            var filteredTrendCalo = state.alerts.trendCalo.filter(function(alert) {
                return !searchLower || alert.campaign.name.toLowerCase().includes(searchLower) ||
                       alert.campaign.accountName.toLowerCase().includes(searchLower);
            });
            var filteredTrendAumento = state.alerts.trendAumento.filter(function(alert) {
                return !searchLower || alert.campaign.name.toLowerCase().includes(searchLower) ||
                       alert.campaign.accountName.toLowerCase().includes(searchLower);
            });

            // STATISTICHE ALERT (con contatori filtrati)
            html += '<div class="stats-grid" style="margin-bottom:30px">';
            html += '<div class="stat-card" style="background:rgba(239,68,68,0.1);border:1px solid #ef4444">';
            html += '<div class="stat-label">‚ö†Ô∏è ROI Negativo</div>';
            html += '<div class="stat-value" style="color:#ef4444">' + filteredRoiNegativo.length + '</div>';
            html += '<div class="stat-change">' + (searchLower ? 'Trovate (su ' + state.alerts.roiNegativo.length + ')' : 'Campagne in perdita') + '</div></div>';

            html += '<div class="stat-card" style="background:rgba(239,68,68,0.1);border:1px solid #f97316">';
            html += '<div class="stat-label">üìâ Trend in Calo</div>';
            html += '<div class="stat-value" style="color:#f97316">' + filteredTrendCalo.length + '</div>';
            html += '<div class="stat-change">' + (searchLower ? 'Trovate (su ' + state.alerts.trendCalo.length + ')' : 'Performance in diminuzione') + '</div></div>';

            html += '<div class="stat-card" style="background:rgba(34,197,94,0.1);border:1px solid #22c55e">';
            html += '<div class="stat-label">üìà Trend in Aumento</div>';
            html += '<div class="stat-value" style="color:#22c55e">' + filteredTrendAumento.length + '</div>';
            html += '<div class="stat-change">' + (searchLower ? 'Trovate (su ' + state.alerts.trendAumento.length + ')' : 'Performance in crescita') + '</div></div>';

            html += '<div class="stat-card" style="background:rgba(59,130,246,0.1);border:1px solid #3b82f6">';
            html += '<div class="stat-label">üéØ Totale Campagne</div>';
            html += '<div class="stat-value" style="color:#3b82f6">' + (state.campaignsData ? state.campaignsData.length : 0) + '</div>';
            html += '<div class="stat-change">Monitorate</div></div>';
            html += '</div>';

            // TUTTE LE CAMPAGNE ATTIVE (spostata in cima)
            var tutteCampagneFiltrate = state.alerts.tutteCampagne.filter(function(alert) {
                return !searchLower || alert.campaign.name.toLowerCase().includes(searchLower) ||
                       alert.campaign.accountName.toLowerCase().includes(searchLower);
            });

            // Inizializza filtri se non esistono
            if (!state.alertFilters) {
                state.alertFilters = {
                    sortBy: 'roi', // roi, revenue, approved, spend
                    sortOrder: 'desc', // asc, desc
                    filterStato: 'all', // all, ottimo, positivo, attenzione, critico
                    filterCampaignStatus: 'all', // all, active, paused
                    searchQuery: '' // ricerca per nome campagna
                };
            }

            // Applica filtro per stato ROI
            if (state.alertFilters.filterStato !== 'all') {
                tutteCampagneFiltrate = tutteCampagneFiltrate.filter(function(alert) {
                    if (state.alertFilters.filterStato === 'ottimo') return alert.roi >= 50;
                    if (state.alertFilters.filterStato === 'positivo') return alert.roi >= 0 && alert.roi < 50;
                    if (state.alertFilters.filterStato === 'attenzione') return alert.roi >= -20 && alert.roi < 0;
                    if (state.alertFilters.filterStato === 'critico') return alert.roi < -20;
                    return true;
                });
            }

            // Applica filtro per stato campagna (Attiva/Spenta)
            if (state.alertFilters.filterCampaignStatus !== 'all') {
                tutteCampagneFiltrate = tutteCampagneFiltrate.filter(function(alert) {
                    var campaignStatus = (alert.campaign.effective_status || alert.campaign.status || '').toUpperCase();
                    if (state.alertFilters.filterCampaignStatus === 'active') {
                        return campaignStatus === 'ACTIVE';
                    } else if (state.alertFilters.filterCampaignStatus === 'paused') {
                        return campaignStatus !== 'ACTIVE';
                    }
                    return true;
                });
            }

            // Applica filtro per ricerca
            if (state.alertFilters.searchQuery && state.alertFilters.searchQuery.trim()) {
                var searchLower = state.alertFilters.searchQuery.toLowerCase();
                tutteCampagneFiltrate = tutteCampagneFiltrate.filter(function(alert) {
                    // Cerca nel nome della campagna o nel nome dell'account
                    return alert.campaign.name.toLowerCase().includes(searchLower) ||
                           (alert.campaign.accountName || '').toLowerCase().includes(searchLower);
                });
            }

            // Applica ordinamento
            tutteCampagneFiltrate.sort(function(a, b) {
                var valueA, valueB;

                if (state.alertFilters.sortBy === 'roi') {
                    valueA = a.roi || 0;
                    valueB = b.roi || 0;
                } else if (state.alertFilters.sortBy === 'revenue') {
                    valueA = a.revenue || 0;
                    valueB = b.revenue || 0;
                } else if (state.alertFilters.sortBy === 'approved') {
                    valueA = a.approved || 0;
                    valueB = b.approved || 0;
                } else if (state.alertFilters.sortBy === 'spend') {
                    valueA = a.campaign.spend || 0;
                    valueB = b.campaign.spend || 0;
                }

                if (state.alertFilters.sortOrder === 'desc') {
                    return valueB - valueA;
                } else {
                    return valueA - valueB;
                }
            });

            if (tutteCampagneFiltrate.length > 0) {
                html += '<div class="card" style="margin-bottom:24px;margin-top:30px;border:2px solid #a855f7">';
                html += '<div class="card-title" style="color:#a855f7">üìä Tutte le Campagne Attive (' + tutteCampagneFiltrate.length + ')</div>';

                // CAMPO RICERCA
                html += '<div style="margin-bottom:16px">';
                html += '<input type="text" placeholder="üîç Cerca campagna o account..." value="' + (state.alertFilters.searchQuery || '') + '" ';
                html += 'oninput="debouncedAlertSearch(this.value)" ';
                html += 'style="width:100%;max-width:500px;padding:12px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);';
                html += 'background:rgba(255,255,255,0.1);color:white;font-size:16px">';
                html += '</div>';

                // FILTRI
                html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:20px;padding:16px;background:rgba(255,255,255,0.03);border-radius:8px">';

                // Filtro Stato ROI
                html += '<div>';
                html += '<label style="display:block;color:#9ca3af;font-size:0.75rem;margin-bottom:6px;font-weight:600">üè∑Ô∏è STATO ROI</label>';
                html += '<select onchange="updateAlertFilter(\'filterStato\', this.value)" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);color:white;font-size:0.875rem">';
                html += '<option value="all" ' + (state.alertFilters.filterStato === 'all' ? 'selected' : '') + '>Tutte</option>';
                html += '<option value="ottimo" ' + (state.alertFilters.filterStato === 'ottimo' ? 'selected' : '') + '>üî• Ottimo (ROI ‚â•50%)</option>';
                html += '<option value="positivo" ' + (state.alertFilters.filterStato === 'positivo' ? 'selected' : '') + '>‚úÖ Positivo (ROI ‚â•0%)</option>';
                html += '<option value="attenzione" ' + (state.alertFilters.filterStato === 'attenzione' ? 'selected' : '') + '>‚ö†Ô∏è Attenzione (ROI <0%)</option>';
                html += '<option value="critico" ' + (state.alertFilters.filterStato === 'critico' ? 'selected' : '') + '>‚ùå Critico (ROI <-20%)</option>';
                html += '</select></div>';

                // Filtro Stato Campagna (Attiva/Spenta)
                html += '<div>';
                html += '<label style="display:block;color:#9ca3af;font-size:0.75rem;margin-bottom:6px;font-weight:600">üîå STATO CAMPAGNA</label>';
                html += '<select onchange="updateAlertFilter(\'filterCampaignStatus\', this.value)" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);color:white;font-size:0.875rem">';
                html += '<option value="all" ' + (state.alertFilters.filterCampaignStatus === 'all' ? 'selected' : '') + '>Tutte</option>';
                html += '<option value="active" ' + (state.alertFilters.filterCampaignStatus === 'active' ? 'selected' : '') + '>‚úÖ Solo Attive</option>';
                html += '<option value="paused" ' + (state.alertFilters.filterCampaignStatus === 'paused' ? 'selected' : '') + '>‚è∏Ô∏è Solo Spente</option>';
                html += '</select></div>';

                // Filtro Ordinamento
                html += '<div>';
                html += '<label style="display:block;color:#9ca3af;font-size:0.75rem;margin-bottom:6px;font-weight:600">üìä ORDINA PER</label>';
                html += '<select onchange="updateAlertFilter(\'sortBy\', this.value)" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);color:white;font-size:0.875rem">';
                html += '<option value="roi" ' + (state.alertFilters.sortBy === 'roi' ? 'selected' : '') + '>ROI</option>';
                html += '<option value="revenue" ' + (state.alertFilters.sortBy === 'revenue' ? 'selected' : '') + '>üí∞ Revenue</option>';
                html += '<option value="approved" ' + (state.alertFilters.sortBy === 'approved' ? 'selected' : '') + '>‚úÖ Approvate</option>';
                html += '<option value="spend" ' + (state.alertFilters.sortBy === 'spend' ? 'selected' : '') + '>üíµ Spesa</option>';
                html += '</select></div>';

                // Filtro Direzione
                html += '<div>';
                html += '<label style="display:block;color:#9ca3af;font-size:0.75rem;margin-bottom:6px;font-weight:600">üîÑ DIREZIONE</label>';
                html += '<select onchange="updateAlertFilter(\'sortOrder\', this.value)" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);color:white;font-size:0.875rem">';
                html += '<option value="desc" ' + (state.alertFilters.sortOrder === 'desc' ? 'selected' : '') + '>‚¨áÔ∏è Dal pi√π alto</option>';
                html += '<option value="asc" ' + (state.alertFilters.sortOrder === 'asc' ? 'selected' : '') + '>‚¨ÜÔ∏è Dal pi√π basso</option>';
                html += '</select></div>';

                // Reset filtri
                html += '<div style="display:flex;align-items:flex-end">';
                html += '<button onclick="resetAlertFilters()" class="btn-secondary" style="width:100%;padding:8px 12px;font-size:0.875rem">üîÑ Reset Filtri</button>';
                html += '</div>';

                html += '</div>';

                // TABELLA
                html += '<div style="overflow-x:auto"><table>';
                html += '<thead><tr><th>Campagna</th><th>Account</th><th>üîå Stato</th><th>Spesa</th><th>Conv. ADV</th><th>‚úÖ Approvate</th><th>üí∞ Revenue</th><th>üéØ CPA Goal</th><th>üìä CPA Reale</th><th>üíµ CPA Pagata</th><th>Profit</th><th>ROI</th><th>ROAS</th><th>ROI Status</th></tr></thead><tbody>';

                tutteCampagneFiltrate.forEach(function(alert) {
                    var c = alert.campaign;
                    var roiColor = alert.roi >= 0 ? '#22c55e' : '#ef4444';
                    var profitColor = alert.profit >= 0 ? '#22c55e' : '#ef4444';
                    var rowStyle = alert.roi < 0 ? 'background:rgba(239,68,68,0.05)' : 'background:rgba(34,197,94,0.02)';

                    // Stato campagna
                    var campaignStatus = (c.effective_status || c.status || 'UNKNOWN').toUpperCase();
                    var statusBadge = '';
                    var statusColor = '';
                    var statusIcon = '';

                    if (campaignStatus === 'ACTIVE') {
                        statusColor = '#22c55e';
                        statusIcon = '‚úÖ';
                        statusBadge = 'ATTIVA';
                    } else if (campaignStatus === 'PAUSED') {
                        statusColor = '#f59e0b';
                        statusIcon = '‚è∏Ô∏è';
                        statusBadge = 'PAUSA';
                    } else if (campaignStatus === 'ARCHIVED') {
                        statusColor = '#9ca3af';
                        statusIcon = 'üì¶';
                        statusBadge = 'ARCHIVIATA';
                    } else {
                        statusColor = '#ef4444';
                        statusIcon = '‚ùå';
                        statusBadge = campaignStatus;
                    }

                    html += '<tr style="' + rowStyle + '">';
                    html += '<td><strong>' + c.name + '</strong></td>';
                    html += '<td style="color:#9ca3af;font-size:0.875rem">' + c.accountName + '</td>';
                    html += '<td><span style="background:' + statusColor + ';color:white;padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;white-space:nowrap">' + statusIcon + ' ' + statusBadge + '</span></td>';
                    html += '<td style="font-weight:600">‚Ç¨' + (c.spend || 0).toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
                    html += '<td>' + (alert.conversions || 0) + '</td>';
                    html += '<td style="color:#22c55e;font-weight:600">' + (alert.approved || 0) + '</td>';
                    html += '<td style="color:#a855f7;font-weight:600">‚Ç¨' + (alert.revenue || 0).toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
                    html += '<td style="color:#22c55e">‚Ç¨' + (alert.cpaGoal || 0).toFixed(2) + '</td>';
                    html += '<td style="color:#3b82f6">‚Ç¨' + (alert.cpaReale || 0).toFixed(2) + '</td>';
                    html += '<td style="color:#a855f7">‚Ç¨' + (alert.cpaPagata || 0).toFixed(2) + '</td>';
                    html += '<td style="color:' + profitColor + ';font-weight:600">‚Ç¨' + (alert.profit || 0).toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
                    html += '<td style="color:' + roiColor + ';font-weight:600">' + (alert.roi || 0).toFixed(2) + '%</td>';
                    html += '<td style="font-weight:600">' + (alert.roas || 0).toFixed(2) + 'x</td>';

                    // Badge stato ROI
                    if (alert.roi >= 50) {
                        html += '<td><span style="background:#22c55e;color:white;padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600">üî• OTTIMO</span></td>';
                    } else if (alert.roi >= 0) {
                        html += '<td><span style="background:#3b82f6;color:white;padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600">‚úÖ POSITIVO</span></td>';
                    } else if (alert.roi >= -20) {
                        html += '<td><span style="background:#f59e0b;color:white;padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600">‚ö†Ô∏è ATTENZIONE</span></td>';
                    } else {
                        html += '<td><span style="background:#ef4444;color:white;padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600">‚ùå CRITICO</span></td>';
                    }

                    html += '</tr>';
                });

                html += '</tbody></table></div>';

                // Footer con totali
                var totalSpend = tutteCampagneFiltrate.reduce(function(sum, a) { return sum + (a.campaign.spend || 0); }, 0);
                var totalRevenue = tutteCampagneFiltrate.reduce(function(sum, a) { return sum + (a.revenue || 0); }, 0);
                var totalProfit = totalRevenue - totalSpend;
                var totalROI = totalSpend > 0 ? ((totalRevenue - totalSpend) / totalSpend * 100) : 0;
                var totalROAS = totalSpend > 0 ? (totalRevenue / totalSpend) : 0;

                html += '<div style="margin-top:16px;padding:16px;background:rgba(255,255,255,0.05);border-radius:8px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px">';
                html += '<div><div style="color:#9ca3af;font-size:0.75rem;margin-bottom:4px">TOTALE SPESA</div><div style="font-weight:600;font-size:1.125rem">‚Ç¨' + totalSpend.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</div></div>';
                html += '<div><div style="color:#9ca3af;font-size:0.75rem;margin-bottom:4px">TOTALE REVENUE</div><div style="font-weight:600;font-size:1.125rem;color:#a855f7">‚Ç¨' + totalRevenue.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</div></div>';
                html += '<div><div style="color:#9ca3af;font-size:0.75rem;margin-bottom:4px">TOTALE PROFIT</div><div style="font-weight:600;font-size:1.125rem;color:' + (totalProfit >= 0 ? '#22c55e' : '#ef4444') + '">‚Ç¨' + totalProfit.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</div></div>';
                html += '<div><div style="color:#9ca3af;font-size:0.75rem;margin-bottom:4px">ROI MEDIO</div><div style="font-weight:600;font-size:1.125rem;color:' + (totalROI >= 0 ? '#22c55e' : '#ef4444') + '">' + totalROI.toFixed(2) + '%</div></div>';
                html += '<div><div style="color:#9ca3af;font-size:0.75rem;margin-bottom:4px">ROAS MEDIO</div><div style="font-weight:600;font-size:1.125rem">' + totalROAS.toFixed(2) + 'x</div></div>';
                html += '</div>';

                html += '</div>';
            }

            // CAMPAGNE ROI NEGATIVO (spostata sotto)
            if (filteredRoiNegativo.length > 0) {
                html += '<div class="card" style="margin-bottom:24px;border:2px solid #ef4444">';
                html += '<div class="card-title" style="color:#ef4444">‚ö†Ô∏è Campagne ROI Negativo (' + filteredRoiNegativo.length + ')</div>';
                html += '<div style="overflow-x:auto"><table>';
                html += '<thead><tr><th>Campagna</th><th>Account</th><th>Spesa</th><th>Conversioni ADV</th><th>Approvate</th><th>Revenue</th><th>üéØ CPA Goal</th><th>üìä CPA Reale</th><th>üí∞ CPA Pagata</th><th>Profit</th><th>ROI</th><th>ROAS</th><th>Trend</th></tr></thead><tbody>';

                filteredRoiNegativo.forEach(function(alert) {
                    var c = alert.campaign;
                    var roas = c.spend > 0 ? (alert.revenue / c.spend) : 0;

                    html += '<tr style="background:rgba(239,68,68,0.05)">';
                    html += '<td><strong>' + c.name + '</strong></td>';
                    html += '<td>' + c.accountName + '</td>';
                    html += '<td>‚Ç¨' + (c.spend || 0).toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
                    html += '<td>' + (alert.conversions || 0) + '</td>';
                    html += '<td style="color:#22c55e;font-weight:600">' + (alert.approved || 0) + '</td>';
                    html += '<td>‚Ç¨' + (alert.revenue || 0).toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
                    html += '<td style="color:#22c55e">‚Ç¨' + (alert.cpaGoal || 0).toFixed(2) + '</td>';
                    html += '<td style="color:#ef4444">‚Ç¨' + (alert.cpaReale || 0).toFixed(2) + '</td>';
                    html += '<td style="color:#a855f7">‚Ç¨' + (alert.cpaPagata || 0).toFixed(2) + '</td>';
                    html += '<td style="color:#ef4444;font-weight:600">‚Ç¨' + (alert.profit || 0).toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
                    html += '<td style="color:#ef4444;font-weight:600">' + (alert.roi || 0).toFixed(2) + '%</td>';
                    html += '<td style="font-weight:600">' + roas.toFixed(2) + 'x</td>';
                    html += '<td>' + (alert.trendBadge || '-') + '</td>';
                    html += '</tr>';
                });

                html += '</tbody></table></div></div>';
            }

            // CAMPAGNE TREND IN CALO
            if (filteredTrendCalo.length > 0) {
                html += '<div class="card" style="margin-bottom:24px;border:2px solid #f97316">';
                html += '<div class="card-title" style="color:#f97316">üìâ Campagne in Calo (' + filteredTrendCalo.length + ')</div>';
                html += '<div style="overflow-x:auto"><table>';
                html += '<thead><tr><th>Campagna</th><th>Account</th><th>Spesa</th><th>Conversioni ADV</th><th>Approvate</th><th>Revenue</th><th>üéØ CPA Goal</th><th>üìä CPA Reale</th><th>üí∞ CPA Pagata</th><th>ROI Attuale</th><th>ROI Prec.</th><th>Trend %</th></tr></thead><tbody>';

                filteredTrendCalo.forEach(function(alert) {
                    var c = alert.campaign;
                    html += '<tr style="background:rgba(249,115,22,0.05)">';
                    html += '<td><strong>' + c.name + '</strong></td>';
                    html += '<td>' + c.accountName + '</td>';
                    html += '<td>‚Ç¨' + (c.spend || 0).toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
                    html += '<td>' + (alert.conversions || 0) + '</td>';
                    html += '<td style="color:#22c55e;font-weight:600">' + (alert.approved || 0) + '</td>';
                    html += '<td>‚Ç¨' + (alert.revenue || 0).toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
                    html += '<td style="color:#22c55e">‚Ç¨' + (alert.cpaGoal || 0).toFixed(2) + '</td>';
                    html += '<td style="color:#ef4444">‚Ç¨' + (alert.cpaReale || 0).toFixed(2) + '</td>';
                    html += '<td style="color:#a855f7">‚Ç¨' + (alert.cpaPagata || 0).toFixed(2) + '</td>';
                    html += '<td>' + (alert.roi || 0).toFixed(2) + '%</td>';
                    html += '<td>' + (alert.previousRoi || 0).toFixed(2) + '%</td>';
                    html += '<td style="color:#f97316;font-weight:600">' + alert.trendPercent.toFixed(1) + '%</td>';
                    html += '</tr>';
                });

                html += '</tbody></table></div></div>';
            }

            // CAMPAGNE TREND IN AUMENTO
            if (filteredTrendAumento.length > 0) {
                html += '<div class="card" style="margin-bottom:24px;border:2px solid #22c55e">';
                html += '<div class="card-title" style="color:#22c55e">üìà Campagne in Aumento (' + filteredTrendAumento.length + ')</div>';
                html += '<div style="overflow-x:auto"><table>';
                html += '<thead><tr><th>Campagna</th><th>Account</th><th>Spesa</th><th>Conversioni ADV</th><th>Approvate</th><th>Revenue</th><th>üéØ CPA Goal</th><th>üìä CPA Reale</th><th>üí∞ CPA Pagata</th><th>ROI Attuale</th><th>ROI Prec.</th><th>Trend %</th></tr></thead><tbody>';

                filteredTrendAumento.forEach(function(alert) {
                    var c = alert.campaign;
                    html += '<tr style="background:rgba(34,197,94,0.05)">';
                    html += '<td><strong>' + c.name + '</strong></td>';
                    html += '<td>' + c.accountName + '</td>';
                    html += '<td>‚Ç¨' + (c.spend || 0).toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
                    html += '<td>' + (alert.conversions || 0) + '</td>';
                    html += '<td style="color:#22c55e;font-weight:600">' + (alert.approved || 0) + '</td>';
                    html += '<td>‚Ç¨' + (alert.revenue || 0).toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
                    html += '<td style="color:#22c55e">‚Ç¨' + (alert.cpaGoal || 0).toFixed(2) + '</td>';
                    html += '<td style="color:#ef4444">‚Ç¨' + (alert.cpaReale || 0).toFixed(2) + '</td>';
                    html += '<td style="color:#a855f7">‚Ç¨' + (alert.cpaPagata || 0).toFixed(2) + '</td>';
                    html += '<td>' + (alert.roi || 0).toFixed(2) + '%</td>';
                    html += '<td>' + (alert.previousRoi || 0).toFixed(2) + '%</td>';
                    html += '<td style="color:#22c55e;font-weight:600">+' + alert.trendPercent.toFixed(1) + '%</td>';
                    html += '</tr>';
                });

                html += '</tbody></table></div></div>';
            }

            // SE NON CI SONO ALERT (nei risultati filtrati)
            if (filteredRoiNegativo.length === 0 && filteredTrendCalo.length === 0 && filteredTrendAumento.length === 0 && tutteCampagneFiltrate.length === 0) {
                html += '<div class="card">';
                html += '<div style="text-align:center;padding:60px 20px">';
                if (searchLower) {
                    html += '<div style="font-size:3rem;margin-bottom:16px">üîç</div>';
                    html += '<p style="font-size:1.25rem;margin-bottom:8px;color:#fff">Nessun risultato per "' + state.alertSearchFilter + '"</p>';
                    html += '<p style="color:#9ca3af">Prova a cercare con parole diverse</p>';
                } else {
                    html += '<div style="font-size:3rem;margin-bottom:16px">üéâ</div>';
                    html += '<p style="font-size:1.25rem;margin-bottom:8px;color:#fff">Nessuna campagna trovata</p>';
                    html += '<p style="color:#9ca3af">Effettua una sincronizzazione per analizzare le campagne</p>';
                }
                html += '</div></div>';
            }

            // INFO BOX
            html += '<div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:12px;padding:20px;margin-top:30px">';
            html += '<h3 style="margin-bottom:12px;color:#3b82f6">‚ÑπÔ∏è Come funziona il sistema Alert</h3>';
            html += '<ul style="color:#9ca3af;font-size:0.875rem;line-height:1.8;padding-left:20px">';
            html += '<li><strong>ROI Negativo:</strong> Campagne con ROI < 0% (in perdita)</li>';
            html += '<li><strong>Trend in Calo:</strong> Campagne con performance peggiori rispetto al periodo precedente</li>';
            html += '<li><strong>Trend in Aumento:</strong> Campagne con performance migliori rispetto al periodo precedente</li>';
            html += '<li><strong>Confronto automatico:</strong> Il sistema confronta il periodo corrente con un periodo precedente di uguale durata</li>';
            html += '<li><strong>Aggiornamento:</strong> Gli alert si aggiornano automaticamente ad ogni sync</li>';
            html += '</ul></div>';

            // Carica configurazione Telegram dopo render
            setTimeout(function() {
                loadTelegramReportConfig();
            }, 100);

            return html;
        }

        // Calcola alert e trend
        function calculateAlerts() {
            // Reset alert
            state.alerts.roiNegativo = [];
            state.alerts.roiPositivo = [];
            state.alerts.trendCalo = [];
            state.alerts.trendAumento = [];
            state.alerts.tutteCampagne = [];

            if (!state.campaignsData || state.campaignsData.length === 0) {
                console.log('‚ö†Ô∏è calculateAlerts: nessuna campagna disponibile');
                return;
            }

            console.log('üîî Calcolo alert per', state.campaignsData.length, 'campagne');
            console.log('üìä Offerte matchate disponibili:', state.matchedData ? state.matchedData.length : 0);

            // Debug: mostra tutti gli offerIds disponibili
            if (state.matchedData && state.matchedData.length > 0) {
                var availableOfferIds = state.matchedData.map(function(o) { return o.offerId; }).join(', ');
                console.log('üìã OfferIds disponibili in matchedData:', availableOfferIds);
            }

            // Per ogni campagna, calcola ROI e trend
            state.campaignsData.forEach(function(campaign) {
                // Trova revenue per questa campagna e dati offerta associata
                var revenue = 0;
                var profit = 0;
                var roi = 0;
                var cpaGoal = 0;
                var cpaReale = 0;
                var cpaPagata = 0;
                var approved = 0;
                var offerId = null;

                // Estrai offer_id dal nome campagna (formato: "1949-Nome Campagna")
                var match = campaign.name.match(/^(\d+)-/);
                if (match) {
                    offerId = match[1]; // Sempre stringa

                    // Debug per vedere cosa viene estratto
                    console.log('üîé Campagna:', campaign.name, '‚Üí OfferId estratto:', offerId, '(type:', typeof offerId + ')');

                    // CPA Goal dall'offerta
                    if (state.offersGoals[offerId]) {
                        cpaGoal = state.offersGoals[offerId];
                    } else {
                        var refOffer = state.offersReference[offerId];
                        if (refOffer && refOffer.payout) {
                            cpaGoal = refOffer.payout;
                        }
                    }

                    // Cerca revenue dall'offerta matchata usando l'offerId
                    if (state.matchedData) {
                        // Prova match esatto con stringa
                        var matchedOffer = state.matchedData.find(function(offer) {
                            // Converti entrambi a stringa per confronto sicuro
                            return String(offer.offerId) === String(offerId);
                        });

                        if (matchedOffer) {
                            revenue = matchedOffer.revenue || 0;
                            approved = matchedOffer.approved || 0;

                            console.log('   ‚úÖ Match trovato!');
                            console.log('      Campagna:', campaign.name);
                            console.log('      OfferId campagna:', offerId, '(type:', typeof offerId + ')');
                            console.log('      OfferId offerta:', matchedOffer.offerId, '(type:', typeof matchedOffer.offerId + ')');
                            console.log('      Revenue:', revenue);
                            console.log('      Approved:', approved);
                        } else {
                            console.log('   ‚ùå Nessun match per campagna:', campaign.name);
                            console.log('      OfferId cercato:', offerId, '(type:', typeof offerId + ')');

                            // Debug: mostra i primi offerIds per confronto
                            if (state.matchedData.length > 0) {
                                var firstOffer = state.matchedData[0];
                                console.log('      Esempio offerId in matchedData:', firstOffer.offerId, '(type:', typeof firstOffer.offerId + ')');
                            }
                        }
                    }
                }

                var spend = campaign.spend || 0;
                var conversions = campaign.purchases || 0; // conversioni dalla campagna ADV

                // Calcola CPA Reale (quanto SPENDO per conversione approvata)
                if (approved > 0) {
                    cpaReale = spend / approved;
                }

                // Calcola CPA Pagata (quanto MI PAGANO per conversione)
                if (approved > 0) {
                    cpaPagata = revenue / approved;
                }

                profit = revenue - spend;
                roi = spend > 0 ? ((revenue - spend) / spend * 100) : 0;
                var roas = spend > 0 ? (revenue / spend) : 0;
                var trendBadge = getTrendBadge(campaign, state.previousPeriodData);

                // Oggetto campagna con tutti i dati calcolati
                var campaignData = {
                    campaign: campaign,
                    revenue: revenue,
                    profit: profit,
                    roi: roi,
                    roas: roas,
                    trendBadge: trendBadge,
                    cpaGoal: cpaGoal,
                    cpaReale: cpaReale,
                    cpaPagata: cpaPagata,
                    approved: approved,
                    conversions: conversions
                };

                // Aggiungi a TUTTE le campagne
                state.alerts.tutteCampagne.push(campaignData);

                // ALERT ROI NEGATIVO
                if (roi < 0) {
                    state.alerts.roiNegativo.push(campaignData);
                } else {
                    // ROI POSITIVO
                    state.alerts.roiPositivo.push(campaignData);
                }

                // ALERT TREND (solo se abbiamo dati precedenti)
                if (state.previousPeriodData && state.previousPeriodData.campaigns) {
                    var previousCampaign = state.previousPeriodData.campaigns.find(function(c) {
                        return c.name === campaign.name;
                    });

                    if (previousCampaign) {
                        // Calcola ROI precedente usando l'offerId
                        var previousRevenue = 0;
                        if (offerId && state.previousPeriodData.matched) {
                            var previousMatchedOffer = state.previousPeriodData.matched.find(function(offer) {
                                return offer.offerId === offerId;
                            });

                            if (previousMatchedOffer) {
                                previousRevenue = previousMatchedOffer.revenue || 0;
                            }
                        }

                        var previousSpend = previousCampaign.spend || 0;
                        var previousRoi = previousSpend > 0 ? ((previousRevenue - previousSpend) / previousSpend * 100) : 0;

                        // Calcola variazione trend
                        var trendPercent = previousRoi !== 0 ? ((roi - previousRoi) / Math.abs(previousRoi) * 100) : 0;
                        var trendBadge = getTrendBadge(campaign, state.previousPeriodData);

                        // Calo significativo (>10%)
                        if (trendPercent < -10) {
                            state.alerts.trendCalo.push({
                                campaign: campaign,
                                roi: roi,
                                previousRoi: previousRoi,
                                trendPercent: trendPercent,
                                trendBadge: trendBadge,
                                cpaGoal: cpaGoal,
                                cpaReale: cpaReale,
                                cpaPagata: cpaPagata,
                                approved: approved,
                                conversions: conversions,
                                revenue: revenue,
                                profit: profit
                            });
                        }

                        // Aumento significativo (>10%)
                        if (trendPercent > 10) {
                            state.alerts.trendAumento.push({
                                campaign: campaign,
                                roi: roi,
                                previousRoi: previousRoi,
                                trendPercent: trendPercent,
                                trendBadge: trendBadge,
                                cpaGoal: cpaGoal,
                                cpaReale: cpaReale,
                                cpaPagata: cpaPagata,
                                approved: approved,
                                conversions: conversions,
                                revenue: revenue,
                                profit: profit
                            });
                        }
                    }
                }
            });

            console.log('üîî Alert calcolati:');
            console.log('   ROI Negativo:', state.alerts.roiNegativo.length);
            console.log('   Trend Calo:', state.alerts.trendCalo.length);
            console.log('   Trend Aumento:', state.alerts.trendAumento.length);
        }

        // Genera badge trend per campagna
        function getTrendBadge(campaign, previousData) {
            if (!previousData || !previousData.campaigns) {
                return '<span style="color:#9ca3af">-</span>';
            }

            var previousCampaign = previousData.campaigns.find(function(c) {
                return c.name === campaign.name;
            });

            if (!previousCampaign) {
                return '<span style="color:#9ca3af">üÜï Nuova</span>';
            }

            // Estrai offer_id dal nome campagna
            var match = campaign.name.match(/^(\d+)-/);
            var offerId = match ? match[1] : null;

            // Calcola ROI attuale
            var currentRevenue = 0;
            if (offerId && state.matchedData) {
                var currentMatchedOffer = state.matchedData.find(function(offer) {
                    return offer.offerId === offerId;
                });
                if (currentMatchedOffer) {
                    currentRevenue = currentMatchedOffer.revenue || 0;
                }
            }
            var currentSpend = campaign.spend || 0;
            var currentRoi = currentSpend > 0 ? ((currentRevenue - currentSpend) / currentSpend * 100) : 0;

            // Calcola ROI precedente
            var previousRevenue = 0;
            if (offerId && previousData.matched) {
                var previousMatchedOffer = previousData.matched.find(function(offer) {
                    return offer.offerId === offerId;
                });
                if (previousMatchedOffer) {
                    previousRevenue = previousMatchedOffer.revenue || 0;
                }
            }
            var previousSpend = previousCampaign.spend || 0;
            var previousRoi = previousSpend > 0 ? ((previousRevenue - previousSpend) / previousSpend * 100) : 0;

            // Determina trend
            var diff = currentRoi - previousRoi;

            if (diff > 10) {
                return '<span style="color:#22c55e;font-weight:600">üìà +' + diff.toFixed(1) + '%</span>';
            } else if (diff < -10) {
                return '<span style="color:#ef4444;font-weight:600">üìâ ' + diff.toFixed(1) + '%</span>';
            } else if (diff > 0) {
                return '<span style="color:#3b82f6">‚ÜóÔ∏è +' + diff.toFixed(1) + '%</span>';
            } else if (diff < 0) {
                return '<span style="color:#f97316">‚ÜòÔ∏è ' + diff.toFixed(1) + '%</span>';
            } else {
                return '<span style="color:#9ca3af">‚û°Ô∏è 0%</span>';
            }
        }

        // Carica dati periodo precedente per confronto trend
        async function loadPreviousPeriodData() {
            try {
                // Calcola periodo precedente (stessa durata del periodo corrente, shiftato indietro)
                var dateFrom = new Date(state.dateFrom);
                var dateTo = new Date(state.dateTo);
                var duration = (dateTo - dateFrom) / (1000 * 60 * 60 * 24); // giorni

                var prevDateTo = new Date(dateFrom);
                prevDateTo.setDate(prevDateTo.getDate() - 1);

                var prevDateFrom = new Date(prevDateTo);
                prevDateFrom.setDate(prevDateFrom.getDate() - duration);

                var prevFrom = prevDateFrom.toISOString().split('T')[0];
                var prevTo = prevDateTo.toISOString().split('T')[0];

                console.log('üìÖ Caricando periodo precedente:', prevFrom, '‚Üí', prevTo, '(' + duration + ' giorni)');

                // Carica dati periodo precedente
                var trafficData = await fetchTrafficManagerData(prevFrom, prevTo);
                var metaCampaigns = await fetchMetaAdsData(prevFrom, prevTo);
                var matchedData = matchCampaignsWithOffers(trafficData, metaCampaigns);

                state.previousPeriodData = {
                    dateFrom: prevFrom,
                    dateTo: prevTo,
                    campaigns: metaCampaigns,
                    traffic: trafficData,
                    matched: matchedData
                };

                console.log('‚úÖ Periodo precedente caricato:', metaCampaigns.length, 'campagne');
            } catch (error) {
                console.error('‚ùå Errore caricamento periodo precedente:', error);
                state.previousPeriodData = null;
            }
        }

        // ========== STORICO & GRAFICI ==========
        function renderHistory() {
            var html = '';

            html += '<div style="margin-bottom:30px">';
            html += '<h2 style="font-size:1.75rem;margin-bottom:8px">üìä Storico & Grafici</h2>';
            html += '<p style="color:#9ca3af">Visualizza l\'evoluzione delle performance nel tempo</p>';
            html += '</div>';

            // EXPORT BUTTONS
            html += '<div style="display:flex;gap:12px;margin-bottom:30px;flex-wrap:wrap">';
            html += '<button onclick="exportCampaignsToExcel()" class="btn-primary">üì• Export Campagne (Excel)</button>';
            html += '<button onclick="exportOffersToExcel()" class="btn-primary">üì• Export Offerte (Excel)</button>';
            html += '<button onclick="exportCampaignsToCSV()" class="btn-secondary">üìÑ Export Campagne (CSV)</button>';
            html += '<button onclick="exportOffersToCSV()" class="btn-secondary">üìÑ Export Offerte (CSV)</button>';
            html += '<button onclick="loadHistoryData()" class="btn-secondary">üîÑ Ricarica Storico</button>';
            html += '</div>';

            // GRAFICI - 2 righe
            html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(500px,1fr));gap:24px;margin-bottom:30px">';

            // Grafico 1: Spesa vs Revenue nel tempo
            html += '<div class="card">';
            html += '<div class="card-title">üí∞ Spesa vs Revenue</div>';
            html += '<canvas id="chartSpendRevenue" style="max-height:300px"></canvas>';
            html += '</div>';

            // Grafico 2: ROI Trend
            html += '<div class="card">';
            html += '<div class="card-title">üìà ROI Trend</div>';
            html += '<canvas id="chartROI" style="max-height:300px"></canvas>';
            html += '</div>';

            // Grafico 3: Funnel Conversioni
            html += '<div class="card">';
            html += '<div class="card-title">üéØ Funnel Conversioni</div>';
            html += '<canvas id="chartFunnel" style="max-height:300px"></canvas>';
            html += '</div>';

            // Grafico 4: Performance per Piattaforma
            html += '<div class="card">';
            html += '<div class="card-title">üåê Performance per Piattaforma</div>';
            html += '<canvas id="chartPlatforms" style="max-height:300px"></canvas>';
            html += '</div>';

            html += '</div>';

            // TABELLA STORICO SINCRONIZZAZIONI
            if (state.historyData && state.historyData.length > 0) {
                html += '<div class="card">';
                html += '<div class="card-title">üìÖ Storico Sincronizzazioni (Ultimi 30 giorni)</div>';
                html += '<div style="overflow-x:auto">';
                html += '<table>';
                html += '<thead><tr>';
                html += '<th>Data Sync</th><th>Periodo</th><th>Spesa</th><th>Revenue</th><th>Profit</th>';
                html += '<th>ROI</th><th>ROAS</th><th>Conversioni</th><th>Campagne</th>';
                html += '</tr></thead><tbody>';

                for (var i = 0; i < Math.min(state.historyData.length, 30); i++) {
                    var h = state.historyData[i];
                    var syncDate = new Date(h.synced_at).toLocaleString('it-IT');
                    var period = h.date_from + ' ‚Üí ' + h.date_to;

                    html += '<tr>';
                    html += '<td>' + syncDate + '</td>';
                    html += '<td>' + period + '</td>';
                    html += '<td>‚Ç¨' + parseFloat(h.total_spend || 0).toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
                    html += '<td>‚Ç¨' + parseFloat(h.total_revenue || 0).toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';

                    var profit = parseFloat(h.total_profit || 0);
                    var profitColor = profit >= 0 ? '#22c55e' : '#ef4444';
                    html += '<td style="color:' + profitColor + ';font-weight:600">‚Ç¨' + profit.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';

                    var roi = parseFloat(h.roi || 0);
                    var roiColor = roi >= 0 ? '#22c55e' : '#ef4444';
                    html += '<td style="color:' + roiColor + ';font-weight:600">' + roi.toFixed(2) + '%</td>';

                    html += '<td>' + parseFloat(h.roas || 0).toFixed(2) + '</td>';
                    html += '<td>' + (h.total_approved || 0) + '</td>';
                    html += '<td>' + (h.campaigns_count || 0) + '</td>';
                    html += '</tr>';
                }

                html += '</tbody></table>';
                html += '</div></div>';
            } else {
                html += '<div class="card">';
                html += '<div style="text-align:center;padding:60px 20px;color:#9ca3af">';
                html += '<div style="font-size:3rem;margin-bottom:16px">üìä</div>';
                html += '<p style="font-size:1.25rem;margin-bottom:16px;color:#fff">Nessuno storico disponibile</p>';
                html += '<div style="max-width:600px;margin:0 auto;text-align:left;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:12px;padding:24px">';
                html += '<h3 style="margin-bottom:16px;color:#3b82f6">üöÄ Come iniziare:</h3>';
                html += '<ol style="line-height:2;padding-left:20px">';
                html += '<li><strong>Crea le tabelle database:</strong><br>';
                html += '<span style="font-size:0.875rem;color:#9ca3af">Vai su Supabase ‚Üí SQL Editor ‚Üí Esegui <code>database-schema-sync-history.sql</code></span></li>';
                html += '<li><strong>Effettua una sincronizzazione:</strong><br>';
                html += '<span style="font-size:0.875rem;color:#9ca3af">Tab Dashboard ‚Üí Clicca "üîÑ Sync Ora"</span></li>';
                html += '<li><strong>Torna qui per vedere grafici e storico</strong></li>';
                html += '</ol>';
                html += '<div style="margin-top:20px;padding:12px;background:rgba(245,158,11,0.1);border-radius:8px;border:1px solid rgba(245,158,11,0.3)">';
                html += '<strong>üí° Tip:</strong> Ogni sync futuro verr√† salvato automaticamente per creare lo storico';
                html += '</div></div>';
                html += '</div></div>';
            }

            return html;
        }

        // ========== LOAD HISTORY DATA ==========
        async function loadHistoryData() {
            try {
                console.log('üìä Loading history data...');

                const { data, error } = await supabase
                    .from('sync_history')
                    .select('*')
                    .eq('user_id', state.currentUser.id)
                    .order('synced_at', { ascending: false })
                    .limit(100);

                if (error) {
                    // Se la tabella non esiste, mostra un messaggio chiaro
                    if (error.code === '42P01' || error.message.includes('does not exist')) {
                        console.warn('‚ö†Ô∏è Tabella sync_history non trovata. Devi creare lo schema database!');
                        console.warn('üìÑ Esegui il file database-schema-sync-history.sql su Supabase');
                        state.historyData = [];
                        render();
                        return;
                    }
                    throw error;
                }

                state.historyData = data || [];
                console.log('‚úÖ History loaded:', state.historyData.length, 'records');

                // Ridisegna se siamo nella tab history
                if (state.currentTab === 'history') {
                    render();

                    // Aspetta che il DOM sia aggiornato, poi crea i grafici
                    // Usa un timeout pi√π lungo e verifica che i canvas esistano
                    setTimeout(function() {
                        console.log('üé® Creando grafici...');
                        createCharts();
                    }, 300);
                }
            } catch (error) {
                console.error('‚ùå Error loading history:', error);
                state.historyData = [];
                render();
            }
        }

        // ========== SAVE SYNC TO HISTORY ==========
        async function saveSyncToHistory() {
            try {
                // Calcola performance per piattaforma
                var platformsData = {};

                if (state.campaignsData) {
                    state.campaignsData.forEach(function(c) {
                        var platform = c.platform || 'meta';
                        if (!platformsData[platform]) {
                            platformsData[platform] = { spend: 0, revenue: 0, conversions: 0, campaigns: 0 };
                        }
                        platformsData[platform].spend += c.spend || 0;
                        platformsData[platform].campaigns += 1;
                    });
                }

                if (state.matchedData) {
                    state.matchedData.forEach(function(o) {
                        var platform = 'meta'; // Default, potremmo estrarlo dalla campagna
                        if (platformsData[platform]) {
                            platformsData[platform].revenue += o.revenue || 0;
                            platformsData[platform].conversions += o.approved || 0;
                        }
                    });
                }

                // Calcola totali conversioni
                var totalApproved = 0;
                var totalPending = 0;
                var totalCancelled = 0;
                var totalDouble = 0;
                var totalTrash = 0;

                if (state.matchedData) {
                    state.matchedData.forEach(function(o) {
                        totalApproved += o.approved || 0;
                        totalPending += o.pending || 0;
                        totalCancelled += o.cancelled || 0;
                        totalDouble += o.double || 0;
                        totalTrash += o.trash || 0;
                    });
                }

                // Salva nel database
                const { error } = await supabase
                    .from('sync_history')
                    .insert({
                        user_id: state.currentUser.id,
                        date_from: state.dateFrom,
                        date_to: state.dateTo,
                        total_spend: state.stats.totalSpend || 0,
                        total_revenue: state.stats.totalRevenue || 0,
                        total_profit: state.stats.profit || 0,
                        total_conversions: totalApproved + totalPending,
                        total_approved: totalApproved,
                        total_pending: totalPending,
                        total_cancelled: totalCancelled,
                        total_double: totalDouble,
                        total_trash: totalTrash,
                        roi: state.stats.roi || 0,
                        roas: state.stats.roas || 0,
                        campaigns_count: state.campaignsData ? state.campaignsData.length : 0,
                        accounts_count: state.selectedAccounts.meta.length,
                        platforms_data: platformsData,
                        campaigns_snapshot: state.campaignsData || [],
                        offers_snapshot: state.matchedData || [],
                        ads_snapshot: state.adsData || [] // Salva snapshot delle Ads/Creative
                    });

                if (error) {
                    // Se la tabella non esiste, avvisa ma non bloccare
                    if (error.code === '42P01' || error.message.includes('does not exist')) {
                        console.warn('‚ö†Ô∏è Tabella sync_history non trovata - Storico non salvato');
                        console.warn('üìÑ Per abilitare lo storico, esegui database-schema-sync-history.sql su Supabase');
                    } else {
                        console.error('‚ùå Error saving sync history:', error);
                    }
                } else {
                    console.log('‚úÖ Sync saved to history');
                }
            } catch (error) {
                console.error('‚ùå Error in saveSyncToHistory:', error);
            }
        }

        // ========== CREATE CHARTS ==========
        function createCharts() {
            if (!state.historyData || state.historyData.length === 0) {
                console.log('‚ö†Ô∏è No history data for charts');
                return;
            }

            // Verifica che Chart.js sia caricato
            if (typeof Chart === 'undefined') {
                console.error('‚ùå Chart.js not loaded!');
                return;
            }

            console.log('üìä Creating charts with', state.historyData.length, 'history records');

            // Prendi ultimi 30 record e inverti ordine (dal pi√π vecchio al pi√π recente)
            var history = state.historyData.slice(0, 30).reverse();

            console.log('üìà Chart data points:', history.length);

            // Prepara labels e datasets
            var labels = history.map(function(h) {
                return new Date(h.synced_at).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
            });

            // ========== GRAFICO 1: Spesa vs Revenue ==========
            var ctx1 = document.getElementById('chartSpendRevenue');
            console.log('üîç Canvas chartSpendRevenue:', ctx1 ? 'FOUND' : 'NOT FOUND');
            if (ctx1) {
                // Distruggi grafico precedente solo se esiste ed √® un Chart valido
                if (window.chartSpendRevenue && typeof window.chartSpendRevenue.destroy === 'function') {
                    window.chartSpendRevenue.destroy();
                }

                window.chartSpendRevenue = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Spesa ADV',
                                data: history.map(function(h) { return parseFloat(h.total_spend || 0); }),
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'Revenue',
                                data: history.map(function(h) { return parseFloat(h.total_revenue || 0); }),
                                borderColor: '#22c55e',
                                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                tension: 0.3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { labels: { color: '#fff' } }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
                console.log('‚úÖ Chart 1 created: Spesa vs Revenue');
            } else {
                console.warn('‚ö†Ô∏è Canvas chartSpendRevenue not found in DOM');
            }

            // ========== GRAFICO 2: ROI Trend ==========
            var ctx2 = document.getElementById('chartROI');
            console.log('üîç Canvas chartROI:', ctx2 ? 'FOUND' : 'NOT FOUND');
            if (ctx2) {
                // Distruggi grafico precedente solo se esiste ed √® un Chart valido
                if (window.chartROI && typeof window.chartROI.destroy === 'function') {
                    window.chartROI.destroy();
                }

                window.chartROI = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ROI %',
                            data: history.map(function(h) { return parseFloat(h.roi || 0); }),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { labels: { color: '#fff' } }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    color: '#9ca3af',
                                    callback: function(value) { return value + '%'; }
                                },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
                console.log('‚úÖ Chart 2 created: ROI Trend');
            } else {
                console.warn('‚ö†Ô∏è Canvas chartROI not found in DOM');
            }

            // ========== GRAFICO 3: Funnel Conversioni ==========
            var latestSync = history[history.length - 1];
            var ctx3 = document.getElementById('chartFunnel');
            console.log('üîç Canvas chartFunnel:', ctx3 ? 'FOUND' : 'NOT FOUND');
            if (ctx3 && latestSync) {
                // Distruggi grafico precedente solo se esiste ed √® un Chart valido
                if (window.chartFunnel && typeof window.chartFunnel.destroy === 'function') {
                    window.chartFunnel.destroy();
                }

                window.chartFunnel = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: ['Approvate', 'Pending', 'Annullate', 'Doppie', 'Trash'],
                        datasets: [{
                            label: 'Conversioni',
                            data: [
                                latestSync.total_approved || 0,
                                latestSync.total_pending || 0,
                                latestSync.total_cancelled || 0,
                                latestSync.total_double || 0,
                                latestSync.total_trash || 0
                            ],
                            backgroundColor: [
                                '#22c55e', // Approvate (verde)
                                '#eab308', // Pending (giallo)
                                '#ef4444', // Annullate (rosso)
                                '#f97316', // Doppie (arancione)
                                '#6b7280'  // Trash (grigio)
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { display: false }
                            }
                        }
                    }
                });
                console.log('‚úÖ Chart 3 created: Funnel Conversioni');
            } else {
                if (!ctx3) console.warn('‚ö†Ô∏è Canvas chartFunnel not found in DOM');
                if (!latestSync) console.warn('‚ö†Ô∏è No latestSync data for Funnel');
            }

            // ========== GRAFICO 4: Performance per Piattaforma ==========
            var ctx4 = document.getElementById('chartPlatforms');
            console.log('üîç Canvas chartPlatforms:', ctx4 ? 'FOUND' : 'NOT FOUND');
            if (ctx4 && latestSync && latestSync.platforms_data) {
                // Distruggi grafico precedente solo se esiste ed √® un Chart valido
                if (window.chartPlatforms && typeof window.chartPlatforms.destroy === 'function') {
                    window.chartPlatforms.destroy();
                }

                var platforms = Object.keys(latestSync.platforms_data);
                var spends = platforms.map(function(p) { return latestSync.platforms_data[p].spend || 0; });
                var revenues = platforms.map(function(p) { return latestSync.platforms_data[p].revenue || 0; });

                window.chartPlatforms = new Chart(ctx4, {
                    type: 'bar',
                    data: {
                        labels: platforms.map(function(p) { return p.toUpperCase(); }),
                        datasets: [
                            {
                                label: 'Spesa',
                                data: spends,
                                backgroundColor: '#ef4444'
                            },
                            {
                                label: 'Revenue',
                                data: revenues,
                                backgroundColor: '#22c55e'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { labels: { color: '#fff' } }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { display: false }
                            }
                        }
                    }
                });
                console.log('‚úÖ Chart 4 created: Performance Piattaforme');
            } else {
                if (!ctx4) console.warn('‚ö†Ô∏è Canvas chartPlatforms not found in DOM');
                if (!latestSync) console.warn('‚ö†Ô∏è No latestSync data for Platforms');
                if (latestSync && !latestSync.platforms_data) console.warn('‚ö†Ô∏è No platforms_data in latestSync');
            }

            console.log('‚úÖ All charts creation completed');
        }

        // ========== FOGLI SHEET SPREADSHEET - GESTIONE ==========

        // Carica i fogli salvati dal database
        async function loadSheets() {
            try {
                // Determina quale user_id usare
                var targetUserId = state.viewingTrackerId || state.currentUser.id;

                console.log('üìã loadSheets() - Caricamento fogli per user_id:', targetUserId);
                console.log('   viewingTrackerId:', state.viewingTrackerId);
                console.log('   currentUser.id:', state.currentUser.id);

                // Carica i fogli dell'utente target
                const { data, error } = await supabase
                    .from('affiliate_sheets')
                    .select('*')
                    .eq('user_id', targetUserId)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('‚ùå Errore caricamento fogli:', error);
                    throw error;
                }

                state.sheets = data || [];
                console.log('‚úÖ Caricati ' + state.sheets.length + ' fogli del proprietario');

                // Se sto visualizzando i MIEI dati, carica anche i fogli condivisi CON ME
                if (!state.viewingTrackerId) {
                    // Carica i fogli condivisi con me - Step 1: carica le condivisioni
                    const { data: sharedData, error: sharedError } = await supabase
                        .from('affiliate_sheet_shares')
                        .select('*')
                        .eq('shared_with_user_id', state.currentUser.id);

                    if (sharedError) {
                        console.error('Errore caricamento condivisioni:', sharedError);
                        state.sharedSheets = [];
                    } else if (sharedData && sharedData.length > 0) {
                        // Step 2: carica i fogli associati
                        const sheetIds = sharedData.map(function(share) { return share.sheet_id; });
                        const { data: sheetsData, error: sheetsError } = await supabase
                            .from('affiliate_sheets')
                            .select('*')
                            .in('id', sheetIds);

                        if (sheetsError) {
                            console.error('Errore caricamento fogli condivisi:', sheetsError);
                            state.sharedSheets = [];
                        } else {
                            // Step 3: carica le email dei proprietari
                            const ownerIds = sharedData.map(function(share) { return share.owner_user_id; });
                            let ownerEmails = {};

                            if (ownerIds.length > 0) {
                                const { data: profiles, error: profilesError } = await supabase
                                    .from('user_profiles')
                                    .select('id, email')
                                    .in('id', ownerIds);

                                if (!profilesError && profiles) {
                                    profiles.forEach(function(profile) {
                                        ownerEmails[profile.id] = profile.email;
                                    });
                                }
                            }

                            // Step 4: combina i dati
                            state.sharedSheets = sharedData
                                .map(function(share) {
                                    var sheet = (sheetsData || []).find(function(s) { return s.id === share.sheet_id; });
                                    if (!sheet) return null;

                                    return {
                                        id: sheet.id,
                                        name: sheet.name || 'Senza nome',
                                        description: sheet.description,
                                        columns: sheet.columns || [],
                                        rows: sheet.rows || [],
                                        user_id: sheet.user_id,
                                        created_at: sheet.created_at,
                                        shared_by: ownerEmails[share.owner_user_id] || 'Utente',
                                        permission: share.permission_level,
                                        share_id: share.id
                                    };
                                })
                                .filter(function(sheet) { return sheet !== null; }); // Rimuovi fogli null

                            console.log('‚úÖ Caricati ' + state.sharedSheets.length + ' fogli condivisi con me');
                        }
                    } else {
                        state.sharedSheets = [];
                    }
                } else {
                    // Se sto guardando i dati di qualcun altro, non caricare i fogli condivisi con me
                    state.sharedSheets = [];
                    console.log('‚ÑπÔ∏è Visualizzazione tracker condiviso: skip fogli condivisi con me');
                }

                console.log('üìä TOTALE: ' + state.sheets.length + ' fogli propri + ' + state.sharedSheets.length + ' condivisi');

                // Carica le condivisioni di ogni foglio del proprietario
                await loadSheetShares();

            } catch (error) {
                console.error('‚ùå Errore caricamento fogli:', error);
                alert('Errore nel caricamento dei fogli salvati: ' + error.message);
            }
        }

        // Carica le condivisioni per tutti i fogli
        async function loadSheetShares() {
            try {
                // Determina quale user_id usare
                var targetUserId = state.viewingTrackerId || state.currentUser.id;

                console.log('üîó loadSheetShares() - Caricamento condivisioni per user_id:', targetUserId);

                // Carica le condivisioni base
                const { data, error } = await supabase
                    .from('affiliate_sheet_shares')
                    .select('*')
                    .eq('owner_user_id', targetUserId);

                if (error) throw error;

                // Carica le email degli utenti da user_profiles
                const userIds = (data || []).map(function(share) { return share.shared_with_user_id; });
                let userEmails = {};

                if (userIds.length > 0) {
                    const { data: profiles, error: profilesError } = await supabase
                        .from('user_profiles')
                        .select('id, email')
                        .in('id', userIds);

                    if (!profilesError && profiles) {
                        profiles.forEach(function(profile) {
                            userEmails[profile.id] = profile.email;
                        });
                    }
                }

                // Organizza per sheet_id
                state.sheetShares = {};
                (data || []).forEach(function(share) {
                    if (!state.sheetShares[share.sheet_id]) {
                        state.sheetShares[share.sheet_id] = [];
                    }
                    state.sheetShares[share.sheet_id].push({
                        id: share.id,
                        user_email: userEmails[share.shared_with_user_id] || 'Utente',
                        user_id: share.shared_with_user_id,
                        permission: share.permission_level
                    });
                });

                console.log('‚úÖ Caricati ' + (data || []).length + ' condivisioni fogli');

            } catch (error) {
                console.error('‚ùå Errore caricamento condivisioni fogli:', error);
            }
        }

        // Carica le condivisioni del modulo (chi pu√≤ vedere i miei dati)
        async function loadTrackerShares() {
            try {
                // Carica le condivisioni base
                const { data, error } = await supabase
                    .from('affiliate_tracker_shares')
                    .select('*')
                    .eq('owner_user_id', state.currentUser.id);

                if (error) throw error;

                // Carica le email degli utenti da user_profiles
                const userIds = (data || []).map(function(share) { return share.shared_with_user_id; });
                let userEmails = {};

                if (userIds.length > 0) {
                    const { data: profiles, error: profilesError } = await supabase
                        .from('user_profiles')
                        .select('id, email')
                        .in('id', userIds);

                    if (!profilesError && profiles) {
                        profiles.forEach(function(profile) {
                            userEmails[profile.id] = profile.email;
                        });
                    }
                }

                state.trackerShares = (data || []).map(function(share) {
                    return {
                        id: share.id,
                        user_email: userEmails[share.shared_with_user_id] || 'Utente',
                        user_id: share.shared_with_user_id,
                        permission: share.permission_level,
                        created_at: share.created_at
                    };
                });

                console.log('‚úÖ Caricati ' + state.trackerShares.length + ' condivisioni modulo');

            } catch (error) {
                console.error('Errore caricamento condivisioni modulo:', error);
            }
        }

        // Carica i tracker condivisi con me (dati di altri utenti)
        async function loadSharedTrackers() {
            try {
                // Carica le condivisioni base
                const { data, error } = await supabase
                    .from('affiliate_tracker_shares')
                    .select('*')
                    .eq('shared_with_user_id', state.currentUser.id);

                if (error) throw error;

                // Carica le email dei proprietari da user_profiles
                const ownerIds = (data || []).map(function(share) { return share.owner_user_id; });
                let ownerEmails = {};

                if (ownerIds.length > 0) {
                    const { data: profiles, error: profilesError } = await supabase
                        .from('user_profiles')
                        .select('id, email')
                        .in('id', ownerIds);

                    if (!profilesError && profiles) {
                        profiles.forEach(function(profile) {
                            ownerEmails[profile.id] = profile.email;
                        });
                    }
                }

                state.sharedTrackers = (data || []).map(function(share) {
                    return {
                        id: share.id,
                        owner_email: ownerEmails[share.owner_user_id] || 'Utente',
                        owner_id: share.owner_user_id,
                        permission: share.permission_level,
                        created_at: share.created_at
                    };
                });

                console.log('‚úÖ Caricati ' + state.sharedTrackers.length + ' tracker condivisi');

            } catch (error) {
                console.error('Errore caricamento tracker condivisi:', error);
            }
        }

        // Auto-seleziona tracker condiviso se non ho miei dati
        async function autoSelectSharedTracker() {
            try {
                // Se non ci sono tracker condivisi, esci
                if (!state.sharedTrackers || state.sharedTrackers.length === 0) {
                    console.log('‚ÑπÔ∏è Nessun tracker condiviso disponibile');
                    return;
                }

                // Controlla se ho dati propri
                const { data: mySyncData } = await supabase
                    .from('sync_history')
                    .select('id')
                    .eq('user_id', state.currentUser.id)
                    .limit(1);

                var hasMyData = mySyncData && mySyncData.length > 0;

                // Se non ho miei dati, auto-seleziona il primo tracker condiviso
                if (!hasMyData) {
                    console.log('üîÑ Auto-selezione tracker condiviso: nessun dato personale trovato');
                    var firstTracker = state.sharedTrackers[0];

                    // Imposta viewingTrackerId e ricarica i dati
                    state.viewingTrackerId = firstTracker.owner_id;

                    console.log('‚úÖ Caricamento dati di: ' + firstTracker.owner_email);

                    // Ricarica i dati con il nuovo user_id
                    await loadSocialCredentials();
                    await loadOffersGoals();
                    await loadSheets();
                    await loadData();

                    // Mostra messaggio all'utente
                    setTimeout(function() {
                        alert('‚ÑπÔ∏è Stai visualizzando i dati condivisi da: ' + firstTracker.owner_email + '\n\nPuoi cambiare la visualizzazione usando il menu dropdown in alto.');
                    }, 500);
                } else {
                    console.log('‚ÑπÔ∏è L\'utente ha suoi dati, mantengo visualizzazione predefinita');
                }

            } catch (error) {
                console.error('Errore auto-selezione tracker:', error);
            }
        }

        // Crea un nuovo foglio vuoto
        async function createNewSheet(name, description) {
            try {
                if (!name || !name.trim()) {
                    alert('‚ö†Ô∏è Inserisci un nome per il foglio');
                    return null;
                }

                var sheetRecord = {
                    user_id: state.currentUser.id,
                    name: name.trim(),
                    description: description || null,
                    columns: [],
                    rows: []
                };

                const { data, error } = await supabase
                    .from('affiliate_sheets')
                    .insert([sheetRecord])
                    .select();

                if (error) throw error;

                console.log('‚úÖ Foglio creato:', data[0]);
                return data[0];

            } catch (error) {
                console.error('Errore creazione foglio:', error);
                alert('‚ùå Errore nella creazione del foglio: ' + error.message);
                return null;
            }
        }

        // Aggiorna un foglio esistente
        async function updateSheet(sheetId) {
            try {
                var sheet = findSheet(sheetId);
                if (!sheet) return;

                // Verifica permessi di modifica per fogli condivisi
                if (sheet.permission === 'view') {
                    alert('‚ö†Ô∏è Non hai i permessi per modificare questo foglio');
                    return;
                }

                const { error } = await supabase
                    .from('affiliate_sheets')
                    .update({
                        name: sheet.name,
                        description: sheet.description,
                        columns: sheet.columns,
                        rows: sheet.rows
                    })
                    .eq('id', sheetId);

                if (error) throw error;

                console.log('‚úÖ Foglio aggiornato:', sheetId);

            } catch (error) {
                console.error('Errore aggiornamento foglio:', error);
                alert('‚ùå Errore nell\'aggiornamento del foglio: ' + error.message);
            }
        }

        // Elimina un foglio
        async function deleteSheet(sheetId, sheetName) {
            if (!confirm('Sei sicuro di voler eliminare il foglio "' + sheetName + '"?')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('affiliate_sheets')
                    .delete()
                    .eq('id', sheetId);

                if (error) throw error;

                console.log('‚úÖ Foglio eliminato:', sheetId);
                alert('‚úÖ Foglio eliminato con successo');

                // Ricarica i fogli
                await loadSheets();
                render();

            } catch (error) {
                console.error('Errore eliminazione foglio:', error);
                alert('‚ùå Errore nell\'eliminazione del foglio: ' + error.message);
            }
        }

        // ========== FUNZIONI SPREADSHEET ==========

        // Helper: trova un foglio tra i miei fogli e quelli condivisi
        function findSheet(sheetId) {
            var sheet = state.sheets.find(function(s) { return s.id === sheetId; });
            if (!sheet) {
                sheet = state.sharedSheets.find(function(s) { return s.id === sheetId; });
            }
            return sheet;
        }

        // Apri foglio in modalit√† edit
        function openSheet(sheetId) {
            var sheet = findSheet(sheetId);

            if (!sheet) {
                console.error('Foglio non trovato:', sheetId);
                return;
            }

            state.currentSheet = sheet;
            render();
        }

        // Chiudi foglio corrente
        function closeSheet() {
            state.currentSheet = null;
            render();
        }

        // Aggiungi colonna
        async function addColumn(sheetId) {
            try {
                var sheet = findSheet(sheetId);
                if (!sheet) return;

                // Verifica permessi
                if (sheet.permission === 'view') {
                    alert('‚ö†Ô∏è Non hai i permessi per modificare questo foglio');
                    return;
                }

                if (!state.newColumn.name.trim()) {
                    alert('‚ö†Ô∏è Inserisci un nome per la colonna');
                    return;
                }

                var newCol = {
                    id: 'col_' + Date.now(),
                    name: state.newColumn.name,
                    type: state.newColumn.type,
                    width: state.newColumn.width || 150
                };

                sheet.columns.push(newCol);
                await updateSheet(sheetId);

                state.showAddColumnModal = false;
                state.newColumn = { name: '', type: 'text', width: 150 };

                await loadSheets();

                // Aggiorna il riferimento al foglio corrente
                state.currentSheet = findSheet(sheetId);

                render();

            } catch (error) {
                console.error('Errore aggiunta colonna:', error);
                alert('‚ùå Errore nell\'aggiunta della colonna');
            }
        }

        // Elimina colonna
        async function deleteColumn(sheetId, columnId) {
            try {
                var sheet = findSheet(sheetId);
                if (!sheet) return;

                // Verifica permessi
                if (sheet.permission === 'view') {
                    alert('‚ö†Ô∏è Non hai i permessi per modificare questo foglio');
                    return;
                }

                if (!confirm('Eliminare questa colonna? I dati verranno persi.')) return;

                // Rimuovi colonna
                sheet.columns = sheet.columns.filter(function(c) { return c.id !== columnId; });

                // Rimuovi dati colonna da tutte le righe
                sheet.rows.forEach(function(row) {
                    if (row.data) delete row.data[columnId];
                });

                await updateSheet(sheetId);
                await loadSheets();

                // Aggiorna il riferimento al foglio corrente
                state.currentSheet = findSheet(sheetId);

                render();

            } catch (error) {
                console.error('Errore eliminazione colonna:', error);
                alert('‚ùå Errore nell\'eliminazione della colonna');
            }
        }

        // Aggiungi riga
        async function addRow(sheetId) {
            try {
                var sheet = findSheet(sheetId);
                if (!sheet) return;

                // Verifica permessi
                if (sheet.permission === 'view') {
                    alert('‚ö†Ô∏è Non hai i permessi per modificare questo foglio');
                    return;
                }

                var newRow = {
                    id: 'row_' + Date.now(),
                    data: {}
                };

                // Inizializza dati vuoti per ogni colonna
                sheet.columns.forEach(function(col) {
                    newRow.data[col.id] = '';
                });

                sheet.rows.push(newRow);
                await updateSheet(sheetId);
                await loadSheets();

                // Aggiorna il riferimento al foglio corrente
                state.currentSheet = findSheet(sheetId);

                render();

            } catch (error) {
                console.error('Errore aggiunta riga:', error);
                alert('‚ùå Errore nell\'aggiunta della riga');
            }
        }

        // Elimina riga
        async function deleteRow(sheetId, rowId) {
            try {
                var sheet = findSheet(sheetId);
                if (!sheet) return;

                // Verifica permessi
                if (sheet.permission === 'view') {
                    alert('‚ö†Ô∏è Non hai i permessi per modificare questo foglio');
                    return;
                }

                if (!confirm('Eliminare questa riga?')) return;

                sheet.rows = sheet.rows.filter(function(r) { return r.id !== rowId; });
                await updateSheet(sheetId);
                await loadSheets();

                // Aggiorna il riferimento al foglio corrente
                state.currentSheet = findSheet(sheetId);

                render();

            } catch (error) {
                console.error('Errore eliminazione riga:', error);
                alert('‚ùå Errore nell\'eliminazione della riga');
            }
        }

        // Aggiorna cella
        async function updateCell(sheetId, rowId, columnId, value) {
            try {
                var sheet = findSheet(sheetId);
                if (!sheet) return;

                // Verifica permessi
                if (sheet.permission === 'view') {
                    alert('‚ö†Ô∏è Non hai i permessi per modificare questo foglio');
                    return;
                }

                var row = sheet.rows.find(function(r) { return r.id === rowId; });
                if (!row) return;

                row.data[columnId] = value;

                // Aggiorna in background senza alert
                await updateSheet(sheetId);
                await loadSheets();

                // Aggiorna il riferimento al foglio corrente
                state.currentSheet = findSheet(sheetId);

            } catch (error) {
                console.error('Errore aggiornamento cella:', error);
                alert('‚ùå Errore nell\'aggiornamento della cella');
            }
        }

        // Modal gestione
        function openNewSheetModal() {
            state.showNewSheetModal = true;
            render();
        }

        function closeNewSheetModal() {
            state.showNewSheetModal = false;
            render();
        }

        function openAddColumnModal() {
            state.showAddColumnModal = true;
            state.newColumn = { name: '', type: 'text', width: 150 };
            render();
        }

        function closeAddColumnModal() {
            state.showAddColumnModal = false;
            render();
        }

        function openEditColumnModal(sheetId, columnId) {
            var sheet = findSheet(sheetId);
            if (!sheet) return;

            var column = sheet.columns.find(function(c) { return c.id === columnId; });
            if (!column) return;

            state.showEditColumnModal = true;
            state.editingColumn = { sheetId: sheetId, columnId: columnId };
            state.newColumn = {
                name: column.name,
                type: column.type,
                width: column.width
            };
            render();
        }

        function closeEditColumnModal() {
            state.showEditColumnModal = false;
            state.editingColumn = null;
            render();
        }

        async function updateColumn() {
            try {
                if (!state.editingColumn) return;

                var sheet = findSheet(state.editingColumn.sheetId);
                if (!sheet) return;

                // Verifica permessi
                if (sheet.permission === 'view') {
                    alert('‚ö†Ô∏è Non hai i permessi per modificare questo foglio');
                    return;
                }

                var column = sheet.columns.find(function(c) { return c.id === state.editingColumn.columnId; });
                if (!column) return;

                if (!state.newColumn.name.trim()) {
                    alert('‚ö†Ô∏è Inserisci un nome per la colonna');
                    return;
                }

                // Aggiorna la colonna
                column.name = state.newColumn.name;
                column.type = state.newColumn.type;
                column.width = state.newColumn.width;

                await updateSheet(state.editingColumn.sheetId);
                await loadSheets();

                // Aggiorna il riferimento al foglio corrente
                state.currentSheet = findSheet(state.editingColumn.sheetId);

                closeEditColumnModal();
                render();

            } catch (error) {
                console.error('Errore aggiornamento colonna:', error);
                alert('‚ùå Errore nell\'aggiornamento della colonna');
            }
        }

        // Crea nuovo foglio dal modal
        async function handleCreateNewSheet() {
            var name = document.getElementById('newSheetName').value;
            var description = document.getElementById('newSheetDescription').value;

            var sheet = await createNewSheet(name, description);
            if (sheet) {
                await loadSheets();
                closeNewSheetModal();
                alert('‚úÖ Foglio "' + name + '" creato!');
                render();
            }
        }

        // ========== CONDIVISIONE FOGLI ==========

        // Carica lista utenti disponibili
        async function loadAvailableUsers() {
            try {
                // Cerca in user_profiles prima
                var { data, error } = await supabase
                    .from('user_profiles')
                    .select('id, email, full_name')
                    .neq('id', state.currentUser.id);

                if (error || !data || data.length === 0) {
                    // Fallback su auth.users
                    var authQuery = await supabase
                        .from('auth.users')
                        .select('id, email')
                        .neq('id', state.currentUser.id);

                    if (!authQuery.error) {
                        data = authQuery.data;
                    }
                }

                state.availableUsers = (data || []).map(function(user) {
                    return {
                        id: user.id,
                        email: user.email,
                        name: user.full_name || user.email
                    };
                });

                console.log('‚úÖ Caricati ' + state.availableUsers.length + ' utenti');

            } catch (error) {
                console.error('Errore caricamento utenti:', error);
                state.availableUsers = [];
            }
        }

        // Apri modal condivisione
        async function openShareModal(sheetId) {
            state.sharingSheet = sheetId;
            state.showShareModal = true;
            state.selectedUser = null;
            state.sharePermission = 'view';

            await loadAvailableUsers();
            render();
        }

        // Chiudi modal condivisione
        function closeShareModal() {
            state.showShareModal = false;
            state.sharingSheet = null;
            state.selectedUser = null;
            render();
        }

        // Condividi foglio con utente
        async function shareSheet() {
            try {
                if (!state.selectedUser) {
                    alert('‚ö†Ô∏è Seleziona un utente');
                    return;
                }

                if (!state.sharingSheet) return;

                // Verifica che il foglio sia del current user
                var sheet = state.sheets.find(function(s) { return s.id === state.sharingSheet; });
                if (!sheet) {
                    alert('‚ùå Puoi condividere solo i tuoi fogli');
                    return;
                }

                // Verifica che non sia gi√† condiviso con questo utente
                var existing = state.sheetShares[state.sharingSheet];
                if (existing && existing.find(function(s) { return s.user_id === state.selectedUser; })) {
                    alert('‚ö†Ô∏è Foglio gi√† condiviso con questo utente');
                    return;
                }

                var { error } = await supabase
                    .from('affiliate_sheet_shares')
                    .insert([{
                        sheet_id: state.sharingSheet,
                        owner_user_id: state.currentUser.id,
                        shared_with_user_id: state.selectedUser,
                        permission_level: state.sharePermission
                    }]);

                if (error) throw error;

                alert('‚úÖ Foglio condiviso con successo!');
                await loadSheets();
                closeShareModal();
                render();

            } catch (error) {
                console.error('Errore condivisione:', error);
                alert('‚ùå Errore nella condivisione del foglio: ' + error.message);
            }
        }

        // Rimuovi condivisione
        async function removeShare(shareId, userEmail) {
            if (!confirm('Rimuovere condivisione con ' + userEmail + '?')) return;

            try {
                var { error } = await supabase
                    .from('affiliate_sheet_shares')
                    .delete()
                    .eq('id', shareId);

                if (error) throw error;

                alert('‚úÖ Condivisione rimossa');
                await loadSheets();
                render();

            } catch (error) {
                console.error('Errore rimozione condivisione:', error);
                alert('‚ùå Errore nella rimozione della condivisione');
            }
        }

        // Aggiorna permesso condivisione
        async function updateSharePermission(shareId, newPermission) {
            try {
                var { error } = await supabase
                    .from('affiliate_sheet_shares')
                    .update({ permission_level: newPermission })
                    .eq('id', shareId);

                if (error) throw error;

                await loadSheets();
                render();

            } catch (error) {
                console.error('Errore aggiornamento permesso:', error);
                alert('‚ùå Errore nell\'aggiornamento del permesso');
            }
        }

        // ========== CONDIVISIONE TRACKER COMPLETO ==========

        // Switch tra i miei dati e dati condivisi
        async function switchTracker(userId) {
            try {
                console.log('üîÑ switchTracker() chiamato con userId:', userId);
                console.log('   Tracker condivisi disponibili:', state.sharedTrackers);

                if (userId) {
                    // Verifica che l'utente abbia condiviso il tracker con me
                    var sharedTracker = state.sharedTrackers.find(function(t) { return t.owner_id === userId; });
                    if (!sharedTracker) {
                        console.error('‚ùå Tracker non trovato nella lista:', userId);
                        alert('‚ùå Errore: tracker non trovato');
                        return;
                    }
                    console.log('‚úÖ Tracker trovato:', sharedTracker);
                    state.viewingTrackerId = userId;
                } else {
                    // Torna ai miei dati
                    console.log('üè† Ritorno ai miei dati');
                    state.viewingTrackerId = null;
                }

                console.log('üìå viewingTrackerId impostato a:', state.viewingTrackerId);

                // Ricarica tutti i dati con il nuovo user_id
                state.loading = true;
                render();

                console.log('üì• Caricamento dati per viewingTrackerId:', state.viewingTrackerId);

                await loadSocialCredentials();
                await loadOffersGoals();
                await loadSheets();
                await loadData();

                state.loading = false;
                render();

                console.log('‚úÖ Switch tracker completato');

            } catch (error) {
                console.error('‚ùå Errore switch tracker:', error);
                alert('‚ùå Errore nel cambio tracker: ' + error.message);
                state.viewingTrackerId = null;
                state.loading = false;
                render();
            }
        }

        // Apri modal condivisione tracker
        async function openShareTrackerModal() {
            state.showShareTrackerModal = true;
            state.selectedUser = null;
            state.sharePermission = 'view';

            await loadAvailableUsers();
            await loadTrackerShares(); // Ricarica le condivisioni esistenti
            render();
        }

        // Chiudi modal condivisione tracker
        function closeShareTrackerModal() {
            state.showShareTrackerModal = false;
            state.selectedUser = null;
            render();
        }

        // Condividi tracker con utente
        async function shareTracker() {
            try {
                if (!state.selectedUser) {
                    alert('‚ö†Ô∏è Seleziona un utente');
                    return;
                }

                // Verifica che non sia gi√† condiviso con questo utente
                if (state.trackerShares.find(function(s) { return s.user_id === state.selectedUser; })) {
                    alert('‚ö†Ô∏è Tracker gi√† condiviso con questo utente');
                    return;
                }

                var { error } = await supabase
                    .from('affiliate_tracker_shares')
                    .insert([{
                        owner_user_id: state.currentUser.id,
                        shared_with_user_id: state.selectedUser,
                        permission_level: state.sharePermission
                    }]);

                if (error) throw error;

                alert('‚úÖ Tracker condiviso con successo!');
                await loadTrackerShares();
                state.selectedUser = null;
                render();

            } catch (error) {
                console.error('Errore condivisione tracker:', error);

                // Gestisci errore di duplicato
                if (error.message && error.message.includes('duplicate key value violates unique constraint')) {
                    alert('‚ö†Ô∏è Tracker gi√† condiviso con questo utente. Ricarica la pagina per vedere le condivisioni aggiornate.');
                    // Ricarica le condivisioni
                    await loadTrackerShares();
                    render();
                } else {
                    alert('‚ùå Errore nella condivisione del tracker: ' + error.message);
                }
            }
        }

        // Rimuovi condivisione tracker
        async function removeTrackerShare(shareId) {
            if (!confirm('Rimuovere questa condivisione?')) return;

            try {
                var { error } = await supabase
                    .from('affiliate_tracker_shares')
                    .delete()
                    .eq('id', shareId);

                if (error) throw error;

                alert('‚úÖ Condivisione rimossa');
                await loadTrackerShares();
                render();

            } catch (error) {
                console.error('Errore rimozione condivisione:', error);
                alert('‚ùå Errore nella rimozione della condivisione: ' + error.message);
            }
        }

        // Export foglio in Excel
        function exportSheetToExcel(sheetId) {
            var sheet = findSheet(sheetId);
            if (!sheet) {
                alert('‚ö†Ô∏è Foglio non trovato');
                return;
            }

            if (!sheet.columns || sheet.columns.length === 0) {
                alert('‚ö†Ô∏è Il foglio non ha colonne da esportare');
                return;
            }

            try {
                var wb = XLSX.utils.book_new();

                // Prepara intestazioni
                var headers = sheet.columns.map(function(col) { return col.name; });

                // Prepara righe
                var rows = sheet.rows.map(function(row) {
                    return sheet.columns.map(function(col) {
                        return row.data[col.id] || '';
                    });
                });

                // Combina headers + rows
                var wsData = [headers].concat(rows);
                var ws = XLSX.utils.aoa_to_sheet(wsData);

                XLSX.utils.book_append_sheet(wb, ws, 'Dati');

                // Genera e scarica
                var filename = 'Foglio_' + sheet.name.replace(/[^a-z0-9]/gi, '_') + '.xlsx';
                XLSX.writeFile(wb, filename);

                console.log('‚úÖ Foglio esportato:', filename);

            } catch (error) {
                console.error('Errore export foglio:', error);
                alert('‚ùå Errore nell\'esportazione del foglio');
            }
        }

        // Calcola somma colonna
        function calculateColumnSum(sheet, columnId) {
            var sum = 0;
            var column = sheet.columns.find(function(c) { return c.id === columnId; });

            if (!column || column.type !== 'number') return '-';

            sheet.rows.forEach(function(row) {
                var value = parseFloat(row.data[columnId]);
                if (!isNaN(value)) sum += value;
            });

            return sum.toFixed(2);
        }

        // Calcola media colonna
        function calculateColumnAvg(sheet, columnId) {
            var sum = 0;
            var count = 0;
            var column = sheet.columns.find(function(c) { return c.id === columnId; });

            if (!column || column.type !== 'number') return '-';

            sheet.rows.forEach(function(row) {
                var value = parseFloat(row.data[columnId]);
                if (!isNaN(value)) {
                    sum += value;
                    count++;
                }
            });

            return count > 0 ? (sum / count).toFixed(2) : '0';
        }
        // Rendering della tab Fogli Sheet Spreadsheet
        function renderSheets() {
            var html = '';

            // Se non c'√® un foglio aperto, mostra la lista
            if (!state.currentSheet) {
                html += '<div class="card">';
                html += '<div class="card-title">';
                html += '<span>üìÑ Fogli Spreadsheet</span>';
                html += '<button onclick="openNewSheetModal()" class="btn-primary">‚ûï Nuovo Foglio</button>';
                html += '</div>';

                if (state.sheets.length === 0) {
                    html += '<div class="empty-state">';
                    html += '<div class="empty-state-icon">üìä</div>';
                    html += '<p>Nessun foglio creato</p>';
                    html += '<p style="font-size: 0.875rem; margin-top: 8px;">Crea un nuovo foglio per iniziare ad inserire i tuoi dati</p>';
                    html += '</div>';
                } else {
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin-top: 20px;">';

                    state.sheets.forEach(function(sheet) {
                        var colCount = sheet.columns ? sheet.columns.length : 0;
                        var rowCount = sheet.rows ? sheet.rows.length : 0;

                        html += '<div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;" onclick="openSheet(\'' + sheet.id + '\')" onmouseover="this.style.transform=\'translateY(-4px)\'; this.style.borderColor=\'rgba(59, 130, 246, 0.5)\';" onmouseout="this.style.transform=\'translateY(0)\'; this.style.borderColor=\'rgba(255, 255, 255, 0.1)\';">';
                        html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">';
                        html += '<h3 style="font-size: 1.125rem; font-weight: bold; color: white;">üìä ' + sheet.name + '</h3>';
                        html += '<button onclick="event.stopPropagation(); deleteSheet(\'' + sheet.id + '\', \'' + sheet.name.replace(/'/g, "\\'") + '\')" style="background: rgba(239, 68, 68, 0.2); border: none; color: #ef4444; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">üóëÔ∏è</button>';
                        html += '</div>';

                        if (sheet.description) {
                            html += '<p style="color: #9ca3af; font-size: 0.875rem; margin-bottom: 12px;">' + sheet.description + '</p>';
                        }

                        html += '<div style="display: flex; gap: 16px; color: #9ca3af; font-size: 0.875rem; margin-bottom: 12px;">';
                        html += '<span>üìã ' + colCount + ' colonne</span>';
                        html += '<span>üìä ' + rowCount + ' righe</span>';
                        html += '</div>';

                        html += '<div style="font-size: 0.75rem; color: #6b7280;">';
                        html += 'Creato il ' + new Date(sheet.created_at).toLocaleDateString('it-IT');
                        html += '</div>';

                        // Condivisioni
                        var shares = state.sheetShares[sheet.id] || [];
                        if (shares.length > 0) {
                            html += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.1);">';
                            html += '<div style="font-size: 0.75rem; color: #9ca3af; margin-bottom: 8px;">üë• Condiviso con:</div>';
                            shares.forEach(function(share) {
                                html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 0.75rem;">';
                                html += '<span style="color: #d1d5db;">' + share.user_email + '</span>';
                                html += '<div style="display: flex; gap: 4px; align-items: center;">';
                                html += '<select onchange="updateSharePermission(\'' + share.id + '\', this.value)" style="padding: 2px 4px; font-size: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 4px;">';
                                html += '<option value="view" ' + (share.permission === 'view' ? 'selected' : '') + '>üëÅÔ∏è Vista</option>';
                                html += '<option value="edit" ' + (share.permission === 'edit' ? 'selected' : '') + '>‚úèÔ∏è Modifica</option>';
                                html += '</select>';
                                html += '<button onclick="removeShare(\'' + share.id + '\', \'' + share.user_email + '\')" style="background: rgba(239, 68, 68, 0.2); border: none; color: #ef4444; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">‚úï</button>';
                                html += '</div>';
                                html += '</div>';
                            });
                            html += '</div>';
                        }

                        html += '<div style="display: flex; gap: 8px; margin-top: 16px;" onclick="event.stopPropagation();">';
                        html += '<button onclick="openSheet(\'' + sheet.id + '\')" class="btn-primary" style="flex: 1; padding: 8px; font-size: 0.875rem;">üìÇ Apri</button>';
                        html += '<button onclick="openShareModal(\'' + sheet.id + '\')" class="btn-secondary" style="padding: 8px 12px; font-size: 0.875rem;">üë•</button>';
                        html += '<button onclick="exportSheetToExcel(\'' + sheet.id + '\')" class="btn-secondary" style="padding: 8px 12px; font-size: 0.875rem;">üì•</button>';
                        html += '</div>';

                        html += '</div>';
                    });

                    html += '</div>';
                }

                html += '</div>';

                // Sezione fogli condivisi con me
                if (state.sharedSheets.length > 0) {
                    html += '<div class="card" style="margin-top: 30px;">';
                    html += '<div class="card-title">';
                    html += '<span>üë• Fogli Condivisi con Me</span>';
                    html += '</div>';

                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin-top: 20px;">';

                    state.sharedSheets.forEach(function(sheet) {
                        var colCount = sheet.columns ? sheet.columns.length : 0;
                        var rowCount = sheet.rows ? sheet.rows.length : 0;
                        var isReadOnly = sheet.permission === 'view';

                        html += '<div style="background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;" onclick="openSheet(\'' + sheet.id + '\')" onmouseover="this.style.transform=\'translateY(-4px)\'; this.style.borderColor=\'rgba(139, 92, 246, 0.5)\';" onmouseout="this.style.transform=\'translateY(0)\'; this.style.borderColor=\'rgba(139, 92, 246, 0.2)\';">';
                        html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">';
                        html += '<h3 style="font-size: 1.125rem; font-weight: bold; color: white;">üìä ' + sheet.name + '</h3>';
                        html += '<span style="background: rgba(139, 92, 246, 0.3); color: #c4b5fd; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem;">' + (isReadOnly ? 'üëÅÔ∏è Vista' : '‚úèÔ∏è Modifica') + '</span>';
                        html += '</div>';

                        if (sheet.description) {
                            html += '<p style="color: #9ca3af; font-size: 0.875rem; margin-bottom: 12px;">' + sheet.description + '</p>';
                        }

                        html += '<div style="display: flex; gap: 16px; color: #9ca3af; font-size: 0.875rem; margin-bottom: 12px;">';
                        html += '<span>üìã ' + colCount + ' colonne</span>';
                        html += '<span>üìä ' + rowCount + ' righe</span>';
                        html += '</div>';

                        html += '<div style="font-size: 0.75rem; color: #9ca3af; margin-bottom: 8px;">';
                        html += 'üë§ Condiviso da: ' + sheet.shared_by;
                        html += '</div>';

                        html += '<div style="display: flex; gap: 8px; margin-top: 16px;" onclick="event.stopPropagation();">';
                        html += '<button onclick="openSheet(\'' + sheet.id + '\')" class="btn-primary" style="flex: 1; padding: 8px; font-size: 0.875rem;">üìÇ Apri</button>';
                        if (!isReadOnly) {
                            html += '<button onclick="exportSheetToExcel(\'' + sheet.id + '\')" class="btn-secondary" style="padding: 8px 12px; font-size: 0.875rem;">üì•</button>';
                        }
                        html += '</div>';

                        html += '</div>';
                    });

                    html += '</div>';
                    html += '</div>';
                }
            } else {
                // Vista foglio aperto con griglia editabile
                var sheet = state.currentSheet;

                html += '<div class="card">';
                html += '<div class="card-title">';
                html += '<div style="display: flex; align-items: center; gap: 16px;">';
                html += '<button onclick="closeSheet()" class="btn-secondary">‚Üê Torna ai Fogli</button>';
                html += '<h2 style="margin: 0;">üìä ' + sheet.name + '</h2>';
                html += '</div>';
                html += '<div style="display: flex; gap: 12px;">';
                html += '<button onclick="openAddColumnModal()" class="btn-primary">‚ûï Colonna</button>';
                html += '<button onclick="addRow(\'' + sheet.id + '\')" class="btn-primary">‚ûï Riga</button>';
                html += '<button onclick="exportSheetToExcel(\'' + sheet.id + '\')" class="btn-success">üì• Esporta Excel</button>';
                html += '</div>';
                html += '</div>';

                if (sheet.description) {
                    html += '<p style="color: #9ca3af; margin-bottom: 20px;">' + sheet.description + '</p>';
                }

                // Griglia spreadsheet
                if (!sheet.columns || sheet.columns.length === 0) {
                    html += '<div class="empty-state">';
                    html += '<div class="empty-state-icon">üìã</div>';
                    html += '<p>Nessuna colonna definita</p>';
                    html += '<p style="font-size: 0.875rem; margin-top: 8px;">Aggiungi una colonna per iniziare</p>';
                    html += '</div>';
                } else {
                    html += '<div style="overflow-x: auto; background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 16px;">';
                    html += '<table style="width: 100%; border-collapse: collapse; min-width: 600px;">';

                    // Header
                    html += '<thead>';
                    html += '<tr>';
                    html += '<th style="background: rgba(59, 130, 246, 0.1); padding: 12px; text-align: left; border: 1px solid rgba(255, 255, 255, 0.1); font-weight: bold; color: #60a5fa; position: sticky; top: 0; width: 50px;">#</th>';

                    sheet.columns.forEach(function(col) {
                        html += '<th style="background: rgba(59, 130, 246, 0.1); padding: 12px; text-align: left; border: 1px solid rgba(255, 255, 255, 0.1); font-weight: bold; color: white; position: sticky; top: 0; min-width: ' + col.width + 'px;">';
                        html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
                        html += '<span>' + col.name + '</span>';
                        html += '<div style="display: flex; gap: 4px;">';
                        html += '<span style="background: rgba(139, 92, 246, 0.3); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; color: #c4b5fd;">' + col.type + '</span>';
                        html += '<button onclick="openEditColumnModal(\'' + sheet.id + '\', \'' + col.id + '\')" style="background: rgba(59, 130, 246, 0.2); border: none; color: #60a5fa; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;" title="Modifica colonna">‚úèÔ∏è</button>';
                        html += '<button onclick="deleteColumn(\'' + sheet.id + '\', \'' + col.id + '\')" style="background: rgba(239, 68, 68, 0.2); border: none; color: #ef4444; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;" title="Elimina colonna">‚úï</button>';
                        html += '</div>';
                        html += '</div>';
                        html += '</th>';
                    });

                    html += '<th style="background: rgba(59, 130, 246, 0.1); padding: 12px; border: 1px solid rgba(255, 255, 255, 0.1); position: sticky; top: 0; width: 60px;">Azioni</th>';
                    html += '</tr>';
                    html += '</thead>';

                    // Body con righe
                    html += '<tbody>';

                    if (!sheet.rows || sheet.rows.length === 0) {
                        html += '<tr>';
                        html += '<td colspan="' + (sheet.columns.length + 2) + '" style="padding: 40px; text-align: center; color: #9ca3af;">Nessuna riga. Clicca "‚ûï Riga" per aggiungere dati.</td>';
                        html += '</tr>';
                    } else {
                        sheet.rows.forEach(function(row, index) {
                            html += '<tr style="background: ' + (index % 2 === 0 ? 'rgba(255,255,255,0.02)' : 'transparent') + ';">';
                            html += '<td style="padding: 8px; border: 1px solid rgba(255, 255, 255, 0.05); color: #9ca3af; font-size: 0.875rem;">' + (index + 1) + '</td>';

                            sheet.columns.forEach(function(col) {
                                var value = row.data[col.id] || '';
                                var inputType = col.type === 'number' ? 'number' : (col.type === 'date' ? 'date' : 'text');

                                html += '<td style="padding: 0; border: 1px solid rgba(255, 255, 255, 0.05);">';
                                html += '<input type="' + inputType + '" value="' + value + '" ';
                                html += 'onchange="updateCell(\'' + sheet.id + '\', \'' + row.id + '\', \'' + col.id + '\', this.value)" ';
                                html += 'style="width: 100%; padding: 8px; background: transparent; border: none; color: white; font-size: 0.875rem; outline: none;" ';
                                html += 'placeholder="Inserisci...">';
                                html += '</td>';
                            });

                            html += '<td style="padding: 8px; border: 1px solid rgba(255, 255, 255, 0.05); text-align: center;">';
                            html += '<button onclick="deleteRow(\'' + sheet.id + '\', \'' + row.id + '\')" style="background: rgba(239, 68, 68, 0.2); border: none; color: #ef4444; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">üóëÔ∏è</button>';
                            html += '</td>';

                            html += '</tr>';
                        });
                    }

                    html += '</tbody>';
                    html += '</table>';
                    html += '</div>';

                    // Statistiche
                    if (sheet.rows && sheet.rows.length > 0) {
                        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 20px;">';

                        html += '<div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 12px;">';
                        html += '<div style="font-size: 0.75rem; color: #9ca3af; margin-bottom: 4px;">Totale Righe</div>';
                        html += '<div style="font-size: 1.5rem; font-weight: bold; color: #60a5fa;">' + sheet.rows.length + '</div>';
                        html += '</div>';

                        html += '<div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 12px;">';
                        html += '<div style="font-size: 0.75rem; color: #9ca3af; margin-bottom: 4px;">Totale Colonne</div>';
                        html += '<div style="font-size: 1.5rem; font-weight: bold; color: #a78bfa;">' + sheet.columns.length + '</div>';
                        html += '</div>';

                        html += '</div>';
                    }
                }

                html += '</div>';
            }

            // Modal nuovo foglio
            if (state.showNewSheetModal) {
                html += '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000;">';
                html += '<div style="background: #334155; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 24px; max-width: 500px; width: 90%;">';
                html += '<h2 style="margin-bottom: 20px;">‚ûï Nuovo Foglio Spreadsheet</h2>';

                html += '<div style="display: flex; flex-direction: column; gap: 16px;">';

                html += '<div>';
                html += '<label style="display: block; color: #9ca3af; font-size: 0.875rem; font-weight: 600; margin-bottom: 8px;">Nome Foglio</label>';
                html += '<input type="text" id="newSheetName" placeholder="Es: Budget 2025" style="width: 100%;">';
                html += '</div>';

                html += '<div>';
                html += '<label style="display: block; color: #9ca3af; font-size: 0.875rem; font-weight: 600; margin-bottom: 8px;">Descrizione (opzionale)</label>';
                html += '<input type="text" id="newSheetDescription" placeholder="Es: Tracking budget mensile" style="width: 100%;">';
                html += '</div>';

                html += '</div>';

                html += '<div style="display: flex; gap: 12px; margin-top: 24px;">';
                html += '<button onclick="handleCreateNewSheet()" class="btn-primary" style="flex: 1;">üíæ Crea Foglio</button>';
                html += '<button onclick="closeNewSheetModal()" class="btn-secondary" style="flex: 1;">‚ùå Annulla</button>';
                html += '</div>';

                html += '</div></div>';
            }

            // Modal aggiungi colonna
            if (state.showAddColumnModal) {
                html += '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000;">';
                html += '<div style="background: #334155; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 24px; max-width: 500px; width: 90%;">';
                html += '<h2 style="margin-bottom: 20px;">‚ûï Nuova Colonna</h2>';

                html += '<div style="display: flex; flex-direction: column; gap: 16px;">';

                html += '<div>';
                html += '<label style="display: block; color: #9ca3af; font-size: 0.875rem; font-weight: 600; margin-bottom: 8px;">Nome Colonna</label>';
                html += '<input type="text" value="' + state.newColumn.name + '" onchange="state.newColumn.name = this.value" placeholder="Es: Cliente, Budget, Data..." style="width: 100%;">';
                html += '</div>';

                html += '<div>';
                html += '<label style="display: block; color: #9ca3af; font-size: 0.875rem; font-weight: 600; margin-bottom: 8px;">Tipo Dati</label>';
                html += '<select onchange="state.newColumn.type = this.value" style="width: 100%;">';
                html += '<option value="text" ' + (state.newColumn.type === 'text' ? 'selected' : '') + '>Testo</option>';
                html += '<option value="number" ' + (state.newColumn.type === 'number' ? 'selected' : '') + '>Numero</option>';
                html += '<option value="date" ' + (state.newColumn.type === 'date' ? 'selected' : '') + '>Data</option>';
                html += '</select>';
                html += '</div>';

                html += '</div>';

                html += '<div style="display: flex; gap: 12px; margin-top: 24px;">';
                html += '<button onclick="addColumn(\'' + state.currentSheet.id + '\')" class="btn-primary" style="flex: 1;">üíæ Aggiungi</button>';
                html += '<button onclick="closeAddColumnModal()" class="btn-secondary" style="flex: 1;">‚ùå Annulla</button>';
                html += '</div>';

                html += '</div></div>';
            }

            // Modal modifica colonna
            if (state.showEditColumnModal && state.editingColumn) {
                html += '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000;">';
                html += '<div style="background: #334155; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 24px; max-width: 500px; width: 90%;">';
                html += '<h2 style="margin-bottom: 20px;">‚úèÔ∏è Modifica Colonna</h2>';

                html += '<div style="display: flex; flex-direction: column; gap: 16px;">';

                html += '<div>';
                html += '<label style="display: block; color: #9ca3af; font-size: 0.875rem; font-weight: 600; margin-bottom: 8px;">Nome Colonna</label>';
                html += '<input type="text" value="' + state.newColumn.name + '" onchange="state.newColumn.name = this.value" placeholder="Es: Cliente, Budget, Data..." style="width: 100%;">';
                html += '</div>';

                html += '<div>';
                html += '<label style="display: block; color: #9ca3af; font-size: 0.875rem; font-weight: 600; margin-bottom: 8px;">Tipo Dati</label>';
                html += '<select onchange="state.newColumn.type = this.value" style="width: 100%;">';
                html += '<option value="text" ' + (state.newColumn.type === 'text' ? 'selected' : '') + '>Testo</option>';
                html += '<option value="number" ' + (state.newColumn.type === 'number' ? 'selected' : '') + '>Numero</option>';
                html += '<option value="date" ' + (state.newColumn.type === 'date' ? 'selected' : '') + '>Data</option>';
                html += '</select>';
                html += '</div>';

                html += '</div>';

                html += '<div style="display: flex; gap: 12px; margin-top: 24px;">';
                html += '<button onclick="updateColumn()" class="btn-primary" style="flex: 1;">üíæ Salva Modifiche</button>';
                html += '<button onclick="closeEditColumnModal()" class="btn-secondary" style="flex: 1;">‚ùå Annulla</button>';
                html += '</div>';

                html += '</div></div>';
            }

            // Modal condivisione
            if (state.showShareModal && state.sharingSheet) {
                html += '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000;">';
                html += '<div style="background: #334155; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 24px; max-width: 500px; width: 90%;">';
                html += '<h2 style="margin-bottom: 20px;">üë• Condividi Foglio</h2>';

                html += '<div style="display: flex; flex-direction: column; gap: 16px;">';

                // Selezione utente
                html += '<div>';
                html += '<label style="display: block; color: #9ca3af; font-size: 0.875rem; font-weight: 600; margin-bottom: 8px;">Seleziona Utente</label>';
                html += '<select onchange="state.selectedUser = this.value; render();" style="width: 100%;">';
                html += '<option value="">-- Seleziona un utente --</option>';
                state.availableUsers.forEach(function(user) {
                    html += '<option value="' + user.id + '" ' + (state.selectedUser === user.id ? 'selected' : '') + '>' + user.name + ' (' + user.email + ')</option>';
                });
                html += '</select>';
                html += '</div>';

                // Selezione permesso
                html += '<div>';
                html += '<label style="display: block; color: #9ca3af; font-size: 0.875rem; font-weight: 600; margin-bottom: 8px;">Permesso</label>';
                html += '<select onchange="state.sharePermission = this.value" style="width: 100%;">';
                html += '<option value="view" ' + (state.sharePermission === 'view' ? 'selected' : '') + '>üëÅÔ∏è Solo Visualizzazione</option>';
                html += '<option value="edit" ' + (state.sharePermission === 'edit' ? 'selected' : '') + '>‚úèÔ∏è Modifica</option>';
                html += '</select>';
                html += '<p style="font-size: 0.75rem; color: #9ca3af; margin-top: 4px;">';
                html += state.sharePermission === 'view' ? 'L\'utente potr√† solo visualizzare il foglio' : 'L\'utente potr√† modificare righe e celle';
                html += '</p>';
                html += '</div>';

                // Lista condivisioni esistenti
                var existingShares = state.sheetShares[state.sharingSheet] || [];
                if (existingShares.length > 0) {
                    html += '<div style="padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">';
                    html += '<div style="font-size: 0.875rem; color: #9ca3af; margin-bottom: 8px; font-weight: 600;">Gi√† condiviso con:</div>';
                    existingShares.forEach(function(share) {
                        html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; margin-bottom: 4px;">';
                        html += '<span style="font-size: 0.875rem;">' + share.user_email + '</span>';
                        html += '<span style="font-size: 0.75rem; color: #9ca3af;">' + (share.permission === 'view' ? 'üëÅÔ∏è Vista' : '‚úèÔ∏è Modifica') + '</span>';
                        html += '</div>';
                    });
                    html += '</div>';
                }

                html += '</div>';

                html += '<div style="display: flex; gap: 12px; margin-top: 24px;">';
                html += '<button onclick="shareSheet()" class="btn-primary" style="flex: 1;">üë• Condividi</button>';
                html += '<button onclick="closeShareModal()" class="btn-secondary" style="flex: 1;">‚ùå Annulla</button>';
                html += '</div>';

                html += '</div></div>';
            }

            return html;
        }
        // ========== EXPORT TO EXCEL ==========
        function exportCampaignsToExcel() {
            if (!state.campaignsData || state.campaignsData.length === 0) {
                alert('‚ö†Ô∏è Nessuna campagna da esportare');
                return;
            }

            // Prepara dati per export
            var exportData = state.campaignsData.map(function(c) {
                return {
                    'Piattaforma': (c.platform || 'meta').toUpperCase(),
                    'Account': c.accountName,
                    'Nome Campagna': c.name,
                    'Spesa': parseFloat(c.spend || 0).toFixed(2),
                    'Impressioni': c.impressions || 0,
                    'Click': c.clicks || 0,
                    'Acquisti': c.purchases || 0,
                    'Costo per Acquisto': parseFloat(c.costPerPurchase || 0).toFixed(2),
                    'CPM': parseFloat(c.cpm || 0).toFixed(2),
                    'CTR %': parseFloat(c.ctr || 0).toFixed(2),
                    'Stato': c.statusLabel || c.status || 'N/A'
                };
            });

            // Crea workbook e worksheet
            var wb = XLSX.utils.book_new();
            var ws = XLSX.utils.json_to_sheet(exportData);

            // Aggiungi worksheet al workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Campagne');

            // Export
            var filename = 'Campagne_' + state.dateFrom + '_' + state.dateTo + '.xlsx';
            XLSX.writeFile(wb, filename);

            console.log('‚úÖ Exported:', filename);
        }

        function exportOffersToExcel() {
            if (!state.matchedData || state.matchedData.length === 0) {
                alert('‚ö†Ô∏è Nessuna offerta da esportare');
                return;
            }

            // Prepara dati per export
            var exportData = state.matchedData.map(function(o) {
                // CPA Goal: priorit√† al goal personalizzato, altrimenti usa CPA dall'API
                var cpaGoal = 0;
                if (state.offersGoals[o.offerId]) {
                    cpaGoal = state.offersGoals[o.offerId];
                } else {
                    var refOffer = state.offersReference[o.offerId];
                    if (refOffer && refOffer.payout) {
                        cpaGoal = refOffer.payout;
                    }
                }

                var cpaReale = 0;
                if (o.approved > 0) {
                    cpaReale = o.totalSpend / o.approved;
                }

                var cpaPagata = 0;
                if (o.approved > 0) {
                    cpaPagata = o.revenue / o.approved;
                }

                return {
                    'ID Offerta': o.offerId,
                    'Nome Offerta': o.offerName,
                    'Spesa ADV': parseFloat(o.totalSpend || 0).toFixed(2),
                    'Acquisti ADV': o.totalPurchases || 0,
                    'Approvate': o.approved || 0,
                    'Pending': o.pending || 0,
                    'Annullate': o.cancelled || 0,
                    'Doppie': o.doubleLead || 0,
                    'Trash': o.trash || 0,
                    'CPA Goal': cpaGoal.toFixed(2),
                    'CPA Reale': cpaReale.toFixed(2),
                    'CPA Pagata': cpaPagata.toFixed(2),
                    'Revenue': parseFloat(o.revenue || 0).toFixed(2),
                    'Profit': parseFloat(o.profit || 0).toFixed(2),
                    'ROI %': parseFloat(o.roi || 0).toFixed(2),
                    'ROAS': parseFloat(o.roas || 0).toFixed(2)
                };
            });

            var wb = XLSX.utils.book_new();
            var ws = XLSX.utils.json_to_sheet(exportData);
            XLSX.utils.book_append_sheet(wb, ws, 'Offerte');

            var filename = 'Offerte_' + state.dateFrom + '_' + state.dateTo + '.xlsx';
            XLSX.writeFile(wb, filename);

            console.log('‚úÖ Exported:', filename);
        }

        // ========== EXPORT TO CSV ==========
        function exportCampaignsToCSV() {
            if (!state.campaignsData || state.campaignsData.length === 0) {
                alert('‚ö†Ô∏è Nessuna campagna da esportare');
                return;
            }

            var csv = 'Piattaforma,Account,Nome Campagna,Spesa,Impressioni,Click,Acquisti,Costo per Acquisto,CPM,CTR %,Stato\n';

            state.campaignsData.forEach(function(c) {
                csv += [
                    (c.platform || 'meta').toUpperCase(),
                    c.accountName,
                    '"' + (c.name || '').replace(/"/g, '""') + '"',
                    parseFloat(c.spend || 0).toFixed(2),
                    c.impressions || 0,
                    c.clicks || 0,
                    c.purchases || 0,
                    parseFloat(c.costPerPurchase || 0).toFixed(2),
                    parseFloat(c.cpm || 0).toFixed(2),
                    parseFloat(c.ctr || 0).toFixed(2),
                    c.statusLabel || c.status || 'N/A'
                ].join(',') + '\n';
            });

            downloadCSV(csv, 'Campagne_' + state.dateFrom + '_' + state.dateTo + '.csv');
        }

        function exportOffersToCSV() {
            if (!state.matchedData || state.matchedData.length === 0) {
                alert('‚ö†Ô∏è Nessuna offerta da esportare');
                return;
            }

            var csv = 'ID Offerta,Nome Offerta,Spesa ADV,Acquisti ADV,Approvate,Pending,Annullate,Doppie,Trash,CPA Goal,CPA Reale,CPA Pagata,Revenue,Profit,ROI %,ROAS\n';

            state.matchedData.forEach(function(o) {
                // CPA Goal: priorit√† al goal personalizzato, altrimenti usa CPA dall'API
                var cpaGoal = 0;
                if (state.offersGoals[o.offerId]) {
                    cpaGoal = state.offersGoals[o.offerId];
                } else {
                    var refOffer = state.offersReference[o.offerId];
                    if (refOffer && refOffer.payout) {
                        cpaGoal = refOffer.payout;
                    }
                }

                var cpaReale = 0;
                if (o.approved > 0) {
                    cpaReale = o.totalSpend / o.approved;
                }

                var cpaPagata = 0;
                if (o.approved > 0) {
                    cpaPagata = o.revenue / o.approved;
                }

                csv += [
                    o.offerId,
                    '"' + (o.offerName || '').replace(/"/g, '""') + '"',
                    parseFloat(o.totalSpend || 0).toFixed(2),
                    o.totalPurchases || 0,
                    o.approved || 0,
                    o.pending || 0,
                    o.cancelled || 0,
                    o.doubleLead || 0,
                    o.trash || 0,
                    cpaGoal.toFixed(2),
                    cpaReale.toFixed(2),
                    cpaPagata.toFixed(2),
                    parseFloat(o.revenue || 0).toFixed(2),
                    parseFloat(o.profit || 0).toFixed(2),
                    parseFloat(o.roi || 0).toFixed(2),
                    parseFloat(o.roas || 0).toFixed(2)
                ].join(',') + '\n';
            });

            downloadCSV(csv, 'Offerte_' + state.dateFrom + '_' + state.dateTo + '.csv');
        }

        function downloadCSV(content, filename) {
            var blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            var url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            console.log('‚úÖ CSV Downloaded:', filename);
        }

        // ========== START ==========
        init();
    </script>
</body>
</html>
